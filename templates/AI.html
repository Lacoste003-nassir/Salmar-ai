<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Salmar â€¢ Main AI Core</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet" />

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'ui-sans-serif', 'system-ui'] },
          colors: {
            cosmic: {
              900: '#0b0a1a',
              800: '#120f2b',
              700: '#1b1540',
              600: '#2a1e5c',
              500: '#3b247d',
              400: '#5e39ad',
              300: '#8d6af2',
              200: '#bba8ff',
              100: '#e3ddff',
            },
            neon: {
              violet: '#a45cff',
              magenta: '#ff2bd6',
              fuchsia: '#ff4edb',
              lavender: '#c8b5ff',
              glow: '#b57bff'
            },
            mode: {
              knowledge: '#2da3ff',
              creative: '#ff4edb',
              business: '#ffbd2e',
              security: '#23d18b'
            }
          },
          boxShadow: {
            glass: '0 8px 30px rgba(164,92,255,0.25)',
            'violet-soft': '0 0 0 1px rgba(164,92,255,0.35), 0 10px 25px rgba(164,92,255,0.25)',
            'lavender': '0 10px 30px rgba(200,181,255,0.25)',
            'emerald': '0 10px 30px rgba(35,209,139,0.25)',
          },
          backdropBlur: {
            xs: '2px',
          },
          keyframes: {
            float: { '0%,100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-6px)' } },
            pulseRing: { '0%': { transform: 'scale(0.8)', opacity: 0.7 }, '80%': { transform: 'scale(2.4)', opacity: 0 }, '100%': { opacity: 0 } },
            spinSlow: { '0%': { transform: 'rotate(0)' }, '100%': { transform: 'rotate(360deg)' } },
            glow: { '0%,100%': { filter: 'brightness(1)' }, '50%': { filter: 'brightness(1.3)' } },
            sparkle: { '0%, 100%': { opacity: .25 }, '50%': { opacity: .8 } },
          },
          animation: {
            float: 'float 6s ease-in-out infinite',
            pulseRing: 'pulseRing 2.5s ease-out infinite',
            spinSlow: 'spinSlow 24s linear infinite',
            glow: 'glow 5s ease-in-out infinite',
            sparkle: 'sparkle 4s ease-in-out infinite',
          }
        }
      }
    }
  </script>

  <!-- GSAP -->
  <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js"></script>
  <!-- Tippy -->
  <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/themes/light.css" />
  <script src="https://unpkg.com/@popperjs/core@2"></script>
  <script src="https://unpkg.com/tippy.js@6"></script>
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@0.469.0/dist/umd/lucide.js"></script>

  <style>
    :root {
      --bg-start: #0b0a1a; /* deep indigo */
      --bg-mid: #1b1540;   /* violet */
      --bg-end: #0e0a24;   /* midnight purple */
      --glass: rgba(255,255,255,0.06);
      --glass-strong: rgba(255,255,255,0.12);
      --text: #e7e2ff;
      --muted: #bba8ff;
      --border: rgba(164,92,255,0.35);
      --glow: #a45cff; /* neon violet */
      --focus: #b57bff;
      --card: rgba(18, 15, 43, 0.6);
      --card-strong: rgba(18, 15, 43, 0.9);
      --noise: rgba(255, 255, 255, 0.02);
    }
    .theme-light {
      --bg-start: #f5f2ff;
      --bg-mid: #efe9ff;
      --bg-end: #f8f7ff;
      --glass: rgba(0, 0, 0, 0.05);
      --glass-strong: rgba(0, 0, 0, 0.08);
      --text: #1a1033;
      --muted: #4b3b7d;
      --border: rgba(110, 64, 183, 0.35);
      --glow: #7e3af2;
      --focus: #6d28d9;
      --card: rgba(255,255,255,0.7);
      --card-strong: rgba(255,255,255,0.95);
      --noise: rgba(0,0,0,0.03);
    }

    html, body {
      height: 100%;
      background: radial-gradient(1200px 800px at 10% 10%, rgba(164, 92, 255, 0.06), transparent 60%),
                  linear-gradient(140deg, var(--bg-start), var(--bg-mid), var(--bg-end));
      color: var(--text);
    }
    /* Subtle noise overlay */
    .noise-overlay::before {
      content: '';
      position: fixed;
      inset: 0;
      pointer-events: none;
      background-image:
        radial-gradient(2px 2px at 20% 30%, var(--noise), transparent 40%),
        radial-gradient(2px 2px at 80% 10%, var(--noise), transparent 40%),
        radial-gradient(2px 2px at 50% 70%, var(--noise), transparent 40%),
        radial-gradient(1px 1px at 10% 90%, var(--noise), transparent 40%);
      mix-blend-mode: soft-light;
      z-index: 0;
      animation: sparkle 10s ease-in-out infinite;
    }
    /* Glass utilities */
    .glass {
      background: var(--glass);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid var(--border);
      box-shadow: 0 10px 30px rgba(164, 92, 255, 0.18);
    }
    .glass-strong {
      background: var(--card);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid var(--border);
      box-shadow: 0 18px 50px rgba(164, 92, 255, 0.25);
    }
    .neumorphic {
      box-shadow:
        10px 10px 20px rgba(10, 6, 28, 0.65),
        -10px -10px 20px rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255,255,255,0.03);
    }
    .btn {
      transition: transform .2s ease, box-shadow .2s ease, background-color .2s ease, border-color .2s ease;
    }
    .btn:focus-visible { outline: 2px solid var(--focus); outline-offset: 2px; }
    .btn:hover { transform: translateY(-1px); }
    .btn:active { transform: translateY(0); }

    .glow-border {
      box-shadow: 0 0 0 1px var(--border), 0 0 22px rgba(164, 92, 255, 0.25);
    }
    .focus-glow:focus-within {
      box-shadow: 0 0 0 2px var(--glow), 0 0 26px rgba(164,92,255,.4);
    }

    /* Chat bubbles alignment */
    .message-user { justify-content: flex-end; }
    .message-salmar { justify-content: flex-start; }

    /* Scrollbars */
    *::-webkit-scrollbar { width: 10px; height: 10px; }
    *::-webkit-scrollbar-thumb { background: rgba(164,92,255,0.35); border-radius: 10px; }
    *::-webkit-scrollbar-track { background: transparent; }

    /* Accessibility helpers */
    .sr-only-focusable:focus {
      position: static !important;
      width: auto !important;
      height: auto !important;
      clip: auto !important;
    }

    /* Lock copy */
    .no-copy, .no-copy * { user-select: none; }

    /* Orb canvas */
    #orbCanvas { filter: drop-shadow(0 0 20px rgba(164,92,255,0.6)) drop-shadow(0 0 40px rgba(255,46,214,0.25)); }

    /* Radial actions layout */
    .radial { position: fixed; right: 20px; bottom: 24px; z-index: 50; }
    .radial-item { position: absolute; opacity: 0; transform: translate(0,0) scale(.8); }
    .radial-open .radial-item { opacity: 1; transform: scale(1); }

    /* Dropdown menu base */
    .menu { transform-origin: top center; transition: opacity .18s ease, transform .18s ease; }
    .menu[data-open="false"] { opacity: 0; pointer-events: none; transform: scale(0.98) translateY(-4px); }
    .menu[data-open="true"] { opacity: 1; transform: scale(1) translateY(0); }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce) {
      .animate, .animation, .radial-item, .orb-anim { animation: none !important; transition: none !important; }
    }
  </style>
</head>
<body class="font-sans antialiased noise-overlay selection:bg-neon-violet/30">
  <a href="#main" class="sr-only sr-only-focusable bg-cosmic-700 text-white px-3 py-2 rounded-md">Skip to content</a>

  <!-- Top Navigation -->
  <header class="relative z-40">
    <nav class="glass backdrop-blur-md neumorphic mx-3 mt-3 rounded-2xl px-4 lg:px-6 py-3 flex items-center justify-between">
      <!-- Left: Orb Logo -->
      <a href="#" class="flex items-center gap-3 group" aria-label="Salmar home">
        <div class="relative">
          <div class="h-9 w-9 rounded-full bg-gradient-to-br from-neon-violet to-neon-magenta animate-glow shadow-violet-soft flex items-center justify-center">
            <div class="h-6 w-6 rounded-full bg-white/10 border border-white/20 backdrop-blur-xs"></div>
          </div>
          <div class="absolute inset-0 rounded-full animate-pulseRing bg-neon-violet/30"></div>
        </div>
        <span class="text-lg font-semibold tracking-wide">Salmar</span>
      </a>

      <!-- Center: Dashboard dropdown -->
      <div class="relative">
        <button id="dashboardBtn" class="btn glass-strong px-4 py-2 rounded-xl flex items-center gap-2 hover:shadow-violet-soft" aria-haspopup="true" aria-expanded="false" aria-controls="dashboardMenu">
          <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
          <span class="hidden sm:inline">Dashboard</span>
          <i data-lucide="chevron-down" class="w-4 h-4"></i>
        </button>
        <div id="dashboardMenu" class="menu absolute left-1/2 -translate-x-1/2 mt-2 w-56 glass-strong rounded-xl p-2" data-open="false" role="menu">
          <button class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/5 flex items-center gap-2" role="menuitem" data-nav="core">
            <i data-lucide="cpu" class="w-4 h-4"></i> AI Core
          </button>
          <button class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/5 flex items-center gap-2" role="menuitem" data-nav="timeline">
            <i data-lucide="timeline" class="w-4 h-4"></i> Timeline
          </button>
          <button class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/5 flex items-center gap-2" role="menuitem" data-nav="integrations">
            <i data-lucide="plug" class="w-4 h-4"></i> Integrations
          </button>
        </div>
      </div>

      <!-- Right: Help, Theme, Profile -->
      <div class="flex items-center gap-2">
        <button id="helpBtn" class="btn glass px-3 py-2 rounded-xl hover:shadow-lavender" aria-label="Help">
          <i data-lucide="help-circle" class="w-5 h-5"></i>
        </button>
        <button id="themeToggle" class="btn glass px-3 py-2 rounded-xl hover:shadow-lavender" aria-label="Toggle theme">
          <i data-lucide="sun-moon" class="w-5 h-5"></i>
        </button>

        <div class="relative">
          <button id="profileBtn" class="btn glass-strong px-3 py-2 rounded-xl flex items-center gap-2 hover:shadow-violet-soft" aria-haspopup="true" aria-expanded="false" aria-controls="profileMenu">
            <div id="biometricDot" class="h-2.5 w-2.5 rounded-full bg-gray-400 shadow-inner"></div>
            <span class="hidden sm:inline">Profile</span>
            <i data-lucide="chevron-down" class="w-4 h-4"></i>
          </button>
          <div id="profileMenu" class="menu absolute right-0 mt-2 w-64 glass-strong rounded-xl p-2" data-open="false" role="menu">
            <div class="px-3 py-2">
              <div class="font-semibold">Signed in as</div>
              <div class="text-sm opacity-80">user@salmar.ai</div>
            </div>
            <div class="my-1 border-t border-white/10"></div>
            <button class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/5 flex items-center justify-between" role="menuitem" id="toggleBiometric">
              <span class="flex items-center gap-2">
                <i data-lucide="scan-face" class="w-4 h-4"></i> Biometric glow
              </span>
              <span class="text-xs opacity-80">Auto</span>
            </button>
            <button class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/5 flex items-center gap-2" role="menuitem" id="logoutBtn">
              <i data-lucide="log-out" class="w-4 h-4"></i> Sign out
            </button>
          </div>
        </div>
      </div>
    </nav>
  </header>

  <div class="flex">
    <!-- Sidebar -->
    <aside id="sidebar" class="glass-strong neumorphic relative z-30 mt-3 ml-3 rounded-2xl w-72 max-w-[80vw] transition-all duration-300 overflow-hidden"
           aria-label="Sidebar with modes, history and personality">
      <div class="flex items-center justify-between px-4 py-3 border-b border-white/10">
        <div class="flex items-center gap-2">
          <i data-lucide="panel-left" class="w-5 h-5"></i>
          <span class="font-semibold">Control Center</span>
        </div>
        <button id="sidebarToggle" class="btn glass px-2 py-2 rounded-lg" aria-label="Collapse sidebar">
          <i data-lucide="chevrons-left-right" class="w-4 h-4"></i>
        </button>
      </div>

      <!-- Modes -->
      <section class="px-4 py-3">
        <h2 class="text-sm uppercase tracking-wider opacity-70 mb-2">Modes</h2>
        <div class="grid grid-cols-2 gap-2">
          <button class="btn rounded-xl glass px-3 py-2 flex items-center gap-2 hover:shadow-lavender mode-btn" data-mode="knowledge" aria-pressed="false">
            <span class="h-2 w-2 rounded-full" style="background:#2da3ff"></span> Knowledge
          </button>
          <button class="btn rounded-xl glass px-3 py-2 flex items-center gap-2 hover:shadow-lavender mode-btn" data-mode="creative" aria-pressed="false">
            <span class="h-2 w-2 rounded-full" style="background:#ff4edb"></span> Creative
          </button>
          <button class="btn rounded-xl glass px-3 py-2 flex items-center gap-2 hover:shadow-lavender mode-btn" data-mode="business" aria-pressed="false">
            <span class="h-2 w-2 rounded-full" style="background:#ffbd2e"></span> Business
          </button>
          <button class="btn rounded-xl glass px-3 py-2 flex items-center gap-2 hover:shadow-lavender mode-btn" data-mode="security" aria-pressed="false">
            <span class="h-2 w-2 rounded-full" style="background:#23d18b"></span> Security
          </button>
          <button class="btn rounded-xl glass px-3 py-2 col-span-2 flex items-center gap-2 hover:shadow-lavender mode-btn" data-mode="integrations" aria-pressed="false">
            <span class="h-2 w-2 rounded-full bg-white/50"></span> Integrations
          </button>
        </div>
      </section>

      <!-- History -->
      <section class="px-4 py-3 border-t border-white/10">
        <h2 class="text-sm uppercase tracking-wider opacity-70 mb-2">History</h2>
        <div id="historyList" class="space-y-2 max-h-56 overflow-auto pr-1" role="list">
          <!-- Populated via JS -->
        </div>
      </section>

      <!-- Personality Slider -->
      <section class="px-4 py-3 border-t border-white/10">
        <h2 class="text-sm uppercase tracking-wider opacity-70 mb-3">Personality</h2>
        <div class="space-y-3">
          <div class="flex items-center justify-between text-xs opacity-75">
            <span>Professional</span><span>Friendly</span><span>Visionary</span><span>Technical</span>
          </div>
          <input id="personality" type="range" min="0" max="3" step="1" value="0" class="w-full accent-neon-violet" aria-label="AI Personality Slider" />
          <div id="personalityLabel" class="text-sm text-neon-lavender">Professional</div>
        </div>
      </section>
    </aside>

    <!-- Main -->
    <main id="main" class="relative flex-1 min-h-[calc(100vh-96px)] mt-3 mr-3">
      <!-- Chat Container -->
      <section class="glass-strong neumorphic rounded-2xl w-full h-[calc(100vh-140px)] flex flex-col overflow-hidden relative" aria-label="Salmar AI Core Chat">
        <!-- Orb floating container -->
        <div class="absolute inset-x-0 top-4 flex items-center justify-center pointer-events-none">
          <div class="relative w-40 h-40 flex items-center justify-center">
            <canvas id="orbCanvas" width="240" height="240" class="orb-anim"></canvas>
            <!-- State rings -->
            <div id="ringListening" class="absolute inset-0 rounded-full border-2 border-neon-violet/30 animate-pulse opacity-0"></div>
            <div id="ringReady" class="absolute inset-0 rounded-full bg-neon-violet/20 blur-xl opacity-0"></div>
          </div>
        </div>

        <!-- Conversation -->
        <div id="chatScroll" class="mt-40 flex-1 overflow-auto px-4 sm:px-6 py-6 space-y-4">
          <!-- Messages rendered here -->
        </div>

        <!-- Input Bar -->
        <form id="chatForm" class="relative px-4 sm:px-6 pb-5">
          <div class="glass-strong rounded-2xl glow-border focus-glow p-2 sm:p-3 flex flex-col gap-2">
            <div class="flex items-center gap-2">
              <button type="button" id="voiceBtn" class="btn glass px-3 py-2 rounded-xl" aria-label="Voice input">
                <i data-lucide="mic" class="w-5 h-5"></i>
              </button>
              <button type="button" id="uploadBtn" class="btn glass px-3 py-2 rounded-xl" aria-label="Upload file">
                <i data-lucide="paperclip" class="w-5 h-5"></i>
              </button>
              <div class="relative flex-1">
                <label for="chatInput" class="sr-only">Ask me anything</label>
                <textarea id="chatInput" rows="1" class="w-full bg-transparent resize-none outline-none text-base sm:text-lg placeholder:opacity-60"
                          placeholder="Ask me anythingâ€¦" aria-multiline="true"></textarea>
              </div>
              <button type="submit" class="btn px-4 py-2 rounded-xl bg-gradient-to-r from-neon-violet to-neon-magenta text-white shadow-violet-soft hover:shadow-lavender">
                <span class="hidden sm:inline">Send</span>
                <i data-lucide="arrow-up-circle" class="w-5 h-5 sm:hidden"></i>
              </button>
            </div>
            <div class="flex items-center justify-between">
              <button type="button" id="advancedBtn" class="btn glass px-3 py-2 rounded-xl flex items-center gap-2">
                <i data-lucide="settings-2" class="w-5 h-5"></i> Advanced Options
              </button>
              <div class="text-xs opacity-70">Enter = Send â€¢ Shift+Enter = New line â€¢ / = Focus</div>
            </div>
          </div>
          <input id="fileInput" type="file" class="hidden" accept=".txt,.md,.pdf,.png,.jpg,.jpeg,.json" />
        </form>
      </section>

      <!-- Advanced Drawer -->
      <section id="advancedDrawer" class="pointer-events-none fixed left-1/2 -translate-x-1/2 bottom-0 w-[min(1100px,95vw)] z-40">
        <div class="pointer-events-auto translate-y-full transition-transform duration-300 glass-strong neumorphic rounded-t-3xl border-t border-white/10" aria-hidden="true">
          <div class="px-5 py-4 flex items-center justify-between">
            <div class="flex items-center gap-2">
              <i data-lucide="sliders" class="w-5 h-5"></i>
              <h3 class="font-semibold text-lg">Advanced Controls</h3>
            </div>
            <button id="drawerClose" class="btn glass px-3 py-2 rounded-xl" aria-label="Close advanced">
              <i data-lucide="x" class="w-5 h-5"></i>
            </button>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 px-5 pb-6">
            <!-- Response Style -->
            <div class="glass rounded-2xl p-4">
              <h4 class="text-sm uppercase tracking-wider opacity-70 mb-3">Response Style</h4>
              <div id="responseStyle" class="grid grid-cols-2 gap-2" role="group" aria-label="Response style">
                <button class="btn glass px-3 py-2 rounded-xl aria-selected ring-1 ring-neon-violet/50" data-value="concise">Concise</button>
                <button class="btn glass px-3 py-2 rounded-xl" data-value="detailed">Detailed</button>
                <button class="btn glass px-3 py-2 rounded-xl" data-value="step">Step-by-step</button>
                <button class="btn glass px-3 py-2 rounded-xl" data-value="creative">Creative</button>
              </div>
            </div>

            <!-- Output Format -->
            <div class="glass rounded-2xl p-4">
              <h4 class="text-sm uppercase tracking-wider opacity-70 mb-3">Output Format</h4>
              <div id="outputFormat" class="grid grid-cols-3 gap-2">
                <label class="glass px-3 py-2 rounded-xl flex items-center gap-2 cursor-pointer">
                  <input type="radio" name="format" value="md" class="accent-neon-violet" checked />
                  <span>Markdown</span>
                </label>
                <label class="glass px-3 py-2 rounded-xl flex items-center gap-2 cursor-pointer">
                  <input type="radio" name="format" value="json" class="accent-neon-violet" />
                  <span>JSON</span>
                </label>
                <label class="glass px-3 py-2 rounded-xl flex items-center gap-2 cursor-pointer">
                  <input type="radio" name="format" value="pdf" class="accent-neon-violet" />
                  <span>PDF</span>
                </label>
                <label class="glass px-3 py-2 rounded-xl flex items-center gap-2 cursor-pointer">
                  <input type="radio" name="format" value="docx" class="accent-neon-violet" />
                  <span>DOCX</span>
                </label>
                <label class="glass px-3 py-2 rounded-xl flex items-center gap-2 cursor-pointer">
                  <input type="radio" name="format" value="pptx" class="accent-neon-violet" />
                  <span>PPTX</span>
                </label>
              </div>
            </div>

            <!-- AI Modes -->
            <div class="glass rounded-2xl p-4">
              <h4 class="text-sm uppercase tracking-wider opacity-70 mb-3">AI Modes</h4>
              <div id="aiModes" class="flex flex-wrap gap-2">
                <button class="btn glass px-3 py-2 rounded-xl ring-1 ring-neon-violet/50" data-value="smart">Smart</button>
                <button class="btn glass px-3 py-2 rounded-xl" data-value="deep">Deep Dive</button>
                <button class="btn glass px-3 py-2 rounded-xl" data-value="creative">Creative</button>
                <button class="btn glass px-3 py-2 rounded-xl" data-value="action">Action</button>
              </div>
            </div>

            <!-- Security -->
            <div class="glass rounded-2xl p-4">
              <h4 class="text-sm uppercase tracking-wider opacity-70 mb-3">Security Controls</h4>
              <div class="space-y-2">
                <label class="flex items-center gap-3">
                  <input id="biometricToggle" type="checkbox" class="accent-emerald-400" />
                  <span>Biometric re-auth</span>
                </label>
                <label class="flex items-center gap-3">
                  <input id="encryptedToggle" type="checkbox" class="accent-emerald-400" />
                  <span>Encrypted responses</span>
                </label>
                <label class="flex items-center gap-3">
                  <input id="lockToggle" type="checkbox" class="accent-emerald-400" />
                  <span>Lock outputs</span>
                </label>
              </div>
            </div>

            <!-- Collaboration -->
            <div class="glass rounded-2xl p-4">
              <h4 class="text-sm uppercase tracking-wider opacity-70 mb-3">Collaboration</h4>
              <div class="flex -space-x-2 mb-3">
                <img alt="Ava" src="https://picsum.photos/seed/ava/40" class="h-8 w-8 rounded-full ring-2 ring-white/30" />
                <img alt="Ben" src="https://picsum.photos/seed/ben/40" class="h-8 w-8 rounded-full ring-2 ring-white/30" />
                <img alt="Kai" src="https://picsum.photos/seed/kai/40" class="h-8 w-8 rounded-full ring-2 ring-white/30" />
                <button id="inviteBtn" class="btn glass h-8 w-8 rounded-full flex items-center justify-center ring-2 ring-white/30" aria-label="Invite teammate">
                  <i data-lucide="plus" class="w-4 h-4"></i>
                </button>
              </div>
              <div class="text-xs opacity-75">Assign roles</div>
              <div class="mt-2 grid grid-cols-3 gap-2">
                <button class="btn glass px-2 py-1.5 rounded-lg text-sm">Viewer</button>
                <button class="btn glass px-2 py-1.5 rounded-lg text-sm">Editor</button>
                <button class="btn glass px-2 py-1.5 rounded-lg text-sm">Owner</button>
              </div>
            </div>

            <!-- Memory -->
            <div class="glass rounded-2xl p-4">
              <h4 class="text-sm uppercase tracking-wider opacity-70 mb-3">Memory</h4>
              <div class="flex items-center gap-3">
                <span class="text-sm opacity-80 w-28">Short-term</span>
                <label class="relative inline-flex items-center cursor-pointer">
                  <input id="memoryToggle" type="checkbox" class="sr-only peer">
                  <div class="w-12 h-6 bg-white/20 peer-focus:outline-none rounded-full peer peer-checked:bg-neon-violet transition-colors"></div>
                  <span class="absolute left-1 top-1 h-4 w-4 bg-white rounded-full transition-transform peer-checked:translate-x-6"></span>
                </label>
                <span class="text-sm opacity-80">Long-term</span>
              </div>
            </div>

            <!-- Task Automations -->
            <div class="glass rounded-2xl p-4 lg:col-span-2">
              <h4 class="text-sm uppercase tracking-wider opacity-70 mb-3">Task Automations</h4>
              <div id="workflow" class="flex items-center gap-3 overflow-x-auto pb-2">
                <!-- Steps created by JS -->
              </div>
              <div class="flex items-center gap-2 mt-3">
                <button id="addStep" class="btn glass px-3 py-2 rounded-xl">
                  <i data-lucide="plus" class="w-4 h-4"></i> Add Step
                </button>
                <button id="runWorkflow" class="btn px-3 py-2 rounded-xl bg-gradient-to-r from-neon-violet to-neon-magenta text-white">
                  Run Workflow
                </button>
                <span class="text-xs opacity-70">Drag steps to reorder</span>
              </div>
            </div>

            <!-- Orb Settings -->
            <div class="glass rounded-2xl p-4">
              <h4 class="text-sm uppercase tracking-wider opacity-70 mb-3">Salmar Orb Settings</h4>
              <div class="space-y-3">
                <div>
                  <div class="text-sm mb-2">Animation Intensity</div>
                  <div id="orbIntensity" class="flex gap-2">
                    <button class="btn glass px-3 py-2 rounded-xl" data-value="minimal">Minimal</button>
                    <button class="btn glass px-3 py-2 rounded-xl ring-1 ring-neon-violet/50" data-value="balanced">Balanced</button>
                    <button class="btn glass px-3 py-2 rounded-xl" data-value="expressive">Expressive</button>
                  </div>
                </div>
                <div>
                  <div class="text-sm mb-2">Glow Behaviors</div>
                  <div class="flex flex-wrap gap-2">
                    <label class="glass px-3 py-2 rounded-xl flex items-center gap-2 cursor-pointer">
                      <input type="checkbox" class="accent-neon-violet" checked id="gbRings" />
                      <span>Rings (Listening)</span>
                    </label>
                    <label class="glass px-3 py-2 rounded-xl flex items-center gap-2 cursor-pointer">
                      <input type="checkbox" class="accent-neon-violet" checked id="gbParticles" />
                      <span>Particles (Processing)</span>
                    </label>
                    <label class="glass px-3 py-2 rounded-xl flex items-center gap-2 cursor-pointer">
                      <input type="checkbox" class="accent-neon-violet" checked id="gbRadiant" />
                      <span>Radiant Glow (Ready)</span>
                    </label>
                  </div>
                </div>
                <label class="flex items-center gap-3">
                  <input id="soundToggle" type="checkbox" class="accent-neon-violet" />
                  <span>Sound feedback</span>
                </label>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Floating Radial Action Orb -->
      <div id="radial" class="radial">
        <button id="radialMain" class="btn rounded-full h-14 w-14 bg-gradient-to-br from-neon-violet to-neon-magenta text-white shadow-violet-soft flex items-center justify-center">
          <i data-lucide="sparkles" class="w-6 h-6"></i>
        </button>
        <button class="radial-item btn glass h-12 w-12 rounded-full flex items-center justify-center" data-action="new">
          <i data-lucide="plus-circle" class="w-5 h-5"></i>
        </button>
        <button class="radial-item btn glass h-12 w-12 rounded-full flex items-center justify-center" data-action="upload">
          <i data-lucide="folder-up" class="w-5 h-5"></i>
        </button>
        <button class="radial-item btn glass h-12 w-12 rounded-full flex items-center justify-center" data-action="voice">
          <i data-lucide="mic" class="w-5 h-5"></i>
        </button>
        <button class="radial-item btn glass h-12 w-12 rounded-full flex items-center justify-center" data-action="collab">
          <i data-lucide="users" class="w-5 h-5"></i>
        </button>
        <button class="radial-item btn glass h-12 w-12 rounded-full flex items-center justify-center" data-action="auto">
          <i data-lucide="workflow" class="w-5 h-5"></i>
        </button>
      </div>

      <!-- Footer -->
      <footer class="mt-3">
        <div class="glass rounded-2xl px-4 py-3 flex flex-col sm:flex-row items-center justify-between">
          <div class="flex items-center gap-4 text-sm opacity-80">
            <a href="helpcenter.html" class="hover:opacity-100">Help Center</a>
            <a href="report.html" class="hover:opacity-100">Report Issue</a>
            <a href="securitystatus.html" class="hover:opacity-100">Security Status</a>
          </div>
          <div class="text-sm opacity-80">The Future is Purple. The Future is Salmar.</div>
        </div>
      </footer>
    </main>
  </div>

  <!-- Command Palette -->
  <div id="cmdPalette" class="fixed inset-0 bg-black/40 hidden items-start justify-center pt-20 z-50" role="dialog" aria-modal="true" aria-label="Command palette">
    <div class="glass-strong rounded-2xl w-[min(720px,90vw)] p-3">
      <div class="flex items-center gap-2 px-2 py-2 rounded-xl glass focus-glow">
        <i data-lucide="search" class="w-5 h-5 opacity-80"></i>
        <input id="cmdInput" type="text" placeholder="Type a commandâ€¦ (e.g., new chat, voice, upload, automations)" class="w-full bg-transparent outline-none py-2" />
        <button id="cmdClose" class="btn glass px-2 py-2 rounded-lg" aria-label="Close command palette">
          <i data-lucide="x" class="w-4 h-4"></i>
        </button>
      </div>
      <div id="cmdResults" class="mt-3 grid gap-2">
        <!-- Results -->
      </div>
    </div>
  </div>

  <script>
    // Global state (no localStorage; ephemeral)
    const state = {
      mode: 'knowledge',                // knowledge | creative | business | security | integrations
      personality: 0,                   // 0..3
      responseStyle: 'concise',         // concise | detailed | step | creative
      outputFormat: 'md',               // md | json | pdf | docx | pptx
      aiMode: 'smart',                  // smart | deep | creative | action
      biometric: false,
      encrypted: false,
      lockOutputs: false,
      memoryLongTerm: false,
      orb: {
        intensity: 'balanced',          // minimal | balanced | expressive
        behaviors: { rings: true, particles: true, radiant: true },
        sound: false,
        state: 'idle'                   // idle | listening | processing | ready
      },
      history: [],
      collaborators: ['Ava', 'Ben', 'Kai']
    };

    // Utils
    const $ = (sel, root = document) => root.querySelector(sel);
    const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));
    const el = (tag, cls = '', attrs = {}) => {
      const n = document.createElement(tag);
      if (cls) n.className = cls;
      for (const [k,v] of Object.entries(attrs)) {
        if (k === 'text') n.textContent = v;
        else if (k === 'html') n.innerHTML = v;
        else n.setAttribute(k, v);
      }
      return n;
    };
    const downloadFile = (name, type, content) => {
      const blob = new Blob([content], { type });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = name;
      document.body.appendChild(a);
      a.click();
      URL.revokeObjectURL(a.href);
      a.remove();
    };

    // Tooltips
    const tip = (target, content) => {
      tippy(target, { content, theme: 'light', delay: [300, 0], animation: 'shift-away-subtle' });
    };

    // Menu dropdown handling
    const setupMenu = (btn, menu) => {
      const open = () => { menu.dataset.open = 'true'; btn.setAttribute('aria-expanded', 'true'); };
      const close = () => { menu.dataset.open = 'false'; btn.setAttribute('aria-expanded', 'false'); };
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const isOpen = menu.dataset.open === 'true';
        (isOpen ? close : open)();
      });
      document.addEventListener('click', (e) => {
        if (!menu.contains(e.target) && e.target !== btn) menu.dataset.open = 'false';
      });
      btn.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowDown') { menu.dataset.open = 'true'; e.preventDefault(); (menu.querySelector('[role="menuitem"]')||{}).focus?.(); }
      });
      return { open, close };
    };

    // Sidebar toggle
    const sidebar = $('#sidebar');
    $('#sidebarToggle').addEventListener('click', () => {
      const collapsed = sidebar.classList.toggle('w-20');
      sidebar.classList.toggle('w-72', !collapsed);
      // Hide internal texts when collapsed
      $$('#sidebar .mode-btn').forEach(btn => {
        btn.querySelectorAll('span')[1]?.classList.toggle('hidden', collapsed);
      });
    });

    // Mode buttons
    $$('#sidebar .mode-btn').forEach(btn => {
      tip(btn, `Switch to ${btn.dataset.mode} mode`);
      btn.addEventListener('click', () => {
        state.mode = btn.dataset.mode;
        $$('#sidebar .mode-btn').forEach(b => {
          const color = {
            knowledge: '#2da3ff',
            creative: '#ff4edb',
            business: '#ffbd2e',
            security: '#23d18b',
            integrations: 'rgba(255,255,255,0.5)'
          }[b.dataset.mode];
          b.style.borderColor = b.dataset.mode === state.mode ? color : 'transparent';
          b.style.boxShadow = b.dataset.mode === state.mode ? `0 0 0 1px ${color}` : '';
        });
        // Provide subtle accent on orb
        accentOrbByMode();
        // Announce
        announce(`Mode changed to ${state.mode}`);
      });
    });
    function accentOrbByMode() {
      const { mode } = state;
      const ctx = orbCtx;
      if (!ctx) return;
      const accent = {
        knowledge: '#2da3ff',
        creative: '#ff4edb',
        business: '#ffbd2e',
        security: '#23d18b',
        integrations: '#bba8ff'
      }[mode] || '#a45cff';
      orbConfig.accent = accent;
    }

    // Personality slider
    const personalities = ['Professional','Friendly','Visionary','Technical'];
    const personalityInput = $('#personality');
    const personalityLabel = $('#personalityLabel');
    personalityInput.addEventListener('input', () => {
      state.personality = +personalityInput.value;
      personalityLabel.textContent = personalities[state.personality];
      announce(`Personality set to ${personalities[state.personality]}`);
    });

    // Menus
    const dashboardMenu = setupMenu($('#dashboardBtn'), $('#dashboardMenu'));
    const profileMenu = setupMenu($('#profileBtn'), $('#profileMenu'));

    // Biometric indicator
    async function detectBiometricSupport() {
      try {
        const supported = 'PublicKeyCredential' in window &&
          (await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable?.()) === true;
        const dot = $('#biometricDot');
        if (supported) {
          dot.classList.remove('bg-gray-400');
          dot.classList.add('bg-mode-security');
          dot.style.boxShadow = '0 0 12px rgba(35,209,139,0.7)';
          dot.title = 'Biometric capable device detected';
        } else {
          dot.title = 'No biometric capability detected';
        }
      } catch (e) {
        // silent
      }
    }
    detectBiometricSupport();

    // Theme toggle
    $('#themeToggle').addEventListener('click', () => {
      document.body.classList.toggle('theme-light');
      announce('Theme toggled');
    });

    // Help
    $('#helpBtn').addEventListener('click', () => {
      openCmdPalette();
      $('#cmdInput').value = 'help';
      renderCmdResults('help');
    });

    // History list (virtualized-ish simple)
    const historyList = $('#historyList');
    function addHistoryItem(title) {
      const time = new Date().toLocaleTimeString();
      const item = el('button', 'w-full text-left px-3 py-2 rounded-xl glass hover:shadow-lavender border border-white/10 flex justify-between items-center');
      item.innerHTML = `<span class="truncate">${title}</span><span class="text-xs opacity-70">${time}</span>`;
      item.addEventListener('click', () => {
        announce(`Loaded session: ${title}`);
        pushSystemMessage(`Loaded past session: ${title}`);
      });
      historyList.prepend(item);
      state.history.unshift({ title, time });
      if (state.history.length > 60) {
        state.history = state.history.slice(0,60);
        // trim DOM
        while (historyList.childElementCount > 60) historyList.removeChild(historyList.lastChild);
      }
    }

    // Chat rendering
    const chatScroll = $('#chatScroll');
    function createMessage({ role, text, attachments = [], encrypted = state.encrypted }) {
      const row = el('div', `flex ${role === 'user' ? 'message-user' : 'message-salmar'}`);
      const card = el('div', `max-w-[90%] sm:max-w-[70%] px-4 py-3 rounded-2xl glass ${role==='salmar'?'bg-[var(--card)]':'bg-[var(--glass-strong)]'} shadow-lavender relative`);
      if (role === 'salmar') {
        card.classList.add('border','border-white/10');
      } else {
        card.classList.add('border','border-white/10');
      }
      const head = el('div','flex items-center gap-2 mb-2');
      if (role === 'salmar') {
        const orbDot = el('div','h-2.5 w-2.5 rounded-full', { });
        orbDot.style.background = state.mode === 'security' ? '#23d18b' : '#a45cff';
        head.appendChild(orbDot);
        head.appendChild(el('div','text-sm opacity-80', { text: 'Salmar' }));
        if (encrypted) {
          const lock = el('div','ml-auto text-xs opacity-80 flex items-center gap-1');
          lock.innerHTML = `<i data-lucide="lock" class="w-3.5 h-3.5"></i> Encrypted`;
          head.appendChild(lock);
        }
      } else {
        head.appendChild(el('div','text-sm opacity-80', { text: 'You' }));
      }
      card.appendChild(head);

      const p = el('div','whitespace-pre-wrap leading-relaxed');
      p.textContent = text || '';
      card.appendChild(p);

      // Attachments preview
      if (attachments.length) {
        const wrap = el('div','mt-3 grid grid-cols-2 gap-2');
        attachments.forEach(att => {
          const at = el('div','glass rounded-xl p-2 text-sm flex gap-2 items-center');
          at.innerHTML = `<i data-lucide="${att.icon || 'file'}" class="w-4 h-4"></i> <span class="truncate">${att.name}</span>`;
          wrap.appendChild(at);
        });
        card.appendChild(wrap);
      }

      // Tools (hover)
      const tools = el('div','absolute -top-3 right-2 flex gap-1 opacity-0 hover:opacity-100 transition-opacity');
      [
        {icon:'sparkles', label:'Summarize', action:() => summarize(card)},
        {icon:'chevrons-up', label:'Expand', action:() => expand(card)},
        {icon:'languages', label:'Translate', action:() => translate(card)},
        {icon:'pen-line', label:'Rewrite', action:() => rewrite(card)}
      ].forEach(t=>{
        const b = el('button','btn glass h-8 w-8 rounded-lg flex items-center justify-center', {'aria-label':t.label, title:t.label});
        b.innerHTML = `<i data-lucide="${t.icon}" class="w-4 h-4"></i>`;
        b.addEventListener('click', (e)=>{ e.stopPropagation(); t.action(); });
        tools.appendChild(b);
      });
      card.appendChild(tools);

      // Export bar
      const bar = el('div','mt-3 pt-2 border-t border-white/10 flex items-center gap-2 text-xs');
      const save = el('button','btn glass px-2 py-1 rounded-lg flex items-center gap-1', { 'aria-label': 'Save' });
      save.innerHTML = `<i data-lucide="save" class="w-3.5 h-3.5"></i> Save`;
      save.addEventListener('click', () => {
        const content = p.textContent;
        const ext = state.outputFormat || 'md';
        const mime = {
          md: 'text/markdown',
          json: 'application/json',
          pdf: 'text/html',
          docx: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
          pptx: 'application/vnd.openxmlformats-officedocument.presentationml.presentation'
        }[ext] || 'text/plain';
        let body = content;
        if (ext === 'json') body = JSON.stringify({ role, content, ts: Date.now() }, null, 2);
        if (ext === 'pdf') body = `<!DOCTYPE html><meta charset="utf-8"><title>Salmar Export</title><style>body{font-family:Inter,system-ui;margin:40px;}</style><h1>Salmar Export</h1><pre>${escapeHtml(content)}</pre>`;
        downloadFile(`salmar.${ext}`, mime, body);
      });
      const share = el('button','btn glass px-2 py-1 rounded-lg flex items-center gap-1', { 'aria-label': 'Share' });
      share.innerHTML = `<i data-lucide="share-2" class="w-3.5 h-3.5"></i> Share`;
      share.addEventListener('click', async () => {
        try {
          if (navigator.share) {
            await navigator.share({ title: 'Salmar Response', text: p.textContent });
          } else {
            await navigator.clipboard?.writeText(p.textContent);
            announce('Copied to clipboard');
          }
        } catch(e){ /* ignore */ }
      });
      const send = el('button','btn glass px-2 py-1 rounded-lg flex items-center gap-1', { 'aria-label': 'Send' });
      send.innerHTML = `<i data-lucide="send" class="w-3.5 h-3.5"></i> Send`;
      send.addEventListener('click', () => {
        announce('Sent to collaborators');
        pushSystemMessage('Shared the response with collaborators.');
      });
      bar.append(save, share, send);
      card.appendChild(bar);

      row.appendChild(card);
      chatScroll.appendChild(row);
      lucide.createIcons();
      scrollToBottom();
      return card;
    }

    function pushUserMessage(text, attachments = []) {
      const card = createMessage({ role: 'user', text, attachments });
      addHistoryItem(text.slice(0, 32) + (text.length > 32 ? 'â€¦' : ''));
      return card;
    }
    function pushSalmarMessage(text) {
      return createMessage({ role: 'salmar', text });
    }
    function pushSystemMessage(text) {
      const row = el('div', 'flex justify-center');
      const card = el('div', 'text-xs opacity-80 px-3 py-1 rounded-full glass');
      card.textContent = text;
      row.appendChild(card);
      chatScroll.appendChild(row);
      scrollToBottom();
      return card;
    }

    function scrollToBottom() {
      chatScroll.scrollTo({ top: chatScroll.scrollHeight, behavior: 'smooth' });
    }

    // Simple transformations for tools
    function summarize(card) {
      const contentEl = card.querySelector('div.whitespace-pre-wrap');
      const text = contentEl.textContent.trim();
      const sentences = text.split(/(?<=[.!?])\s+/).filter(Boolean);
      const sum = sentences.slice(0, Math.max(1, Math.floor(sentences.length/3))).join(' ');
      contentEl.textContent = sum + (sentences.length > 1 ? ' â€¦' : '');
    }
    function expand(card) {
      const contentEl = card.querySelector('div.whitespace-pre-wrap');
      contentEl.textContent = contentEl.textContent + '\n\nFurther details: ' + generateContent('detailed', 'expansion');
    }
    function translate(card) {
      const contentEl = card.querySelector('div.whitespace-pre-wrap');
      const t = contentEl.textContent;
      // Simple pseudo-translation marker
      contentEl.textContent = `[Translated] ${t}`;
    }
    function rewrite(card) {
      const contentEl = card.querySelector('div.whitespace-pre-wrap');
      const t = contentEl.textContent;
      contentEl.textContent = t.replace(/\b(can|will|should)\b/gi, (m)=>({can:'is able to', will:'is going to', should:'is recommended to'}[m.toLowerCase()]||m));
    }

    // Escape helper
    function escapeHtml(str) {
      return str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    // Input auto-resize
    const chatInput = $('#chatInput');
    chatInput.addEventListener('input', () => {
      chatInput.style.height = 'auto';
      chatInput.style.height = Math.min(200, chatInput.scrollHeight) + 'px';
    });

    // Send handler
    $('#chatForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = chatInput.value.trim();
      if (!text) return;
      chatInput.value = '';
      chatInput.style.height = 'auto';
      pushUserMessage(text);
      setOrbState('processing');

      // Simulate AI response
      const response = await simulateAI(text);
      const card = pushSalmarMessage(response);
      if (state.encrypted) {
        // already shown in header
      }
      setOrbState('ready');
      setTimeout(()=> setOrbState('idle'), 1000);
    });

    // Voice input
    let recognition = null;
    let recognizing = false;
    $('#voiceBtn').addEventListener('click', () => {
      if (recognizing) {
        try { recognition.stop(); } catch(e){}
        return;
      }
      try {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) throw new Error('Speech recognition not supported');
        recognition = new SpeechRecognition();
        recognition.lang = 'en-US';
        recognition.interimResults = true;
        recognition.continuous = true;

        recognition.onstart = () => {
          recognizing = true;
          setOrbState('listening');
          announce('Voice listening');
        };
        recognition.onresult = (event) => {
          let interim = '';
          for (let i=event.resultIndex; i<event.results.length; i++) {
            const tr = event.results[i][0].transcript;
            if (event.results[i].isFinal) chatInput.value += (chatInput.value ? ' ' : '') + tr;
            else interim += tr;
          }
        };
        recognition.onerror = () => { recognizing = false; setOrbState('idle'); };
        recognition.onend = () => { recognizing = false; setOrbState('idle'); };
        recognition.start();
      } catch(e) {
        announce('Voice not available');
      }
    });

    // Upload
    $('#uploadBtn').addEventListener('click', () => $('#fileInput').click());
    $('#fileInput').addEventListener('change', (e) => {
      const files = Array.from(e.target.files || []);
      if (!files.length) return;
      const att = files.map(f => ({ name: f.name, icon: fileIconFor(f.name) }));
      pushUserMessage('Uploaded files.', att);
      e.target.value = '';
    });
    function fileIconFor(name) {
      const ext = name.split('.').pop().toLowerCase();
      if (['png','jpg','jpeg','gif','webp'].includes(ext)) return 'image';
      if (['pdf'].includes(ext)) return 'file-text';
      if (['txt','md'].includes(ext)) return 'file-text';
      if (['json'].includes(ext)) return 'braces';
      return 'file';
    }

    // Advanced drawer toggle
    const drawer = $('#advancedDrawer > div');
    const openDrawer = () => {
      $('#advancedDrawer').style.pointerEvents = 'none';
      drawer.style.transform = 'translateY(0)';
      $('#advancedDrawer').style.pointerEvents = 'auto';
      drawer.setAttribute('aria-hidden','false');
      document.body.classList.add('advanced-open');
    };
    const closeDrawer = () => {
      drawer.style.transform = 'translateY(100%)';
      drawer.setAttribute('aria-hidden','true');
      document.body.classList.remove('advanced-open');
    };
    $('#advancedBtn').addEventListener('click', openDrawer);
    $('#drawerClose').addEventListener('click', closeDrawer);

    // Advanced controls interactions
    function selectGroup(container, stateKey) {
      $$('#' + container + ' .btn').forEach(btn => {
        btn.addEventListener('click', () => {
          $$('#' + container + ' .btn').forEach(b => b.classList.remove('ring-1','ring-neon-violet/50'));
          btn.classList.add('ring-1','ring-neon-violet/50');
          const val = btn.dataset.value;
          if (container === 'responseStyle') state.responseStyle = val;
          if (container === 'aiModes') state.aiMode = val;
          if (container === 'orbIntensity') state.orb.intensity = val;
          announce(`${container} set to ${val}`);
        });
      });
    }
    selectGroup('responseStyle');
    selectGroup('aiModes');
    selectGroup('orbIntensity');

    // Output format radios
    $$('#outputFormat input[type="radio"]').forEach(r => {
      r.addEventListener('change', () => {
        if (r.checked) {
          state.outputFormat = r.value;
          announce(`Output format set to ${r.value.toUpperCase()}`);
        }
      });
    });

    // Security toggles
    $('#biometricToggle').addEventListener('change', () => {
      state.biometric = $('#biometricToggle').checked;
      announce(`Biometric ${state.biometric ? 'enabled' : 'disabled'}`);
    });
    $('#encryptedToggle').addEventListener('change', () => {
      state.encrypted = $('#encryptedToggle').checked;
      announce(`Encrypted responses ${state.encrypted ? 'on' : 'off'}`);
    });
    $('#lockToggle').addEventListener('change', () => {
      state.lockOutputs = $('#lockToggle').checked;
      $('#chatScroll').classList.toggle('no-copy', state.lockOutputs);
      announce(`Lock outputs ${state.lockOutputs ? 'enabled' : 'disabled'}`);
    });

    // Memory
    $('#memoryToggle').addEventListener('change', () => {
      state.memoryLongTerm = $('#memoryToggle').checked;
      announce(`Memory set to ${state.memoryLongTerm ? 'Long-term' : 'Short-term'}`);
    });

    // Collaboration
    $('#inviteBtn').addEventListener('click', () => {
      const name = prompt('Invite teammate by name or email:');
      if (!name) return;
      state.collaborators.push(name);
      pushSystemMessage(`Invited ${name} to collaborate.`);
    });

    // Orb glow behaviors
    $('#gbRings').addEventListener('change', (e)=> state.orb.behaviors.rings = e.target.checked);
    $('#gbParticles').addEventListener('change', (e)=> state.orb.behaviors.particles = e.target.checked);
    $('#gbRadiant').addEventListener('change', (e)=> state.orb.behaviors.radiant = e.target.checked);

    // Sound feedback
    let audioCtx = null, hum = null;
    $('#soundToggle').addEventListener('change', async () => {
      state.orb.sound = $('#soundToggle').checked;
      if (state.orb.sound) {
        try {
          audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
          if (audioCtx.state === 'suspended') await audioCtx.resume();
          hum = audioCtx.createOscillator();
          const gain = audioCtx.createGain();
          hum.type = 'sine';
          hum.frequency.setValueAtTime(110, audioCtx.currentTime);
          gain.gain.setValueAtTime(0.0008, audioCtx.currentTime); // very soft
          hum.connect(gain).connect(audioCtx.destination);
          hum.start();
        } catch(e){ /* ignore */ }
      } else {
        try { hum?.stop(); hum?.disconnect(); hum = null; } catch(e){}
      }
    });

    // Radial Orb
    const radial = $('#radial');
    const main = $('#radialMain');
    const items = $$('.radial-item', radial);
    let radialOpen = false;
    main.addEventListener('click', () => {
      radialOpen = !radialOpen;
      radial.classList.toggle('radial-open', radialOpen);
      positionRadialItems();
    });
    function positionRadialItems() {
      const radius = 100;
      const steps = items.length;
      items.forEach((btn, i) => {
        const angle = (Math.PI / (steps+1)) * (i+1); // semi-circle
        const x = Math.cos(angle) * radius;
        const y = Math.sin(angle) * radius;
        btn.style.transform = radialOpen ? `translate(${-x}px, ${-y}px)` : `translate(0,0)`;
      });
    }
    items.forEach(btn => {
      tip(btn, btn.dataset.action);
      btn.addEventListener('click', () => {
        switch(btn.dataset.action) {
          case 'new': newChat(); break;
          case 'upload': $('#fileInput').click(); break;
          case 'voice': $('#voiceBtn').click(); break;
          case 'collab': openCmdPalette('collab'); break;
          case 'auto': openDrawer(); break;
        }
      });
    });

    // Orb Canvas Animation
    const orbCanvas = $('#orbCanvas');
    const orbCtx = orbCanvas.getContext('2d');
    const center = { x: orbCanvas.width / 2, y: orbCanvas.height / 2 };
    const orbConfig = { particles: [], t: 0, accent: '#a45cff' };

    function initOrbParticles() {
      orbConfig.particles = [];
      const count = state.orb.intensity === 'expressive' ? 220 : state.orb.intensity === 'minimal' ? 80 : 140;
      for (let i = 0; i < count; i++) {
        orbConfig.particles.push({
          angle: Math.random() * Math.PI * 2,
          radius: 20 + Math.random() * 70,
          speed: (0.005 + Math.random() * 0.01) * (state.orb.intensity === 'expressive' ? 2 : state.orb.intensity === 'minimal' ? 0.6 : 1),
          size: 1 + Math.random() * 2,
          hue: 275 + Math.random() * 40
        });
      }
    }
    initOrbParticles();

    function drawOrb() {
      const ctx = orbCtx; if (!ctx) return;
      ctx.clearRect(0,0,orbCanvas.width, orbCanvas.height);
      // core
      const grad = ctx.createRadialGradient(center.x, center.y, 10, center.x, center.y, 60);
      grad.addColorStop(0, 'rgba(255,255,255,0.9)');
      grad.addColorStop(0.1, 'rgba(200,181,255,0.9)');
      grad.addColorStop(0.5, orbConfig.accent + 'AA');
      grad.addColorStop(1, 'rgba(10,6,28,0)');
      ctx.beginPath();
      ctx.fillStyle = grad;
      ctx.arc(center.x, center.y, 48, 0, Math.PI*2);
      ctx.fill();

      if (state.orb.behaviors.particles && (state.orb.state === 'processing' || state.orb.intensity !== 'minimal')) {
        for (const p of orbConfig.particles) {
          p.angle += p.speed;
          const x = center.x + Math.cos(p.angle) * p.radius;
          const y = center.y + Math.sin(p.angle) * p.radius;
          ctx.beginPath();
          ctx.fillStyle = `hsla(${p.hue},100%,70%,0.6)`;
          ctx.arc(x, y, p.size, 0, Math.PI*2);
          ctx.fill();
        }
      }
      requestAnimationFrame(drawOrb);
    }
    requestAnimationFrame(drawOrb);

    function setOrbState(s) {
      state.orb.state = s;
      const ringListening = $('#ringListening');
      const ringReady = $('#ringReady');
      ringListening.style.opacity = (s === 'listening' && state.orb.behaviors.rings) ? 1 : 0;
      ringReady.style.opacity = (s === 'ready' && state.orb.behaviors.radiant) ? 1 : 0;
    }

    // AI simulate
    async function simulateAI(prompt) {
      const delay = (ms) => new Promise(res => setTimeout(res, ms));
      const style = state.responseStyle;
      let content = generateContent(style, prompt);
      // simulate streaming typing
      let shown = '';
      const card = pushSalmarMessage(''); // create and fill progressively
      const p = card.querySelector('div.whitespace-pre-wrap');
      for (let i=0;i<content.length;i+= Math.ceil(Math.random()*12)) {
        shown = content.slice(0, i);
        p.textContent = shown;
        await delay(20 + Math.random()*40);
      }
      p.textContent = content;
      return content;
    }

    function generateContent(style, prompt) {
      const persona = personalities[state.personality];
      const modeFlavor = {
        knowledge: 'Clear references and factual precision.',
        creative: 'Imaginative, metaphor-rich, vibrant storytelling.',
        business: 'Outcome-oriented, risks and ROI highlighted.',
        security: 'Threat-aware, best practices and compliance-centric.',
        integrations: 'Ecosystem-aware, interoperable and modular.'
      }[state.mode];
      const preface = `(${persona} â€¢ ${state.aiMode} â€¢ ${modeFlavor})\n`;
      const base =
`Prompt: ${prompt}

Answer:
${style === 'concise' ? '- ' : ''}Salmar understands your intent and frames the result in the requested context.
${style === 'step' ? '1) Assess\n2) Plan\n3) Execute\n4) Validate' :
 style === 'detailed' ? 'â€¢ Background context\nâ€¢ Key considerations\nâ€¢ Actionable steps\nâ€¢ Caveats & next steps' :
 'Imagine a cosmic weave of ideas, threads of insight glowing in violet and magenta, guiding you elegantly to outcomes.'}
${state.memoryLongTerm ? 'Note: Long-term memory hints are applied.' : 'Note: Short-term context only.'}`;
      return preface + base;
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.key === '/' && document.activeElement !== chatInput) { e.preventDefault(); chatInput.focus(); }
      if (e.key === 'Escape') { closeDrawer(); closeCmdPalette(); }
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'k') { e.preventDefault(); openCmdPalette(); }
    });

    // Command palette
    const cmdPalette = $('#cmdPalette');
    function openCmdPalette(seed) { cmdPalette.classList.remove('hidden'); $('#cmdInput').focus(); if (seed) { $('#cmdInput').value = seed; renderCmdResults(seed); } }
    function closeCmdPalette() { cmdPalette.classList.add('hidden'); }
    $('#cmdClose').addEventListener('click', closeCmdPalette);
    cmdPalette.addEventListener('click', (e) => { if (e.target === cmdPalette) closeCmdPalette(); });
    const commands = [
      { name: 'New chat', action: newChat, icon: 'plus-circle' },
      { name: 'Upload file', action: ()=>$('#fileInput').click(), icon: 'folder-up' },
      { name: 'Voice command', action: ()=>$('#voiceBtn').click(), icon: 'mic' },
      { name: 'Open automations', action: openDrawer, icon: 'workflow' },
      { name: 'Toggle theme', action: ()=>$('#themeToggle').click(), icon: 'sun-moon' },
      { name: 'Help', action: ()=> pushSystemMessage('Open docs: help.salmar.ai'), icon: 'help-circle' },
    ];
    function renderCmdResults(q='') {
      const list = $('#cmdResults'); list.innerHTML = '';
      const match = q.toLowerCase();
      commands.filter(c => c.name.toLowerCase().includes(match)).forEach(c => {
        const item = el('button','btn glass px-3 py-2 rounded-xl flex items-center gap-2 text-left');
        item.innerHTML = `<i data-lucide="${c.icon}" class="w-5 h-5"></i><span>${c.name}</span>`;
        item.addEventListener('click', () => { c.action(); closeCmdPalette(); });
        list.appendChild(item);
      });
      lucide.createIcons();
    }
    $('#cmdInput').addEventListener('input', (e)=> renderCmdResults(e.target.value));

    // Workflow builder (drag+drop)
    const defaultSteps = ['Research','Summarize','Export','Email'];
    const workflow = $('#workflow');
    function renderWorkflow(steps = defaultSteps) {
      workflow.innerHTML = '';
      steps.forEach((name, idx) => {
        const step = el('div','glass px-3 py-2 rounded-xl flex items-center gap-2 cursor-move', { draggable: 'true' });
        step.innerHTML = `<i data-lucide="grip-vertical" class="w-4 h-4"></i><span>${name}</span>`;
        step.dataset.index = idx;
        step.addEventListener('dragstart', (e) => { e.dataTransfer.setData('text/plain', idx); step.classList.add('ring-2','ring-neon-violet/50'); });
        step.addEventListener('dragend', ()=> step.classList.remove('ring-2','ring-neon-violet/50'));
        step.addEventListener('dragover', (e)=> e.preventDefault());
        step.addEventListener('drop', (e) => {
          e.preventDefault();
          const from = +e.dataTransfer.getData('text/plain');
          const to = +step.dataset.index;
          moveStep(from, to);
        });
        workflow.appendChild(step);
      });
      lucide.createIcons();
    }
    function moveStep(from, to) {
      const steps = getSteps();
      const [sp] = steps.splice(from,1);
      steps.splice(to,0,sp);
      setSteps(steps);
      renderWorkflow(steps);
    }
    function getSteps() { return Array.from(workflow.querySelectorAll('span')).map(s=>s.textContent); }
    function setSteps(steps) { /* ephemeral only */ }

    $('#addStep').addEventListener('click', () => {
      const name = prompt('Add step name:');
      if (!name) return;
      const steps = getSteps();
      steps.push(name);
      renderWorkflow(steps);
    });
    $('#runWorkflow').addEventListener('click', async () => {
      const steps = getSteps();
      pushSystemMessage('Running workflow: ' + steps.join(' â†’ '));
      setOrbState('processing');
      for (const s of steps) {
        await new Promise(r=>setTimeout(r, 400));
        pushSalmarMessage(`Step "${s}" completed.\n${generateContent('concise', s)}`);
      }
      setOrbState('ready');
      setTimeout(()=> setOrbState('idle'), 800);
    });
    renderWorkflow();

    // Radial menu initial position
    positionRadialItems();

    // Dashboard nav
    $$('#dashboardMenu [data-nav]').forEach(btn => {
      btn.addEventListener('click', () => {
        const t = btn.dataset.nav;
        dashboardMenu.close();
        if (t === 'timeline') {
          pushSystemMessage('Opening Timelineâ€¦');
          openCmdPalette('timeline');
        } else if (t === 'integrations') {
          pushSystemMessage('Integrations available: Slack, Gmail, Notion, Drive.');
        } else {
          pushSystemMessage('AI Core focused.');
        }
      });
    });

    // Profile biometric toggle
    $('#toggleBiometric').addEventListener('click', () => $('#biometricToggle').click());

    // New chat
    function newChat() {
      chatScroll.innerHTML = '';
      pushSystemMessage('New chat ready.');
      setOrbState('ready');
      setTimeout(()=> setOrbState('idle'), 500);
    }

    // Accessibility announce
    const live = el('div','sr-only',{ role:'status','aria-live':'polite' });
    document.body.appendChild(live);
    function announce(msg) { live.textContent = ''; setTimeout(()=> live.textContent = msg, 10); }

    // Initial content
    (function bootstrap() {
      lucide.createIcons();
      pushSalmarMessage('Hello! I am Salmar â€” your cosmic AI companion. Ask me anything or open Advanced Options for full control.');
      addHistoryItem('Welcome tour');
      addHistoryItem('Market analysis draft');
      addHistoryItem('Security baseline checklist');
      // Tooltips
      tip($('#advancedBtn'), 'Open advanced controls');
      tip($('#themeToggle'), 'Toggle light/dark');
      tip($('#voiceBtn'), 'Voice input');
      tip($('#uploadBtn'), 'Upload files');
      tip($('#radialMain'), 'Quick actions');
      // Ensure orb accent
      accentOrbByMode();
    })();
  </script>
</body>
</html>