<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Salmar • Main AI Core (Advanced)</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet" />
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'ui-sans-serif', 'system-ui'] },
                    colors: {
                        cosmic: {
                            900: '#0b0a1a', 800: '#120f2b', 700: '#1b1540', 600: '#2a1e5c',
                            500: '#3b247d', 400: '#5e39ad', 300: '#8d6af2', 200: '#bba8ff', 100: '#e3ddff',
                        },
                        neon: {
                            violet: '#a45cff', magenta: '#ff2bd6', fuchsia: '#ff4edb',
                            lavender: '#c8b5ff', glow: '#b57bff'
                        },
                        mode: {
                            knowledge: '#2da3ff', creative: '#ff4edb', business: '#ffbd2e', security: '#23d18b'
                        }
                    },
                    boxShadow: {
                        glass: '0 8px 30px rgba(164,92,255,0.25)',
                        'violet-soft': '0 0 0 1px rgba(164,92,255,0.35), 0 10px 25px rgba(164,92,255,0.25)',
                        'lavender': '0 10px 30px rgba(200,181,255,0.25)',
                        'emerald': '0 10px 30px rgba(35,209,139,0.25)',
                    },
                    backdropBlur: { xs: '2px' },
                    keyframes: {
                        float: { '0%,100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-6px)' } },
                        pulseRing: { '0%': { transform: 'scale(0.8)', opacity: 0.7 }, '80%': { transform: 'scale(2.4)', opacity: 0 }, '100%': { opacity: 0 } },
                        spinSlow: { '0%': { transform: 'rotate(0)' }, '100%': { transform: 'rotate(360deg)' } },
                        glow: { '0%,100%': { filter: 'brightness(1)' }, '50%': { filter: 'brightness(1.3)' } },
                        sparkle: { '0%, 100%': { opacity: .25 }, '50%': { opacity: .8 } },
                    },
                    animation: {
                        float: 'float 6s ease-in-out infinite',
                        pulseRing: 'pulseRing 2.5s ease-out infinite',
                        spinSlow: 'spinSlow 24s linear infinite',
                        glow: 'glow 5s ease-in-out infinite',
                        sparkle: 'sparkle 4s ease-in-out infinite',
                    }
                }
            }
        }
    </script>
    <!-- GSAP -->
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js"></script>
    <!-- Tippy -->
    <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/themes/light.css" />
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@0.469.0/dist/umd/lucide.js"></script>
    <style>
        :root {
            --bg-start: #0b0a1a;
            --bg-mid: #1b1540;
            --bg-end: #0e0a24;
            --glass: rgba(255, 255, 255, 0.06);
            --glass-strong: rgba(255, 255, 255, 0.12);
            --text: #e7e2ff;
            --muted: #bba8ff;
            --border: rgba(164, 92, 255, 0.35);
            --glow: #a45cff;
            --focus: #b57bff;
            --card: rgba(18, 15, 43, 0.6);
            --card-strong: rgba(18, 15, 43, 0.9);
            --noise: rgba(255, 255, 255, 0.02);
            --listen: #23d18b;
            --talk: #ff4e4e;
            --font-scale: 1;
        }

        .theme-light {
            --bg-start: #f5f2ff;
            --bg-mid: #efe9ff;
            --bg-end: #f8f7ff;
            --glass: rgba(0, 0, 0, 0.05);
            --glass-strong: rgba(0, 0, 0, 0.08);
            --text: #1a1033;
            --muted: #4b3b7d;
            --border: rgba(110, 64, 183, 0.35);
            --glow: #7e3af2;
            --focus: #6d28d9;
            --card: rgba(255, 255, 255, 0.7);
            --card-strong: rgba(255, 255, 255, 0.95);
            --noise: rgba(0, 0, 0, 0.03);
        }

        html {
            height: 100%;
            font-size: calc(16px * var(--font-scale));
        }

        body {
            min-height: 100%;
            background:
                radial-gradient(1200px 800px at 10% 10%, rgba(164, 92, 255, 0.06), transparent 60%),
                linear-gradient(140deg, var(--bg-start), var(--bg-mid), var(--bg-end));
            color: var(--text);
        }

        /* Subtle noise overlay */
        .noise-overlay::before {
            content: '';
            position: fixed;
            inset: 0;
            pointer-events: none;
            background-image:
                radial-gradient(2px 2px at 20% 30%, var(--noise), transparent 40%),
                radial-gradient(2px 2px at 80% 10%, var(--noise), transparent 40%),
                radial-gradient(2px 2px at 50% 70%, var(--noise), transparent 40%),
                radial-gradient(1px 1px at 10% 90%, var(--noise), transparent 40%);
            mix-blend-mode: soft-light;
            z-index: 0;
            animation: sparkle 10s ease-in-out infinite;
        }

        /* Glass utilities */
        .glass {
            background: var(--glass);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            box-shadow: 0 10px 30px rgba(164, 92, 255, 0.18);
        }

        .glass-strong {
            background: var(--card);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--border);
            box-shadow: 0 18px 50px rgba(164, 92, 255, 0.25);
        }

        .neumorphic {
            box-shadow: 10px 10px 20px rgba(10, 6, 28, 0.65), -10px -10px 20px rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.03);
        }

        .btn {
            transition: transform .2s ease, box-shadow .2s ease, background-color .2s ease, border-color .2s ease;
        }

        .btn:focus-visible {
            outline: 2px solid var(--focus);
            outline-offset: 2px;
        }

        .btn:hover {
            transform: translateY(-1px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .glow-border {
            box-shadow: 0 0 0 1px var(--border), 0 0 22px rgba(164, 92, 255, 0.25);
        }

        .focus-glow:focus-within {
            box-shadow: 0 0 0 2px var(--glow), 0 0 26px rgba(164, 92, 255, .4);
        }

        /* Chat bubbles alignment */
        .message-user {
            justify-content: flex-end;
        }

        .message-salmar {
            justify-content: flex-start;
        }

        /* Scrollbars */
        *::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        *::-webkit-scrollbar-thumb {
            background: rgba(164, 92, 255, 0.35);
            border-radius: 10px;
        }

        *::-webkit-scrollbar-track {
            background: transparent;
        }

        /* Accessibility helpers */
        .sr-only-focusable:focus {
            position: static !important;
            width: auto !important;
            height: auto !important;
            clip: auto !important;
        }

        /* Lock copy */
        .no-copy,
        .no-copy * {
            user-select: none;
        }

        /* Orb canvas small */
        #orbCanvas {
            filter: drop-shadow(0 0 20px rgba(164, 92, 255, 0.6)) drop-shadow(0 0 40px rgba(255, 46, 214, 0.25));
        }

        /* Radial actions layout */
        .radial {
            position: fixed;
            right: 20px;
            bottom: 24px;
            z-index: 50;
        }

        .radial-item {
            position: absolute;
            opacity: 0;
            transform: translate(0, 0) scale(.8);
        }

        .radial-open .radial-item {
            opacity: 1;
            transform: scale(1);
        }

        /* Dropdown menu base */
        .menu {
            transform-origin: top center;
            transition: opacity .18s ease, transform .18s ease;
        }

        .menu[data-open="false"] {
            opacity: 0;
            pointer-events: none;
            transform: scale(0.98) translateY(-4px);
        }

        .menu[data-open="true"] {
            opacity: 1;
            transform: scale(1) translateY(0);
        }

        /* Fullscreen Voice Overlay */
        #voiceOverlay {
            position: fixed;
            inset: 0;
            z-index: 60;
            display: none;
            background:
                radial-gradient(800px 600px at 15% 15%, rgba(164, 92, 255, 0.12), transparent 60%),
                linear-gradient(160deg, var(--bg-start), var(--bg-mid), var(--bg-end));
        }

        #voiceOverlay.active {
            display: flex;
        }

        #voiceCanvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .overlay-ui {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }

        .overlay-top {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 16px;
        }

        .overlay-controls {
            pointer-events: auto;
        }

        .overlay-status {
            margin-top: 14px;
            padding: 8px 12px;
            border-radius: 9999px;
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            background: var(--glass-strong);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .overlay-bottom {
            position: absolute;
            left: 0;
            right: 0;
            bottom: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            gap: 10px;
            padding: 0 16px;
        }

        .overlay-transcript {
            max-width: min(900px, 90vw);
            border-radius: 16px;
            padding: 12px 16px;
            background: var(--glass);
            border: 1px solid var(--border);
            box-shadow: 0 10px 30px rgba(164, 92, 255, 0.18);
            pointer-events: auto;
            max-height: 40vh;
            overflow: auto;
        }

        /* Sidebar collapsed helper */
        #sidebar.collapsed .hide-when-collapsed {
            display: none !important;
        }

        #sidebar.collapsed .mode-btn {
            justify-content: center;
            padding-left: .5rem;
            padding-right: .5rem;
        }

        #sidebar.collapsed .section-pad {
            padding-left: .5rem !important;
            padding-right: .5rem !important;
        }

        /* Advanced Drawer v2 */
        #advancedDrawer {
            pointer-events: none;
        }

        .drawer-panel {
            transform: translateY(100%);
            transition: transform .3s ease;
        }

        .drawer-panel.open {
            transform: translateY(0);
        }

        .drawer-shell {
            max-height: 85vh;
            overflow: hidden;
            border-top-left-radius: 1.5rem;
            border-top-right-radius: 1.5rem;
        }

        .drawer-scroll {
            overflow-y: auto;
            max-height: calc(85vh - 64px);
            scroll-snap-type: y proximity;
        }

        .section-snap {
            scroll-snap-align: start;
        }

        /* Drawer quick nav */
        .quicknav a[aria-current="true"] {
            background: rgba(164, 92, 255, 0.22);
            box-shadow: 0 0 0 1px var(--border);
        }

        /* Drawer fades */
        .top-fade,
        .bottom-fade {
            position: sticky;
            height: 24px;
            pointer-events: none;
            z-index: 1;
        }

        .top-fade {
            top: 0;
            background: linear-gradient(180deg, var(--card-strong), transparent);
        }

        .bottom-fade {
            bottom: 0;
            background: linear-gradient(0deg, var(--card-strong), transparent);
        }

        /* Recorder modal */
        #recorderModal {
            position: fixed;
            inset: 0;
            z-index: 60;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.5);
        }

        #recorderModal.active {
            display: flex;
        }

        .rec-card {
            width: min(960px, 94vw);
        }

        .rec-video {
            width: 100%;
            aspect-ratio: 16 / 9;
            background: #000;
            border-radius: 16px;
            overflow: hidden;
        }

        .meter-bar {
            height: 8px;
            border-radius: 9999px;
            background: linear-gradient(90deg, #23d18b, #ffbd2e, #ff4e4e);
            transform: scaleX(0);
            transform-origin: left center;
            transition: transform .08s linear;
        }

        /* Generic modal */
        .modal {
            position: fixed;
            inset: 0;
            z-index: 60;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.5);
        }

        .modal.active {
            display: flex;
        }

        .modal-card {
            width: min(920px, 94vw);
        }

        /* Reduced motion toggleable */
        .reduce-motion *,
        .reduce-motion *::before,
        .reduce-motion *::after {
            animation: none !important;
            transition: none !important;
        }

        /* Right-fixed dropdown variant (no freeze) */
        .menu-right-fixed {
            position: fixed !important;
            right: 16px !important;
            transform-origin: top right !important;
            z-index: 56 !important;
        }

        /* High contrast tweak */
        .high-contrast {
            --border: rgba(255, 255, 255, 0.6);
            --glass: rgba(255, 255, 255, 0.12);
            --glass-strong: rgba(255, 255, 255, 0.18);
        }

        /* Toasts */
        #toastContainer {
            pointer-events: none;
        }

        .toast {
            pointer-events: auto;
        }
    </style>
</head>

<body class="font-sans antialiased noise-overlay selection:bg-neon-violet/30">
    <a href="#main" class="sr-only sr-only-focusable bg-cosmic-700 text-white px-3 py-2 rounded-md">Skip to content</a>

    <!-- Toast Container -->
    <div id="toastContainer" class="fixed bottom-4 left-4 z-[70] space-y-2 max-w-md"></div>

    <!-- Top Navigation -->
    <header class="relative z-40">
        <nav
            class="glass backdrop-blur-md neumorphic mx-3 mt-3 rounded-2xl px-4 lg:px-6 py-3 flex items-center justify-between">
            <!-- Left: Orb Logo (Home) -->
            <a href="#" id="homeLink" class="flex items-center gap-3 group" aria-label="Salmar home">
                <div class="relative">
                    <div
                        class="h-9 w-9 rounded-full bg-gradient-to-br from-neon-violet to-neon-magenta animate-glow shadow-violet-soft flex items-center justify-center">
                        <div class="h-6 w-6 rounded-full bg-white/10 border border-white/20 backdrop-blur-xs"></div>
                    </div>
                    <div class="absolute inset-0 rounded-full animate-pulseRing bg-neon-violet/30"></div>
                </div>
                <span class="text-lg font-semibold tracking-wide">Salmar</span>
            </a>
            <!-- Center: Dashboard dropdown -->
            <div class="relative">
                <button id="dashboardBtn"
                    class="btn glass-strong px-4 py-2 rounded-xl flex items-center gap-2 hover:shadow-violet-soft"
                    aria-haspopup="true" aria-expanded="false" aria-controls="dashboardMenu">
                    <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                    <span class="hidden sm:inline">Dashboard</span>
                    <i data-lucide="chevron-down" class="w-4 h-4"></i>
                </button>
                <div id="dashboardMenu"
                    class="menu absolute left-1/2 -translate-x-1/2 mt-2 w-56 glass-strong rounded-xl p-2"
                    data-open="false" role="menu">
                    <button class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/5 flex items-center gap-2"
                        role="menuitem" data-nav="core">
                        <i data-lucide="cpu" class="w-4 h-4"></i> AI Core
                    </button>
                    <button class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/5 flex items-center gap-2"
                        role="menuitem" data-nav="timeline">
                        <i data-lucide="timeline" class="w-4 h-4"></i> Timeline
                    </button>
                    <button class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/5 flex items-center gap-2"
                        role="menuitem" data-nav="integrations">
                        <i data-lucide="plug" class="w-4 h-4"></i> Integrations
                    </button>
                </div>
            </div>
            <!-- Right: Help, Theme, Profile -->
            <div class="flex items-center gap-2">
                <button id="helpBtn" class="btn glass px-3 py-2 rounded-xl hover:shadow-lavender" aria-label="Help">
                    <i data-lucide="help-circle" class="w-5 h-5"></i>
                </button>
                <button id="themeToggle" class="btn glass px-3 py-2 rounded-xl hover:shadow-lavender"
                    aria-label="Toggle theme">
                    <i data-lucide="sun-moon" class="w-5 h-5"></i>
                </button>
                <div class="relative">
                    <button id="profileBtn"
                        class="btn glass-strong px-3 py-2 rounded-xl flex items-center gap-2 hover:shadow-violet-soft"
                        aria-haspopup="true" aria-expanded="false" aria-controls="profileMenu">
                        <div id="biometricDot" class="h-2.5 w-2.5 rounded-full bg-gray-400 shadow-inner"></div>
                        <span class="hidden sm:inline">Profile</span>
                        <i data-lucide="chevron-down" class="w-4 h-4"></i>
                    </button>
                    <div id="profileMenu" class="menu absolute right-0 mt-2 w-64 glass-strong rounded-xl p-2"
                        data-open="false" role="menu">
                        <div class="px-3 py-2">
                            <div class="font-semibold">Signed in as</div>
                            <div id="profileEmailText" class="text-sm opacity-80">user@salmar.ai</div>
                        </div>
                        <div class="my-1 border-t border-white/10"></div>
                        <button
                            class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/5 flex items-center justify-between"
                            role="menuitem" id="openSettings">
                            <span class="flex items-center gap-2">
                                <i data-lucide="settings" class="w-4 h-4"></i>
                                Settings
                            </span>
                        </button>
                        <button
                            class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/5 flex items-center justify-between"
                            role="menuitem" id="toggleBiometric">
                            <span class="flex items-center gap-2">
                                <i data-lucide="scan-face" class="w-4 h-4"></i>
                                Biometric glow
                            </span>
                            <span class="text-xs opacity-80">Auto</span>
                        </button>
                        <button class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/5 flex items-center gap-2"
                            role="menuitem" id="menuFeedback">
                            <i data-lucide="message-circle" class="w-4 h-4"></i> Send feedback
                        </button>
                        <button class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/5 flex items-center gap-2"
                            role="menuitem" id="logoutBtn">
                            <i data-lucide="log-out" class="w-4 h-4"></i> Sign out
                        </button>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <div class="flex">
        <!-- Sidebar -->
        <aside id="sidebar"
            class="glass-strong neumorphic relative z-30 mt-3 ml-3 rounded-2xl w-72 max-w-[80vw] transition-all duration-300 overflow-hidden"
            aria-label="Sidebar with modes and history">
            <div class="flex items-center justify-between px-4 py-3 border-b border-white/10">
                <div class="flex items-center gap-2">
                    <i data-lucide="panel-left" class="w-5 h-5"></i>
                    <span class="font-semibold hide-when-collapsed">Control Center</span>
                </div>
                <button id="sidebarToggle" class="btn glass px-2 py-2 rounded-lg" aria-label="Toggle sidebar width"
                    aria-pressed="false">
                    <i data-lucide="chevrons-left-right" class="w-4 h-4"></i>
                </button>
            </div>
            <!-- Modes -->
            <section class="px-4 py-3 section-pad">
                <h2 class="text-sm uppercase tracking-wider opacity-70 mb-2 hide-when-collapsed">Modes</h2>
                <div class="grid grid-cols-2 gap-2">
                    <button
                        class="btn rounded-xl glass px-3 py-2 flex items-center gap-2 hover:shadow-lavender mode-btn"
                        data-mode="knowledge" aria-pressed="false">
                        <span class="h-2 w-2 rounded-full" style="background:#2da3ff"></span>
                        <span class="hide-when-collapsed">Knowledge</span>
                    </button>
                    <button
                        class="btn rounded-xl glass px-3 py-2 flex items-center gap-2 hover:shadow-lavender mode-btn"
                        data-mode="creative" aria-pressed="false">
                        <span class="h-2 w-2 rounded-full" style="background:#ff4edb"></span>
                        <span class="hide-when-collapsed">Creative</span>
                    </button>
                    <button
                        class="btn rounded-xl glass px-3 py-2 flex items-center gap-2 hover:shadow-lavender mode-btn"
                        data-mode="business" aria-pressed="false">
                        <span class="h-2 w-2 rounded-full" style="background:#ffbd2e"></span>
                        <span class="hide-when-collapsed">Business</span>
                    </button>
                    <button
                        class="btn rounded-xl glass px-3 py-2 flex items-center gap-2 hover:shadow-lavender mode-btn"
                        data-mode="security" aria-pressed="false">
                        <span class="h-2 w-2 rounded-full" style="background:#23d18b"></span>
                        <span class="hide-when-collapsed">Security</span>
                    </button>
                    <button
                        class="btn rounded-xl glass px-3 py-2 col-span-2 flex items-center gap-2 hover:shadow-lavender mode-btn"
                        data-mode="integrations" aria-pressed="false">
                        <span class="h-2 w-2 rounded-full bg-white/50"></span>
                        <span class="hide-when-collapsed">Integrations</span>
                    </button>
                </div>
            </section>
            <!-- History -->
            <section class="px-4 py-3 border-t border-white/10 section-pad">
                <div class="flex items-center justify-between mb-2">
                    <h2 class="text-sm uppercase tracking-wider opacity-70 hide-when-collapsed">History</h2>
                    <div class="flex items-center gap-1">
                        <button id="historyNewBtn" class="btn glass h-8 w-8 rounded-lg" aria-label="New chat">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                        </button>
                        <button id="historyShareAllBtn" class="btn glass h-8 w-8 rounded-lg" aria-label="Share history">
                            <i data-lucide="share-2" class="w-4 h-4"></i>
                        </button>
                        <div class="relative">
                            <button id="historyMenuBtn" class="btn glass h-8 w-8 rounded-lg" aria-haspopup="true"
                                aria-expanded="false" aria-controls="historyMenu" aria-label="History actions">
                                <i data-lucide="more-vertical" class="w-4 h-4"></i>
                            </button>
                            <!-- Right-fixed menu (no freeze) -->
                            <div id="historyMenu" class="menu absolute right-0 mt-2 w-56 glass-strong rounded-xl p-2"
                                data-open="false" role="menu">
                                <button
                                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/5 flex items-center gap-2"
                                    role="menuitem" id="historyExportBtn">
                                    <i data-lucide="download" class="w-4 h-4"></i>
                                    Export JSON
                                </button>
                                <button
                                    class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/5 flex items-center gap-2"
                                    role="menuitem" id="historyClearBtn">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                    Clear history
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="historyList" class="space-y-2 max-h-56 overflow-auto pr-1" role="list"></div>
                <button id="historyViewAll"
                    class="btn glass mt-3 w-full px-3 py-2 rounded-xl flex items-center justify-center gap-2">
                    <i data-lucide="list" class="w-4 h-4"></i> <span>View all</span>
                </button>
            </section>
            <!-- Personality -->
            <section class="px-4 py-3 border-t border-white/10 section-pad">
                <h2 class="text-sm uppercase tracking-wider opacity-70 mb-3 hide-when-collapsed">Personality</h2>
                <div class="space-y-3">
                    <div class="flex items-center justify-between text-xs opacity-75 hide-when-collapsed">
                        <span>Professional</span><span>Friendly</span><span>Visionary</span><span>Technical</span>
                    </div>
                    <input id="personality" type="range" min="0" max="3" step="1" value="0"
                        class="w-full accent-neon-violet" aria-label="AI Personality Slider" />
                    <div id="personalityLabel" class="text-sm text-neon-lavender hide-when-collapsed">Professional</div>
                </div>
            </section>
        </aside>

        <!-- Main -->
        <main id="main" class="relative flex-1 min-h-[calc(100vh-96px)] mt-3 mr-3">
            <!-- Chat Container -->
            <section
                class="glass-strong neumorphic rounded-2xl w-full h-[calc(100vh-140px)] flex flex-col overflow-hidden relative"
                aria-label="Salmar AI Core Chat">
                <!-- Orb floating container -->
                <div class="absolute inset-x-0 top-4 flex items-center justify-center pointer-events-none">
                    <div class="relative w-40 h-40 flex items-center justify-center">
                        <canvas id="orbCanvas" width="240" height="240" class="orb-anim"></canvas>
                        <!-- State rings with color semantics -->
                        <div id="ringListening" class="absolute inset-0 rounded-full border-2"
                            style="border-color: color-mix(in srgb, var(--listen) 70%, transparent);"></div>
                        <div id="ringSpeaking" class="absolute inset-0 rounded-full border-2 opacity-0"
                            style="border-color: color-mix(in srgb, var(--talk) 70%, transparent);"></div>
                        <div id="ringReady" class="absolute inset-0 rounded-full bg-neon-violet/20 blur-xl opacity-0">
                        </div>
                    </div>
                </div>
                <!-- Conversation -->
                <div id="chatScroll" class="mt-40 flex-1 overflow-auto px-4 sm:px-6 py-6 space-y-4"></div>
                <!-- Input Bar -->
                <form id="chatForm" class="relative px-4 sm:px-6 pb-5">
                    <div class="glass-strong rounded-2xl glow-border focus-glow p-2 sm:p-3 flex flex-col gap-2">
                        <div class="flex items-center gap-2">
                            <!-- Voice/Video Multifunction -->
                            <div class="relative">
                                <button type="button" id="voiceBtn" class="btn glass px-3 py-2 rounded-xl"
                                    aria-label="Voice & Video options" aria-haspopup="true" aria-expanded="false"
                                    aria-controls="voiceMenu">
                                    <i data-lucide="mic" class="w-5 h-5"></i>
                                </button>
                                <!-- Voice/Video menu -->
                                <div id="voiceMenu" class="menu absolute left-0 mt-2 w-56 glass-strong rounded-xl p-2"
                                    data-open="false" role="menu" aria-label="Voice and video options">
                                    <button
                                        class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/5 flex items-center gap-2"
                                        role="menuitem" id="menuRecordVideo">
                                        <i data-lucide="video" class="w-4 h-4"></i> Record video (cam + mic)
                                    </button>
                                    <button
                                        class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/5 flex items-center gap-2"
                                        role="menuitem" id="menuRecordAudio">
                                        <i data-lucide="audio-lines" class="w-4 h-4"></i> Record audio only
                                    </button>
                                    <button
                                        class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/5 flex items-center gap-2"
                                        role="menuitem" id="menuDictate">
                                        <i data-lucide="type" class="w-4 h-4"></i> Voice dictation (text)
                                    </button>
                                    <button
                                        class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/5 flex items-center gap-2"
                                        role="menuitem" id="menuVoiceOrb">
                                        <i data-lucide="radio" class="w-4 h-4"></i> Open voice orb
                                    </button>
                                </div>
                            </div>
                            <button type="button" id="uploadBtn" class="btn glass px-3 py-2 rounded-xl"
                                aria-label="Upload file">
                                <i data-lucide="paperclip" class="w-5 h-5"></i>
                            </button>
                            <div class="relative flex-1">
                                <label for="chatInput" class="sr-only">Ask me anything</label>
                                <textarea id="chatInput" rows="1"
                                    class="w-full bg-transparent resize-none outline-none text-base sm:text-lg placeholder:opacity-60"
                                    placeholder="Ask me anything…" aria-multiline="true"></textarea>
                            </div>
                            <!-- Send -->
                            <button type="submit" id="sendBtn"
                                class="btn px-3 py-2 rounded-xl bg-gradient-to-r from-neon-violet to-neon-magenta text-white shadow-violet-soft hover:shadow-lavender"
                                aria-label="Send">
                                <i data-lucide="send" class="w-5 h-5"></i>
                            </button>
                        </div>
                        <div class="flex items-center justify-between">
                            <button type="button" id="advancedBtn"
                                class="btn glass px-3 py-2 rounded-xl flex items-center gap-2">
                                <i data-lucide="settings-2" class="w-5 h-5"></i>
                                <span class="hidden xs:inline">Advanced Options</span>
                            </button>
                            <div class="text-xs opacity-70">Enter = Send • Shift+Enter = New line • / = Focus</div>
                        </div>
                    </div>
                    <input id="fileInput" type="file" class="hidden"
                        accept=".txt,.md,.pdf,.png,.jpg,.jpeg,.json,.mp4,.webm,.mov,.mp3,.wav" />
                </form>
            </section>

            <!-- Advanced Drawer -->
            <section id="advancedDrawer" class="fixed left-1/2 -translate-x-1/2 bottom-0 w-[min(1200px,96vw)] z-40">
                <div class="drawer-panel glass-strong neumorphic drawer-shell border-t border-white/10"
                    aria-hidden="true">
                    <!-- Header -->
                    <div class="px-5 py-4 flex items-center justify-between sticky top-0 z-10"
                        style="background: var(--card-strong); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border);">
                        <div class="flex items-center gap-2">
                            <i data-lucide="sliders" class="w-5 h-5"></i>
                            <h3 class="font-semibold text-lg">Advanced Controls</h3>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="hidden sm:flex items-center gap-2 glass px-2 py-1.5 rounded-xl">
                                <i data-lucide="search" class="w-4 h-4 opacity-80"></i>
                                <input id="advSearch" type="text" class="bg-transparent outline-none text-sm"
                                    placeholder="Search settings…" />
                            </div>
                            <button id="advExport" class="btn glass px-3 py-2 rounded-xl flex items-center gap-2"
                                aria-label="Export settings">
                                <i data-lucide="download" class="w-4 h-4"></i><span
                                    class="hidden sm:inline">Export</span>
                            </button>
                            <button id="advImport" class="btn glass px-3 py-2 rounded-xl flex items-center gap-2"
                                aria-label="Import settings">
                                <i data-lucide="upload" class="w-4 h-4"></i><span class="hidden sm:inline">Import</span>
                            </button>
                            <button id="drawerClose" class="btn glass px-3 py-2 rounded-xl" aria-label="Close advanced">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                    <!-- Scroll area -->
                    <div class="relative">
                        <div class="top-fade"></div>
                        <div class="drawer-scroll px-5 pb-6 grid grid-cols-1 lg:grid-cols-4 gap-4">
                            <!-- Main settings (3 cols) -->
                            <div class="lg:col-span-3 space-y-4">
                                <!-- Response Style -->
                                <div id="sec-response-style" class="section-snap glass rounded-2xl p-4">
                                    <h4 class="text-sm uppercase tracking-wider opacity-70 mb-3">Response Style</h4>
                                    <div id="responseStyle" class="grid grid-cols-2 sm:grid-cols-4 gap-2" role="group"
                                        aria-label="Response style">
                                        <button
                                            class="btn glass px-3 py-2 rounded-xl aria-selected ring-1 ring-neon-violet/50"
                                            data-value="concise">Concise</button>
                                        <button class="btn glass px-3 py-2 rounded-xl"
                                            data-value="detailed">Detailed</button>
                                        <button class="btn glass px-3 py-2 rounded-xl"
                                            data-value="step">Step-by-step</button>
                                        <button class="btn glass px-3 py-2 rounded-xl"
                                            data-value="creative">Creative</button>
                                    </div>
                                </div>
                                <!-- Output Format -->
                                <div id="sec-output-format" class="section-snap glass rounded-2xl p-4">
                                    <h4 class="text-sm uppercase tracking-wider opacity-70 mb-3">Output Format</h4>
                                    <div id="outputFormat" class="grid grid-cols-3 sm:grid-cols-5 gap-2">
                                        <label
                                            class="glass px-3 py-2 rounded-xl flex items-center gap-2 cursor-pointer">
                                            <input type="radio" name="format" value="md" class="accent-neon-violet"
                                                checked />
                                            <span>Markdown</span>
                                        </label>
                                        <label
                                            class="glass px-3 py-2 rounded-xl flex items-center gap-2 cursor-pointer">
                                            <input type="radio" name="format" value="json" class="accent-neon-violet" />
                                            <span>JSON</span>
                                        </label>
                                        <label
                                            class="glass px-3 py-2 rounded-xl flex items-center gap-2 cursor-pointer">
                                            <input type="radio" name="format" value="pdf" class="accent-neon-violet" />
                                            <span>PDF</span>
                                        </label>
                                        <label
                                            class="glass px-3 py-2 rounded-xl flex items-center gap-2 cursor-pointer">
                                            <input type="radio" name="format" value="docx" class="accent-neon-violet" />
                                            <span>DOCX</span>
                                        </label>
                                        <label
                                            class="glass px-3 py-2 rounded-xl flex items-center gap-2 cursor-pointer">
                                            <input type="radio" name="format" value="pptx" class="accent-neon-violet" />
                                            <span>PPTX</span>
                                        </label>
                                    </div>
                                </div>
                                <!-- AI Modes -->
                                <div id="sec-ai-modes" class="section-snap glass rounded-2xl p-4">
                                    <h4 class="text-sm uppercase tracking-wider opacity-70 mb-3">AI Modes</h4>
                                    <div id="aiModes" class="flex flex-wrap gap-2">
                                        <button class="btn glass px-3 py-2 rounded-xl ring-1 ring-neon-violet/50"
                                            data-value="smart">Smart</button>
                                        <button class="btn glass px-3 py-2 rounded-xl" data-value="deep">Deep
                                            Dive</button>
                                        <button class="btn glass px-3 py-2 rounded-xl"
                                            data-value="creative">Creative</button>
                                        <button class="btn glass px-3 py-2 rounded-xl"
                                            data-value="action">Action</button>
                                    </div>
                                </div>
                                <!-- Security -->
                                <div id="sec-security" class="section-snap glass rounded-2xl p-4">
                                    <h4 class="text-sm uppercase tracking-wider opacity-70 mb-3">Security Controls</h4>
                                    <div class="space-y-2">
                                        <label class="flex items-center gap-3">
                                            <input id="biometricToggle" type="checkbox" class="accent-emerald-400" />
                                            <span>Biometric re-auth</span>
                                        </label>
                                        <label class="flex items-center gap-3">
                                            <input id="encryptedToggle" type="checkbox" class="accent-emerald-400" />
                                            <span>Encrypted responses</span>
                                        </label>
                                        <label class="flex items-center gap-3">
                                            <input id="lockToggle" type="checkbox" class="accent-emerald-400" />
                                            <span>Lock outputs</span>
                                        </label>
                                        <label class="flex items-center gap-3">
                                            <input id="piiToggle" type="checkbox" class="accent-emerald-400" />
                                            <span>PII redaction</span>
                                        </label>
                                        <div class="mt-2">
                                            <div class="text-sm opacity-80 mb-1">Safety Level</div>
                                            <input id="safetyLevel" type="range" min="1" max="3" step="1" value="2"
                                                class="w-full accent-emerald-400" />
                                            <div class="text-xs opacity-70 mt-1">1 = Permissive • 2 = Balanced • 3 =
                                                Strict</div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Collaboration -->
                                <div id="sec-collab" class="section-snap glass rounded-2xl p-4"
                                    aria-labelledby="collabCard">
                                    <h4 class="text-sm uppercase tracking-wider mb-3">Collaboration</h4>
                                    <!-- Invite row -->
                                    <div class="flex items-center gap-2">
                                        <input id="inviteInput" type="text" placeholder="Name or email…"
                                            class="flex-1 bg-transparent glass px-3 py-2 rounded-xl outline-none" />
                                        <select id="inviteRole" class="glass px-3 py-2 rounded-xl">
                                            <option>Viewer</option>
                                            <option selected>Editor</option>
                                            <option>Owner</option>
                                        </select>
                                        <button id="inviteBtn"
                                            class="btn glass px-3 py-2 rounded-xl flex items-center gap-2"
                                            aria-label="Invite teammate">
                                            <i data-lucide="plus" class="w-4 h-4"></i><span
                                                class="hidden sm:inline">Invite</span>
                                        </button>
                                    </div>
                                    <!-- Avatars -->
                                    <div class="flex -space-x-2 my-3">
                                        <img alt="Ava" src="https://picsum.photos/seed/ava/40"
                                            class="h-8 w-8 rounded-full ring-2 ring-white/30" />
                                        <img alt="Ben" src="https://picsum.photos/seed/ben/40"
                                            class="h-8 w-8 rounded-full ring-2 ring-white/30" />
                                        <img alt="Kai" src="https://picsum.photos/seed/kai/40"
                                            class="h-8 w-8 rounded-full ring-2 ring-white/30" />
                                    </div>
                                    <!-- Roster -->
                                    <div class="text-xs opacity-75 mb-2">Team</div>
                                    <div id="collabList" class="space-y-2" role="list"></div>
                                    <div class="text-xs opacity-75 mt-3">Quick Roles</div>
                                    <div class="mt-2 grid grid-cols-3 gap-2">
                                        <button id="roleViewer"
                                            class="btn glass px-2 py-1.5 rounded-lg text-sm">Viewer</button>
                                        <button id="roleEditor"
                                            class="btn glass px-2 py-1.5 rounded-lg text-sm">Editor</button>
                                        <button id="roleOwner"
                                            class="btn glass px-2 py-1.5 rounded-lg text-sm">Owner</button>
                                    </div>
                                </div>
                                <!-- Memory -->
                                <div id="sec-memory" class="section-snap glass rounded-2xl p-4">
                                    <h4 class="text-sm uppercase tracking-wider opacity-70 mb-3">Memory</h4>
                                    <div class="flex items-center gap-3">
                                        <span class="text-sm opacity-80 w-28">Short-term</span>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input id="memoryToggle" type="checkbox" class="sr-only peer">
                                            <div
                                                class="w-12 h-6 bg-white/20 rounded-full peer peer-checked:bg-neon-violet transition-colors">
                                            </div>
                                            <span
                                                class="absolute left-1 top-1 h-4 w-4 bg-white rounded-full transition-transform peer-checked:translate-x-6"></span>
                                        </label>
                                        <span class="text-sm opacity-80">Long-term</span>
                                    </div>
                                    <div class="mt-3">
                                        <div class="text-sm opacity-80 mb-1">Context Window</div>
                                        <input id="ctxWindow" type="range" min="1" max="4" step="1" value="2"
                                            class="w-full accent-neon-violet" />
                                        <div class="text-xs opacity-70 mt-1">Small • Medium • Large • Max</div>
                                    </div>
                                </div>
                                <!-- Task Automations -->
                                <div id="sec-automations" class="section-snap glass rounded-2xl p-4">
                                    <h4 class="text-sm uppercase tracking-wider opacity-70 mb-3">Task Automations</h4>
                                    <div id="workflow" class="flex items-center gap-3 overflow-x-auto pb-2"></div>
                                    <div class="flex items-center gap-2 mt-3 flex-wrap">
                                        <button id="addStep" class="btn glass px-3 py-2 rounded-xl">
                                            <i data-lucide="plus" class="w-4 h-4"></i> Add Step
                                        </button>
                                        <button id="runWorkflow"
                                            class="btn px-3 py-2 rounded-xl bg-gradient-to-r from-neon-violet to-neon-magenta text-white">Run
                                            Workflow</button>
                                        <button id="exportWorkflow" class="btn glass px-3 py-2 rounded-xl">
                                            <i data-lucide="download" class="w-4 h-4"></i> Export
                                        </button>
                                        <button id="importWorkflow" class="btn glass px-3 py-2 rounded-xl">
                                            <i data-lucide="upload" class="w-4 h-4"></i> Import
                                        </button>
                                        <label class="flex items-center gap-2 ml-auto">
                                            <input id="autorunWorkflow" type="checkbox" class="accent-neon-violet" />
                                            <span class="text-sm opacity-80">Auto-run on next message</span>
                                        </label>
                                    </div>
                                    <div id="workflowProgress" class="mt-3 hidden">
                                        <div class="w-full h-2 rounded-full bg-white/10 overflow-hidden">
                                            <div id="workflowBar" class="h-2 w-0 bg-neon-violet transition-all"></div>
                                        </div>
                                        <div id="workflowStatus" class="text-xs opacity-75 mt-1">Preparing…</div>
                                    </div>
                                </div>
                                <!-- Orb Settings -->
                                <div id="sec-orb" class="section-snap glass rounded-2xl p-4">
                                    <h4 class="text-sm uppercase tracking-wider opacity-70 mb-3">Salmar Orb Settings
                                    </h4>
                                    <div class="space-y-3">
                                        <div>
                                            <div class="text-sm mb-2">Animation Intensity</div>
                                            <div id="orbIntensity" class="flex gap-2">
                                                <button class="btn glass px-3 py-2 rounded-xl"
                                                    data-value="minimal">Minimal</button>
                                                <button
                                                    class="btn glass px-3 py-2 rounded-xl ring-1 ring-neon-violet/50"
                                                    data-value="balanced">Balanced</button>
                                                <button class="btn glass px-3 py-2 rounded-xl"
                                                    data-value="expressive">Expressive</button>
                                            </div>
                                        </div>
                                        <div>
                                            <div class="text-sm mb-2">Glow Behaviors</div>
                                            <div class="flex flex-wrap gap-2">
                                                <label
                                                    class="glass px-3 py-2 rounded-xl flex items-center gap-2 cursor-pointer">
                                                    <input type="checkbox" class="accent-neon-violet" checked
                                                        id="gbRings" />
                                                    <span>Rings (Listening)</span>
                                                </label>
                                                <label
                                                    class="glass px-3 py-2 rounded-xl flex items-center gap-2 cursor-pointer">
                                                    <input type="checkbox" class="accent-neon-violet" checked
                                                        id="gbParticles" />
                                                    <span>Particles (Processing)</span>
                                                </label>
                                                <label
                                                    class="glass px-3 py-2 rounded-xl flex items-center gap-2 cursor-pointer">
                                                    <input type="checkbox" class="accent-neon-violet" checked
                                                        id="gbRadiant" />
                                                    <span>Radiant Glow (Ready)</span>
                                                </label>
                                            </div>
                                        </div>
                                        <label class="flex items-center gap-3">
                                            <input id="soundToggle" type="checkbox" class="accent-neon-violet" />
                                            <span>Sound feedback</span>
                                        </label>
                                    </div>
                                </div>
                                <!-- Style Refinements -->
                                <div id="sec-style" class="section-snap glass rounded-2xl p-4">
                                    <h4 class="text-sm uppercase tracking-wider opacity-70 mb-3">Style Refinements</h4>
                                    <label class="flex items-center gap-3">
                                        <input id="humanizeToggle" type="checkbox" class="accent-neon-violet" />
                                        <span>Humanize responses</span>
                                    </label>
                                    <div class="mt-3">
                                        <div class="text-sm opacity-80 mb-1">Generation Speed</div>
                                        <input id="genSpeed" type="range" min="1" max="5" step="1" value="3"
                                            class="w-full accent-neon-violet" />
                                        <div class="text-xs opacity-70 mt-1">1 = Slow & vivid • 3 = Balanced • 5 = Fast
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Quick nav (1 col) -->
                            <div class="lg:col-span-1">
                                <div class="glass rounded-2xl p-3 sticky top-20 quicknav">
                                    <div class="text-xs uppercase opacity-70 mb-2">Sections</div>
                                    <nav class="grid gap-2 text-sm">
                                        <a href="#sec-response-style"
                                            class="btn glass px-3 py-2 rounded-xl block text-left">Response Style</a>
                                        <a href="#sec-output-format"
                                            class="btn glass px-3 py-2 rounded-xl block text-left">Output Format</a>
                                        <a href="#sec-ai-modes"
                                            class="btn glass px-3 py-2 rounded-xl block text-left">AI Modes</a>
                                        <a href="#sec-security"
                                            class="btn glass px-3 py-2 rounded-xl block text-left">Security</a>
                                        <a href="#sec-collab"
                                            class="btn glass px-3 py-2 rounded-xl block text-left">Collaboration</a>
                                        <a href="#sec-memory"
                                            class="btn glass px-3 py-2 rounded-xl block text-left">Memory</a>
                                        <a href="#sec-automations"
                                            class="btn glass px-3 py-2 rounded-xl block text-left">Automations</a>
                                        <a href="#sec-orb"
                                            class="btn glass px-3 py-2 rounded-xl block text-left">Orb</a>
                                        <a href="#sec-style"
                                            class="btn glass px-3 py-2 rounded-xl block text-left">Style</a>
                                    </nav>
                                    <div class="mt-3 grid grid-cols-2 gap-2">
                                        <button id="jumpTop" class="btn glass px-3 py-2 rounded-xl"><i
                                                data-lucide="chevron-up" class="w-4 h-4"></i> Top</button>
                                        <button id="jumpBottom" class="btn glass px-3 py-2 rounded-xl"><i
                                                data-lucide="chevron-down" class="w-4 h-4"></i> Bottom</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="bottom-fade"></div>
                    </div>
                </div>
            </section>

            <!-- Floating Radial Action Orb -->
            <div id="radial" class="radial">
                <button id="radialMain"
                    class="btn rounded-full h-14 w-14 bg-gradient-to-br from-neon-violet to-neon-magenta text-white shadow-violet-soft flex items-center justify-center"
                    aria-label="Quick actions">
                    <i data-lucide="sparkles" class="w-6 h-6"></i>
                </button>
                <button class="radial-item btn glass h-12 w-12 rounded-full flex items-center justify-center"
                    data-action="new" aria-label="New chat">
                    <i data-lucide="plus-circle" class="w-5 h-5"></i>
                </button>
                <button class="radial-item btn glass h-12 w-12 rounded-full flex items-center justify-center"
                    data-action="upload" aria-label="Upload">
                    <i data-lucide="folder-up" class="w-5 h-5"></i>
                </button>
                <button class="radial-item btn glass h-12 w-12 rounded-full flex items-center justify-center"
                    data-action="voice" aria-label="Voice">
                    <i data-lucide="mic" class="w-5 h-5"></i>
                </button>
                <button class="radial-item btn glass h-12 w-12 rounded-full flex items-center justify-center"
                    data-action="collab" aria-label="Collaboration">
                    <i data-lucide="users" class="w-5 h-5"></i>
                </button>
                <button class="radial-item btn glass h-12 w-12 rounded-full flex items-center justify-center"
                    data-action="auto" aria-label="Automations">
                    <i data-lucide="workflow" class="w-5 h-5"></i>
                </button>
            </div>

            <!-- Footer -->
            <footer class="mt-3">
                <div class="glass rounded-2xl px-4 py-3 flex flex-col sm:flex-row items-center justify-between">
                    <div class="flex items-center gap-4 text-sm opacity-80">
                        <a href="helpcenter.html" class="hover:opacity-100">Help Center</a>
                        <a href="report.html" class="hover:opacity-100">Report Issue</a>
                        <a href="securitystatus.html" class="hover:opacity-100">Security Status</a>
                    </div>
                    <div class="text-sm opacity-80">The Future is Purple. The Future is Salmar.</div>
                </div>
            </footer>
        </main>
    </div>

    <!-- Command Palette -->
    <div id="cmdPalette" class="fixed inset-0 bg-black/40 hidden items-start justify-center pt-20 z-50" role="dialog"
        aria-modal="true" aria-label="Command palette">
        <div class="glass-strong rounded-2xl w-[min(720px,90vw)] p-3">
            <div class="flex items-center gap-2 px-2 py-2 rounded-xl glass focus-glow">
                <i data-lucide="search" class="w-5 h-5 opacity-80"></i>
                <input id="cmdInput" type="text"
                    placeholder="Type a command… (e.g., new chat, voice, upload, automations)"
                    class="w-full bg-transparent outline-none py-2" />
                <button id="cmdClose" class="btn glass px-2 py-2 rounded-lg" aria-label="Close command palette">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            </div>
            <div id="cmdResults" class="mt-3 grid gap-2"></div>
        </div>
    </div>

    <!-- Fullscreen Voice Orb Overlay -->
    <div id="voiceOverlay" role="dialog" aria-modal="true" aria-label="Voice Orb">
        <canvas id="voiceCanvas"></canvas>
        <div class="overlay-ui">
            <div class="overlay-top">
                <div class="overlay-controls">
                    <button id="voiceBackBtn" class="btn glass-strong px-3 py-2 rounded-xl flex items-center gap-2">
                        <i data-lucide="arrow-left" class="w-5 h-5"></i>
                        <span>Back to Main AI</span>
                    </button>
                </div>
                <div class="overlay-controls">
                    <div id="voiceState" class="overlay-status">
                        <span class="inline-flex h-2.5 w-2.5 rounded-full" id="voiceDot"
                            style="background: var(--listen)"></span>
                        <span id="voiceLabel" class="text-sm">Listening…</span>
                    </div>
                </div>
            </div>
            <div class="overlay-bottom">
                <div id="voiceHint" class="text-sm opacity-80">Speak naturally. The orb will listen and then respond out
                    loud.</div>
                <div id="voiceTranscript" class="overlay-transcript text-lg leading-relaxed w-full max-w-3xl"></div>
                <div id="voiceAIResponse" class="overlay-transcript text-lg leading-relaxed w-full max-w-3xl hidden">
                </div>
            </div>
        </div>
    </div>

    <!-- Recorder Modal (Video/Audio) -->
    <div id="recorderModal" role="dialog" aria-modal="true" aria-label="Recorder modal">
        <div class="glass-strong neumorphic rec-card rounded-2xl p-4 relative">
            <button id="recClose" class="btn glass absolute top-3 right-3 h-10 w-10 rounded-xl"
                aria-label="Close recorder"><i data-lucide="x" class="w-5 h-5"></i></button>
            <div class="flex flex-col lg:flex-row gap-4">
                <div class="flex-1 space-y-3">
                    <div class="rec-video">
                        <video id="recPreview" playsinline autoplay muted
                            class="w-full h-full object-contain bg-black"></video>
                    </div>
                    <div class="glass rounded-xl p-3">
                        <div class="flex items-center gap-3 flex-wrap">
                            <div class="flex items-center gap-2">
                                <i data-lucide="camera" class="w-4 h-4 opacity-80"></i>
                                <select id="camSelect"
                                    class="glass px-2 py-1 rounded-lg text-sm min-w-[12rem]"></select>
                            </div>
                            <div class="flex items-center gap-2">
                                <i data-lucide="mic" class="w-4 h-4 opacity-80"></i>
                                <select id="micSelect"
                                    class="glass px-2 py-1 rounded-lg text-sm min-w-[12rem]"></select>
                            </div>
                            <div class="flex items-center gap-2">
                                <i data-lucide="monitor" class="w-4 h-4 opacity-80"></i>
                                <select id="resSelect" class="glass px-2 py-1 rounded-lg">
                                    <option value="1280x720">HD 1280x720</option>
                                    <option value="1920x1080">FullHD 1920x1080</option>
                                    <option value="640x360">SD 640x360</option>
                                </select>
                            </div>
                            <label class="flex items-center gap-2 ml-auto">
                                <input id="videoToggle" type="checkbox" class="accent-neon-violet" checked />
                                <span class="text-sm opacity-90">Camera on</span>
                            </label>
                        </div>
                        <div class="mt-3">
                            <div class="text-xs opacity-75 mb-1">Audio level</div>
                            <div class="w-full bg-white/10 rounded-full overflow-hidden">
                                <div id="audioMeter" class="meter-bar"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="w-full lg:w-72 space-y-3">
                    <div class="glass rounded-2xl p-4">
                        <div class="text-sm uppercase tracking-wider opacity-70">Recorder</div>
                        <div id="recStatus" class="mt-2 text-lg font-semibold">Ready</div>
                        <div id="recTimer" class="mt-1 text-sm opacity-80">00:00</div>
                        <div class="grid grid-cols-2 gap-2 mt-3">
                            <button id="btnStart"
                                class="btn px-3 py-2 rounded-xl bg-gradient-to-r from-neon-violet to-neon-magenta text-white disabled:opacity-60">
                                <i data-lucide="circle" class="w-4 h-4"></i> Start
                            </button>
                            <button id="btnStop" class="btn glass px-3 py-2 rounded-xl" disabled>
                                <i data-lucide="stop-circle" class="w-4 h-4"></i> Stop
                            </button>
                            <button id="btnRetake" class="btn glass px-3 py-2 rounded-xl col-span-2" disabled>
                                <i data-lucide="refresh-ccw" class="w-4 h-4"></i> Retake
                            </button>
                            <button id="btnAttach" class="btn glass px-3 py-2 rounded-xl col-span-2" disabled>
                                <i data-lucide="send" class="w-4 h-4"></i> Attach to chat
                            </button>
                            <button id="btnDownload" class="btn glass px-3 py-2 rounded-xl col-span-2" disabled>
                                <i data-lucide="download" class="w-4 h-4"></i> Download file
                            </button>
                        </div>
                        <div class="mt-3 text-xs opacity-75">Tip: Use Esc to close. Max 5 minutes per recording.</div>
                    </div>
                    <div class="glass rounded-2xl p-4">
                        <div class="text-sm uppercase tracking-wider opacity-70">Mode</div>
                        <div class="mt-2 grid grid-cols-2 gap-2">
                            <label class="glass px-3 py-2 rounded-xl flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="recMode" value="video" class="accent-neon-violet" checked />
                                <span>Video</span>
                            </label>
                            <label class="glass px-3 py-2 rounded-xl flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="recMode" value="audio" class="accent-neon-violet" />
                                <span>Audio</span>
                            </label>
                        </div>
                        <div class="mt-2">
                            <label class="flex items-center gap-2">
                                <input id="countdownToggle" type="checkbox" class="accent-neon-violet" checked />
                                <span class="text-sm opacity-90">3s countdown</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- HISTORY MODAL (View All) -->
    <div id="historyModal" class="modal" role="dialog" aria-modal="true" aria-label="All history">
        <div class="glass-strong neumorphic modal-card rounded-2xl p-4 relative">
            <button id="historyClose" class="btn glass absolute top-3 right-3 h-10 w-10 rounded-xl"
                aria-label="Close history modal">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
            <div class="flex items-center gap-3 mb-3">
                <i data-lucide="clock" class="w-5 h-5 opacity-80"></i>
                <h3 class="text-lg font-semibold">All Sessions</h3>
            </div>
            <!-- Centered search + new chat just after search -->
            <div class="w-full flex items-center justify-center">
                <div class="flex items-center gap-2 glass px-2 py-1.5 rounded-xl w-full sm:w-2/3">
                    <i data-lucide="search" class="w-4 h-4 opacity-80"></i>
                    <input id="historySearch" type="text" class="bg-transparent outline-none text-sm w-full"
                        placeholder="Search sessions…" />
                    <button id="historyNewFromModal" class="btn glass px-3 py-2 rounded-xl shrink-0">
                        <i data-lucide="plus" class="w-4 h-4"></i> New chat
                    </button>
                </div>
            </div>
            <div id="historyGrid" class="grid gap-2 max-h-[60vh] overflow-auto pr-1 mt-3"></div>
        </div>
    </div>

    <!-- FEEDBACK MODAL -->
    <div id="feedbackModal" class="modal" role="dialog" aria-modal="true" aria-label="Send feedback">
        <div class="glass-strong neumorphic modal-card rounded-2xl p-4 relative">
            <button id="feedbackClose" class="btn glass absolute top-3 right-3 h-10 w-10 rounded-xl"
                aria-label="Close feedback modal"><i data-lucide="x" class="w-5 h-5"></i></button>
            <div class="flex items-center gap-3 mb-3">
                <i data-lucide="message-circle" class="w-5 h-5 opacity-80"></i>
                <h3 class="text-lg font-semibold">Send Feedback</h3>
            </div>
            <div class="space-y-3">
                <div>
                    <div class="text-sm opacity-80 mb-1">How was your experience?</div>
                    <div id="feedbackRating" class="flex items-center gap-1">
                        <button class="btn glass h-10 w-10 rounded-xl" data-rate="1" aria-label="1 star"><i
                                data-lucide="star" class="w-5 h-5"></i></button>
                        <button class="btn glass h-10 w-10 rounded-xl" data-rate="2" aria-label="2 star"><i
                                data-lucide="star" class="w-5 h-5"></i></button>
                        <button class="btn glass h-10 w-10 rounded-xl" data-rate="3" aria-label="3 star"><i
                                data-lucide="star" class="w-5 h-5"></i></button>
                        <button class="btn glass h-10 w-10 rounded-xl" data-rate="4" aria-label="4 star"><i
                                data-lucide="star" class="w-5 h-5"></i></button>
                        <button class="btn glass h-10 w-10 rounded-xl" data-rate="5" aria-label="5 star"><i
                                data-lucide="star" class="w-5 h-5"></i></button>
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                    <select id="feedbackCategory" class="glass px-3 py-2 rounded-xl">
                        <option value="general">General</option>
                        <option value="bug">Bug</option>
                        <option value="feature">Feature request</option>
                        <option value="ui">UI/Design</option>
                    </select>
                    <input id="feedbackEmail" type="email" class="glass px-3 py-2 rounded-xl"
                        placeholder="Your email (optional)" />
                </div>
                <textarea id="feedbackText" rows="4" class="w-full glass px-3 py-2 rounded-xl outline-none"
                    placeholder="Share your thoughts…"></textarea>
                <div class="flex items-center justify-between">
                    <div class="text-xs opacity-70">We read every feedback.</div>
                    <div class="flex items-center gap-2">
                        <button id="feedbackSubmit"
                            class="btn px-3 py-2 rounded-xl bg-gradient-to-r from-neon-violet to-neon-magenta text-white">
                            <i data-lucide="send" class="w-4 h-4"></i> Submit
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SETTINGS MODAL (Enhanced) -->
    <div id="settingsModal" class="modal" role="dialog" aria-modal="true" aria-label="Settings">
        <div class="glass-strong neumorphic modal-card rounded-2xl p-4 relative">
            <button id="settingsClose" class="btn glass absolute top-3 right-3 h-10 w-10 rounded-xl"
                aria-label="Close settings modal"><i data-lucide="x" class="w-5 h-5"></i></button>
            <div class="flex items-center gap-3 mb-3">
                <i data-lucide="settings" class="w-5 h-5 opacity-80"></i>
                <h3 class="text-lg font-semibold">Settings</h3>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                <!-- Preferences -->
                <div class="glass rounded-2xl p-4 space-y-3 md:col-span-1">
                    <div class="text-sm uppercase tracking-wider opacity-70">Preferences</div>
                    <label class="flex items-center justify-between glass rounded-xl px-3 py-2">
                        <span class="flex items-center gap-2"><i data-lucide="moon-star" class="w-4 h-4"></i>
                            Theme</span>
                        <button id="modalThemeToggle" class="btn glass h-8 w-8 rounded-lg" aria-label="Toggle theme">
                            <i data-lucide="sun-moon" class="w-4 h-4"></i>
                        </button>
                    </label>
                    <label class="flex items-center justify-between glass rounded-xl px-3 py-2">
                        <span class="flex items-center gap-2"><i data-lucide="bell" class="w-4 h-4"></i> Notifications
                            (toasts)</span>
                        <input id="modalToastsToggle" type="checkbox" class="accent-neon-violet" />
                    </label>
                    <label class="flex items-center justify-between glass rounded-xl px-3 py-2">
                        <span class="flex items-center gap-2"><i data-lucide="zap" class="w-4 h-4"></i> High
                            contrast</span>
                        <input id="modalContrastToggle" type="checkbox" class="accent-neon-violet" />
                    </label>
                    <label class="flex items-center justify-between glass rounded-xl px-3 py-2">
                        <span class="flex items-center gap-2"><i data-lucide="gauge" class="w-4 h-4"></i> Reduce
                            motion</span>
                        <input id="modalMotionToggle" type="checkbox" class="accent-neon-violet" />
                    </label>
                </div>
                <!-- UI & Density -->
                <div class="glass rounded-2xl p-4 space-y-3 md:col-span-1">
                    <div class="text-sm uppercase tracking-wider opacity-70">Interface</div>
                    <div class="space-y-2">
                        <div class="text-sm opacity-80">Font scale</div>
                        <input id="uiFontScale" type="range" min="0.85" max="1.25" step="0.05" value="1"
                            class="w-full accent-neon-violet" />
                    </div>
                    <div class="space-y-2">
                        <div class="text-sm opacity-80">Message density</div>
                        <div class="flex gap-2">
                            <button class="btn glass px-3 py-2 rounded-xl ring-1 ring-neon-violet/50"
                                data-density="comfortable">Comfortable</button>
                            <button class="btn glass px-3 py-2 rounded-xl" data-density="compact">Compact</button>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <div class="text-sm opacity-80">Time format</div>
                        <div class="flex gap-2">
                            <button class="btn glass px-3 py-2 rounded-xl ring-1 ring-neon-violet/50"
                                data-timefmt="12">12h</button>
                            <button class="btn glass px-3 py-2 rounded-xl" data-timefmt="24">24h</button>
                        </div>
                    </div>
                </div>
                <!-- Profile inside settings -->
                <div class="glass rounded-2xl p-4 space-y-3 md:col-span-1">
                    <div class="text-sm uppercase tracking-wider opacity-70">Profile</div>
                    <label class="glass px-3 py-2 rounded-xl flex items-center gap-2">
                        <i data-lucide="user" class="w-4 h-4 opacity-80"></i>
                        <input id="setUserName" type="text" class="bg-transparent outline-none flex-1"
                            placeholder="Name" />
                    </label>
                    <label class="glass px-3 py-2 rounded-xl flex items-center gap-2">
                        <i data-lucide="mail" class="w-4 h-4 opacity-80"></i>
                        <input id="setUserEmail" type="email" class="bg-transparent outline-none flex-1"
                            placeholder="Email" />
                    </label>
                    <div class="flex items-center justify-end">
                        <button id="settingsSave"
                            class="btn px-3 py-2 rounded-xl bg-gradient-to-r from-neon-violet to-neon-magenta text-white">
                            <i data-lucide="check" class="w-4 h-4"></i> Save
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        /* Global state (no localStorage; ephemeral) */
        const state = {
            user: { name: 'User', email: 'user@salmar.ai' },
            mode: 'knowledge',
            personality: 0,
            responseStyle: 'concise',
            outputFormat: 'md',
            aiMode: 'smart',
            biometric: false,
            encrypted: false,
            lockOutputs: false,
            memoryLongTerm: false,
            humanize: false,
            genSpeed: 3, // 1..5
            pii: false,
            safety: 2, ctxWindow: 2,
            autorunWorkflow: false,
            ui: {
                fontScale: 1,
                density: 'comfortable', // comfortable | compact
                toasts: true,
                highContrast: false,
                reducedMotion: false,
                timeFormat: '12'
            },
            orb: {
                intensity: 'balanced',
                behaviors: { rings: true, particles: true, radiant: true },
                state: 'idle' // idle | listening | processing | ready | speaking
            },
            sessions: [], // {id, title, time, count, messages: [{role,text,attachments,encrypted}]}
            currentSessionId: null,
            collaborators: [
                { name: 'Ava', role: 'Owner', online: true },
                { name: 'Ben', role: 'Editor', online: true },
                { name: 'Kai', role: 'Viewer', online: false }
            ],
            workflow: [] // filled at bootstrap
        };

        /* Utils */
        const $ = (sel, root = document) => root.querySelector(sel);
        const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));
        const el = (tag, cls = '', attrs = {}) => {
            const n = document.createElement(tag);
            if (cls) n.className = cls;
            for (const [k, v] of Object.entries(attrs)) {
                if (k === 'text') n.textContent = v;
                else if (k === 'html') n.innerHTML = v;
                else n.setAttribute(k, v);
            }
            return n;
        };
        const downloadFile = (name, type, content) => {
            const blob = content instanceof Blob ? content : new Blob([content], { type });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = name;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => { URL.revokeObjectURL(a.href); a.remove(); }, 0);
        };

        /* Toasts */
        function toast(msg = '', type = 'info') {
            if (!state.ui.toasts) return;
            const cont = $('#toastContainer');
            const t = el('div', 'toast glass rounded-xl px-3 py-2 flex items-center gap-2 shadow-lavender');
            const color = type === 'success' ? 'ring-emerald-400' : type === 'warn' ? 'ring-yellow-400' : type === 'error' ? 'ring-red-400' : 'ring-neon-violet/50';
            t.classList.add('ring-1', color);
            t.innerHTML = `<i data-lucide="${type === 'success' ? 'check-circle' : type === 'error' ? 'alert-triangle' : 'bell'}" class="w-4 h-4"></i><div class="text-sm">${escapeHtml(msg)}</div>`;
            cont.appendChild(t);
            lucide.createIcons();
            setTimeout(() => {
                t.style.opacity = '0';
                t.style.transform = 'translateY(6px)';
                setTimeout(() => t.remove(), 240);
            }, 2200);
        }

        /* Tooltips */
        const tip = (target, content) => { try { tippy(target, { content, theme: 'light', delay: [300, 0], animation: 'shift-away-subtle' }); } catch (e) { } };

        /* Menu dropdown handling (enhanced: right-fixed option, no freeze) */
        function setupMenu(btn, menu, opts = { rightFixed: false }) {
            const { rightFixed = false } = opts || {};
            const open = () => {
                menu.dataset.open = 'true';
                btn.setAttribute('aria-expanded', 'true');
                if (rightFixed) {
                    try {
                        const rect = btn.getBoundingClientRect();
                        const top = Math.max(16, rect.bottom + 8);
                        menu.classList.add('menu-right-fixed');
                        menu.style.top = top + 'px';
                        menu.style.width = '16rem';
                    } catch (e) { /* ignore */ }
                }
            };
            const close = () => {
                menu.dataset.open = 'false';
                btn.setAttribute('aria-expanded', 'false');
                if (rightFixed) {
                    menu.classList.remove('menu-right-fixed');
                    menu.style.top = '';
                    menu.style.width = '';
                }
            };
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const isOpen = menu.dataset.open === 'true';
                (isOpen ? close : open)();
            });
            document.addEventListener('click', (e) => {
                if (!menu.contains(e.target) && e.target !== btn) close();
            });
            btn.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowDown') {
                    menu.dataset.open = 'true';
                    e.preventDefault();
                    (menu.querySelector('[role="menuitem"]') || {}).focus?.();
                }
                if (e.key === 'Escape') close();
            });
            return { open, close };
        }

        /* Sidebar toggle */
        const sidebar = $('#sidebar');
        const sidebarToggleBtn = $('#sidebarToggle');
        sidebarToggleBtn.addEventListener('click', () => {
            const willCollapse = !sidebar.classList.contains('collapsed');
            sidebar.classList.toggle('collapsed', willCollapse);
            sidebar.classList.toggle('w-20', willCollapse);
            sidebar.classList.toggle('w-72', !willCollapse);
            sidebarToggleBtn.setAttribute('aria-pressed', String(willCollapse));
            announce(willCollapse ? 'Sidebar collapsed' : 'Sidebar expanded');
        });

        /* Mode buttons */
        $$('#sidebar .mode-btn').forEach(btn => {
            tip(btn, `Switch to ${btn.dataset.mode} mode`);
            btn.addEventListener('click', () => {
                state.mode = btn.dataset.mode;
                $$('#sidebar .mode-btn').forEach(b => {
                    const color = {
                        knowledge: '#2da3ff', creative: '#ff4edb', business: '#ffbd2e',
                        security: '#23d18b', integrations: 'rgba(255,255,255,0.5)'
                    }[b.dataset.mode];
                    b.style.borderColor = b.dataset.mode === state.mode ? color : 'transparent';
                    b.style.boxShadow = b.dataset.mode === state.mode ? `0 0 0 1px ${color}` : '';
                });
                accentOrbCoreByMode(); // core circle change only
                announce(`Mode changed to ${state.mode}`);
            });
        });

        /* Personality slider (particles hue only) */
        const personalities = ['Professional', 'Friendly', 'Visionary', 'Technical'];
        const personalityHues = [220, 305, 48, 190]; // blue, magenta, amber, cyan/teal
        const personalityInput = $('#personality');
        const personalityLabel = $('#personalityLabel');
        personalityInput.addEventListener('input', () => {
            state.personality = +personalityInput.value;
            personalityLabel.textContent = personalities[state.personality];
            setOrbPersonalityHue(state.personality); // affects particles only
            announce(`Personality set to ${personalities[state.personality]}`);
        });

        /* Menus */
        const dashboardMenu = setupMenu($('#dashboardBtn'), $('#dashboardMenu'));
        const profileMenu = setupMenu($('#profileBtn'), $('#profileMenu'));
        /* History header menu (RIGHT SIDE, NO FREEZE) */
        const historyHeaderMenu = setupMenu($('#historyMenuBtn'), $('#historyMenu'), { rightFixed: true });

        /* Biometric indicator */
        async function detectBiometricSupport() {
            try {
                const supported = 'PublicKeyCredential' in window && (await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable?.()) === true;
                const dot = $('#biometricDot');
                if (supported) {
                    dot.classList.remove('bg-gray-400');
                    dot.classList.add('bg-mode-security');
                    dot.style.boxShadow = '0 0 12px rgba(35,209,139,0.7)';
                    dot.title = 'Biometric capable device detected';
                } else {
                    dot.title = 'No biometric capability detected';
                }
            } catch (e) { /* silent */ }
        }
        detectBiometricSupport();

        /* Theme toggle */
        $('#themeToggle').addEventListener('click', () => {
            document.body.classList.toggle('theme-light');
            announce('Theme toggled');
        });
        // Modal theme toggle mirrors header toggle
        const modalThemeToggle = $('#modalThemeToggle');
        if (modalThemeToggle) modalThemeToggle.addEventListener('click', () => $('#themeToggle').click());

        /* Help */
        $('#helpBtn').addEventListener('click', () => {
            let opened = false;
            try { const w = window.open('helpcenter.html', '_blank', 'noopener'); opened = !!w; } catch (e) { /* ignore */ }
            if (!opened) openCmdPalette('help');
            pushSystemMessage('Help opened. See Help Center for detailed guidance.');
        });

        /* Session helpers */
        function formatNow() {
            const d = new Date();
            if (state.ui.timeFormat === '24') return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
            return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true });
        }
        function deriveTitleFrom(text = '') {
            const clean = String(text || '').replace(/\s+/g, ' ').trim();
            if (!clean) return 'Untitled session';
            const words = clean.split(' ').slice(0, 8).join(' ');
            return (words.length > 64 ? words.slice(0, 61) + '…' : words);
        }
        function createSession(title) {
            const id = cryptoRandomId();
            const time = formatNow();
            const session = { id, title: String(title || 'Untitled session').trim() || 'Untitled session', time, count: 0, messages: [] };
            state.sessions.unshift(session);
            while (state.sessions.length > 200) state.sessions.pop();
            state.currentSessionId = id;
            renderHistory();
            return id;
        }
        function ensureSessionForUserText(text) {
            if (!state.currentSessionId) {
                const title = deriveTitleFrom(text);
                state.currentSessionId = createSession(title);
            } else {
                // Update title if session untitled
                const s = state.sessions.find(x => x.id === state.currentSessionId);
                if (s && (!s.title || s.title.startsWith('Untitled'))) s.title = deriveTitleFrom(text);
            }
            const s = state.sessions.find(x => x.id === state.currentSessionId);
            if (s) {
                s.count = (s.count || 0) + 1;
                s.time = formatNow();
                renderHistory();
            }
        }
        function ensureSessionExists() {
            if (!state.currentSessionId) {
                state.currentSessionId = createSession('Untitled session');
            }
        }
        function addHistoryItem(title, seedMessages = []) {
            const cleanTitle = String(title || '').trim();
            const id = createSession(cleanTitle || 'Untitled session');
            const s = state.sessions.find(x => x.id === id);
            if (s && seedMessages.length) {
                s.messages.push(...seedMessages);
                s.count = s.messages.length;
                renderHistory();
            }
            return id;
        }

        /* Load a session into chat view */
        function loadSession(sessionId) {
            const s = state.sessions.find(x => x.id === sessionId);
            if (!s) { announce('Session not found'); return; }
            state.currentSessionId = s.id;
            chatScroll.innerHTML = '';
            if (!s.messages.length) {
                pushSystemMessage(`Opened session: ${s.title}`);
            } else {
                for (const m of s.messages) {
                    createMessage({ role: m.role, text: m.text, attachments: m.attachments || [], encrypted: !!m.encrypted });
                }
            }
            renderHistory(); // refresh active highlight/time
            announce(`Loaded session: ${s.title}`);
        }

        /* History UI */
        function renderHistory() {
            const list = $('#historyList');
            list.innerHTML = '';
            state.sessions.forEach((s, idx) => {
                const row = el('div', 'glass rounded-xl px-3 py-2 border border-white/10 flex items-center gap-2 justify-between', { role: 'listitem' });
                if (state.currentSessionId === s.id) row.classList.add('ring-2', 'ring-neon-violet/50');
                const left = el('button', 'flex items-center gap-2 min-w-0 text-left flex-1', { title: 'Open session' });
                left.innerHTML = `
     <i data-lucide="clock" class="w-4 h-4 opacity-80 shrink-0"></i>
     <div class="min-w-0">
      <div class="truncate">${escapeHtml(s.title)}</div>
      <div class="text-xs opacity-70">${s.time} • ${s.count || 0} msg</div>
     </div>
   `;
                left.addEventListener('click', () => {
                    loadSession(s.id);
                    toast(`Opened "${s.title}"`, 'success');
                });
                const rightWrap = el('div', 'relative');
                const moreBtn = el('button', 'btn glass h-8 w-8 rounded-lg', { 'aria-label': 'Session actions' });
                moreBtn.innerHTML = `<i data-lucide="more-vertical" class="w-4 h-4"></i>`;
                const menu = el('div', 'menu absolute right-0 mt-2 w-48 glass-strong rounded-xl p-1', { 'data-open': 'false', role: 'menu' });
                menu.innerHTML = `
     <button class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/5 flex items-center gap-2" role="menuitem" data-action="open">
      <i data-lucide="folder-open" class="w-4 h-4"></i> Open
     </button>
     <button class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/5 flex items-center gap-2" role="menuitem" data-action="rename">
      <i data-lucide="pencil" class="w-4 h-4"></i> Rename
     </button>
     <button class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/5 flex items-center gap-2" role="menuitem" data-action="share">
      <i data-lucide="share-2" class="w-4 h-4"></i> Share
     </button>
     <button class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/5 flex items-center gap-2" role="menuitem" data-action="delete">
      <i data-lucide="trash-2" class="w-4 h-4"></i> Delete
     </button>
   `;
                rightWrap.append(moreBtn, menu);
                row.append(left, rightWrap);
                list.appendChild(row);
                const ctl = setupMenu(moreBtn, menu, { rightFixed: true });
                menu.addEventListener('click', async (e) => {
                    const btn = e.target.closest('button[role="menuitem"]');
                    if (!btn) return;
                    const act = btn.dataset.action;
                    if (act === 'open') {
                        ctl.close(); loadSession(s.id);
                    } else if (act === 'rename') {
                        ctl.close();
                        const nv = prompt('Rename session:', s.title);
                        if (nv && nv.trim()) { s.title = nv.trim(); renderHistory(); announce('Session renamed'); toast('Session renamed', 'success'); }
                    } else if (act === 'share') {
                        ctl.close();
                        const shareText = `Salmar session: ${s.title} (${s.count || 0} messages)`;
                        try {
                            if (navigator.share) await navigator.share({ title: 'Salmar Session', text: shareText });
                            else { await navigator.clipboard?.writeText(shareText); announce('Copied to clipboard'); toast('Copied summary to clipboard', 'success'); }
                        } catch (e) { }
                    } else if (act === 'delete') {
                        ctl.close();
                        const delIdx = state.sessions.findIndex(x => x.id === s.id);
                        if (delIdx >= 0) {
                            const wasCurrent = state.currentSessionId === s.id;
                            state.sessions.splice(delIdx, 1);
                            if (wasCurrent) {
                                state.currentSessionId = state.sessions[0]?.id || null;
                                chatScroll.innerHTML = '';
                                if (state.currentSessionId) loadSession(state.currentSessionId);
                                else pushSystemMessage('No sessions. Create a new chat to start.');
                            }
                            renderHistory();
                            announce('Session deleted'); toast('Session deleted', 'success');
                        }
                    }
                });
            });
            lucide.createIcons();
        }

        /* HISTORY header actions */
        $('#historyNewBtn').addEventListener('click', () => { newChat(); toast('New chat created', 'success'); });
        $('#historyShareAllBtn').addEventListener('click', async () => {
            const txt = state.sessions.map((s, i) => `${i + 1}. ${s.title} — ${s.time} • ${s.count || 0} msg`).join('\n');
            try {
                if (navigator.share) await navigator.share({ title: 'Salmar Sessions', text: txt || 'No sessions' });
                else { await navigator.clipboard?.writeText(txt || 'No sessions'); announce('Copied to clipboard'); toast('Copied history to clipboard', 'success'); }
            } catch (e) { }
        });
        $('#historyExportBtn').addEventListener('click', () => {
            downloadFile('salmar-sessions.json', 'application/json', JSON.stringify(state.sessions, null, 2));
            toast('Sessions exported', 'success');
        });
        $('#historyClearBtn').addEventListener('click', () => {
            if (confirm('Clear all sessions?')) {
                state.sessions = [];
                state.currentSessionId = null;
                renderHistory();
                chatScroll.innerHTML = '';
                pushSystemMessage('No sessions. Create a new chat to start.');
                announce('History cleared'); toast('History cleared', 'success');
            }
        });
        $('#historyViewAll').addEventListener('click', openHistoryModal);

        /* HISTORY MODAL handlers */
        function openHistoryModal() {
            $('#historyModal').classList.add('active');
            document.body.style.overflow = 'hidden';
            renderHistoryModal();
        }
        function closeHistoryModal() {
            $('#historyModal').classList.remove('active');
            document.body.style.overflow = '';
        }
        $('#historyClose').addEventListener('click', closeHistoryModal);
        $('#historyModal').addEventListener('click', (e) => { if (e.target === $('#historyModal')) closeHistoryModal(); });
        $('#historyNewFromModal').addEventListener('click', () => { closeHistoryModal(); newChat(); toast('New chat created', 'success'); });
        $('#historySearch').addEventListener('input', renderHistoryModal);
        function renderHistoryModal() {
            const grid = $('#historyGrid');
            grid.innerHTML = '';
            const q = ($('#historySearch').value || '').toLowerCase().trim();
            state.sessions.filter(s => s.title.toLowerCase().includes(q)).forEach((s, idx) => {
                const item = el('div', 'glass rounded-xl p-3 flex items-center gap-3 justify-between');
                item.innerHTML = `
     <div class="min-w-0">
      <div class="font-medium truncate">${escapeHtml(s.title)}</div>
      <div class="text-xs opacity-70">${s.time} • ${s.count || 0} msg</div>
     </div>
     <div class="flex items-center gap-2">
      <button class="btn glass h-8 w-8 rounded-lg" data-act="open" aria-label="Open"><i data-lucide="folder-open" class="w-4 h-4"></i></button>
      <button class="btn glass h-8 w-8 rounded-lg" data-act="rename" aria-label="Rename"><i data-lucide="pencil" class="w-4 h-4"></i></button>
      <button class="btn glass h-8 w-8 rounded-lg" data-act="share" aria-label="Share"><i data-lucide="share-2" class="w-4 h-4"></i></button>
      <button class="btn glass h-8 w-8 rounded-lg" data-act="delete" aria-label="Delete"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
     </div>
   `;
                item.querySelectorAll('button[data-act]').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const act = btn.getAttribute('data-act');
                        if (act === 'open') { closeHistoryModal(); loadSession(s.id); }
                        if (act === 'rename') {
                            const nv = prompt('Rename session:', s.title);
                            if (nv && nv.trim()) { s.title = nv.trim(); renderHistory(); renderHistoryModal(); announce('Session renamed'); toast('Session renamed', 'success'); }
                        }
                        if (act === 'share') {
                            const shareText = `Salmar session: ${s.title} (${s.count || 0} messages)`;
                            try { if (navigator.share) await navigator.share({ title: 'Salmar Session', text: shareText }); else { await navigator.clipboard?.writeText(shareText); announce('Copied to clipboard'); toast('Copied summary to clipboard', 'success'); } } catch (e) { }
                        }
                        if (act === 'delete') { state.sessions.splice(idx, 1); renderHistory(); renderHistoryModal(); announce('Session deleted'); toast('Session deleted', 'success'); }
                    });
                });
                grid.appendChild(item);
            });
            lucide.createIcons();
        }

        /* PROFILE + FEEDBACK (Settings integrated) */
        function openFeedback() { $('#feedbackModal').classList.add('active'); document.body.style.overflow = 'hidden'; }
        function closeFeedback() { $('#feedbackModal').classList.remove('active'); document.body.style.overflow = ''; }
        $('#feedbackClose').addEventListener('click', closeFeedback);
        $('#feedbackModal').addEventListener('click', (e) => { if (e.target === $('#feedbackModal')) closeFeedback(); });
        $('#menuFeedback').addEventListener('click', () => { closeAllMenus(); openFeedback(); });

        let feedbackRating = 0;
        $('#feedbackRating').addEventListener('click', (e) => {
            const b = e.target.closest('button[data-rate]');
            if (!b) return;
            feedbackRating = +b.dataset.rate;
            $$('#feedbackRating button').forEach(btn => {
                const star = btn.querySelector('i');
                const val = +btn.dataset.rate;
                star.setAttribute('data-lucide', 'star');
                btn.classList.toggle('ring-2', val <= feedbackRating);
                btn.classList.toggle('ring-neon-violet/50', val <= feedbackRating);
            });
            lucide.createIcons();
        });
        $('#feedbackSubmit').addEventListener('click', () => {
            const cat = $('#feedbackCategory').value;
            const email = $('#feedbackEmail').value;
            const text = $('#feedbackText').value.trim();
            const payload = { rating: feedbackRating, category: cat, email, text, at: new Date().toISOString() };
            console.log('FEEDBACK:', payload);
            pushSystemMessage('Thanks for your feedback! We appreciate it.');
            toast('Feedback sent. Thank you!', 'success');
            closeFeedback();
        });

        /* SETTINGS modal (enhanced) */
        function openSettings() {
            $('#settingsModal').classList.add('active');
            document.body.style.overflow = 'hidden';
            $('#setUserName').value = state.user.name || '';
            $('#setUserEmail').value = state.user.email || '';
            // UI toggles
            $('#modalToastsToggle').checked = !!state.ui.toasts;
            $('#modalContrastToggle').checked = !!state.ui.highContrast;
            $('#modalMotionToggle').checked = !!state.ui.reducedMotion;
            $('#uiFontScale').value = state.ui.fontScale;
            // Density/time buttons
            updateDensityButtons();
            updateTimeFmtButtons();
        }
        function closeSettings() {
            $('#settingsModal').classList.remove('active');
            document.body.style.overflow = '';
        }
        $('#settingsClose').addEventListener('click', closeSettings);
        $('#settingsModal').addEventListener('click', (e) => { if (e.target === $('#settingsModal')) closeSettings(); });
        $('#openSettings').addEventListener('click', () => { closeAllMenus(); openSettings(); });

        // Save settings (Profile)
        $('#settingsSave').addEventListener('click', () => {
            const name = $('#setUserName').value.trim() || 'User';
            const email = $('#setUserEmail').value.trim() || 'user@salmar.ai';
            state.user.name = name;
            state.user.email = email;
            $('#profileEmailText').textContent = email;
            announce('Profile updated'); toast('Profile updated', 'success');
            closeSettings();
        });

        // Preferences toggles
        $('#modalToastsToggle').addEventListener('change', (e) => { state.ui.toasts = e.target.checked; announce(`Toasts ${state.ui.toasts ? 'enabled' : 'disabled'}`); });
        $('#modalContrastToggle').addEventListener('change', (e) => {
            state.ui.highContrast = e.target.checked;
            document.body.classList.toggle('high-contrast', state.ui.highContrast);
            announce(`High contrast ${state.ui.highContrast ? 'enabled' : 'disabled'}`);
        });
        $('#modalMotionToggle').addEventListener('change', (e) => {
            state.ui.reducedMotion = e.target.checked;
            document.body.classList.toggle('reduce-motion', state.ui.reducedMotion);
            announce(`Reduce motion ${state.ui.reducedMotion ? 'enabled' : 'disabled'}`);
        });
        $('#uiFontScale').addEventListener('input', (e) => {
            const v = parseFloat(e.target.value || '1') || 1;
            state.ui.fontScale = v;
            document.documentElement.style.setProperty('--font-scale', String(v));
            announce(`Font scale ${v.toFixed(2)}x`);
        });

        function updateDensityButtons() {
            $$('#settingsModal [data-density]').forEach(b => {
                b.classList.toggle('ring-1', b.dataset.density === state.ui.density);
                b.classList.toggle('ring-neon-violet/50', b.dataset.density === state.ui.density);
            });
        }
        function updateTimeFmtButtons() {
            $$('#settingsModal [data-timefmt]').forEach(b => {
                b.classList.toggle('ring-1', b.dataset.timefmt === state.ui.timeFormat);
                b.classList.toggle('ring-neon-violet/50', b.dataset.timefmt === state.ui.timeFormat);
            });
        }
        $$('#settingsModal [data-density]').forEach(b => {
            b.addEventListener('click', () => { state.ui.density = b.dataset.density; updateDensityButtons(); announce(`Density: ${state.ui.density}`); });
        });
        $$('#settingsModal [data-timefmt]').forEach(b => {
            b.addEventListener('click', () => { state.ui.timeFormat = b.dataset.timefmt; renderHistory(); renderHistoryModal(); updateTimeFmtButtons(); announce(`Time format: ${state.ui.timeFormat}h`); });
        });

        function closeAllMenus() { $$('.menu').forEach(m => m.dataset.open = 'false'); }

        /* Chat rendering (enhanced attachments + actions, AI actions hide when not hovering) */
        const chatScroll = $('#chatScroll');

        function getCardText(card) {
            const contentEl = card.querySelector('.message-content');
            return (contentEl?.textContent || '').trim();
        }

        async function copyMessage(card) {
            try {
                const text = getCardText(card);
                if (!text) { announce('Nothing to copy'); toast('Nothing to copy', 'warn'); return; }
                await navigator.clipboard?.writeText(text);
                announce('Copied to clipboard'); toast('Copied to clipboard', 'success');
            } catch (e) { announce('Copy failed'); toast('Copy failed', 'error'); }
        }

        function startEditUserMessage(card) {
            if (card.dataset.editing === 'true') return;
            const p = card.querySelector('.message-content');
            const original = p ? p.textContent : '';
            const ta = el('textarea', 'w-full bg-transparent outline-none resize-y text-base leading-relaxed py-2');
            ta.value = original;
            ta.rows = Math.min(8, Math.max(3, original.split('\n').length));
            p.classList.add('hidden');
            card.insertBefore(ta, p.nextSibling);
            card.dataset.editing = 'true';
            const bar = card.querySelector('.message-actions');
            if (!bar) return;
            const prev = bar.innerHTML;
            bar.dataset.prev = prev;
            bar.innerHTML = '';
            const saveBtn = actionButton('check', 'Save', () => {
                const v = ta.value.trim();
                p.textContent = v;
                ta.remove(); p.classList.remove('hidden');
                card.dataset.editing = 'false';
                bar.innerHTML = prev;
                wireMessageActionButtons(card);
                // update saved message in session
                updateSavedMessageText(card, v);
                announce('Message edited'); toast('Message edited', 'success');
            });
            const cancelBtn = actionButton('x', 'Cancel', () => {
                ta.remove();
                p.classList.remove('hidden');
                card.dataset.editing = 'false';
                bar.innerHTML = prev;
                wireMessageActionButtons(card);
                announce('Edit canceled'); toast('Edit canceled');
            });
            bar.append(saveBtn, cancelBtn);
        }

        function updateSavedMessageText(card, newText) {
            // naive: find first matching message index in current session by text; in real apps use id
            const s = getCurrentSession();
            if (!s) return;
            const idx = Array.from(chatScroll.children).indexOf(card.parentElement);
            if (idx < 0) return;
            // build logical mapping of rendered messages -> session messages
            const rendered = [];
            $$('#chatScroll > .flex').forEach(row => {
                const isAI = row.classList.contains('message-salmar');
                const c = row.querySelector('.message-content');
                rendered.push({ role: isAI ? 'salmar' : 'user', text: c?.textContent || '' });
            });
            // try to replace the nth user message
            let userOrder = -1;
            let targetOrder = -1;
            rendered.forEach((m, i) => {
                if (m.role === 'user') userOrder++;
                if (i === idx) targetOrder = userOrder;
            });
            if (targetOrder >= 0) {
                let seen = -1;
                for (const m of s.messages) {
                    if (m.role === 'user') {
                        seen++;
                        if (seen === targetOrder) { m.text = newText; break; }
                    }
                }
            }
        }

        function deleteMessage(row) {
            try {
                const isAI = row.classList.contains('message-salmar');
                row.remove();
                // Also remove from session (remove last occurrence of that role to keep mapping simple)
                const s = getCurrentSession();
                if (s) {
                    for (let i = s.messages.length - 1; i >= 0; i--) {
                        if ((isAI ? s.messages[i].role === 'salmar' : s.messages[i].role === 'user')) { s.messages.splice(i, 1); break; }
                    }
                    s.count = s.messages.length;
                    renderHistory();
                }
                announce('Message removed'); toast('Message removed', 'success');
            } catch (e) { }
        }

        function actionButton(icon, label, handler, extra = '') {
            const b = el('button', `btn glass px-2 py-1 rounded-lg flex items-center gap-1 text-xs ${extra}`, { 'aria-label': label, title: label });
            b.innerHTML = `<i data-lucide="${icon}" class="w-3.5 h-3.5"></i><span class="hidden sm:inline">${label}</span>`;
            b.addEventListener('click', (e) => { e.stopPropagation(); handler?.(e); });
            tip(b, label);
            return b;
        }
        function actionIcon(icon, label, handler, pressed = false) {
            const b = el('button', `btn glass h-8 px-2 rounded-lg flex items-center gap-1 text-xs`, { 'aria-label': label, 'aria-pressed': String(pressed) });
            b.innerHTML = `<i data-lucide="${icon}" class="w-4 h-4"></i>`;
            b.addEventListener('click', (e) => { e.stopPropagation(); handler?.(e, b); });
            tip(b, label);
            return b;
        }

        function getPreviousUserTextFromRow(row) {
            const items = Array.from(chatScroll.children);
            const idx = items.indexOf(row);
            for (let i = idx - 1; i >= 0; i--) {
                const r = items[i];
                if (r && r.classList.contains('message-user')) {
                    const c = r.querySelector('.message-content');
                    if (c) return c.textContent.trim();
                }
            }
            return '';
        }

        function applyReactionToggle(likeBtn, dislikeBtn, kind) {
            const set = (btn, on) => {
                btn.setAttribute('aria-pressed', String(on));
                btn.classList.toggle('ring-1', on);
                btn.classList.toggle('ring-neon-violet/50', on);
            };
            if (kind === 'like') {
                const on = likeBtn.getAttribute('aria-pressed') !== 'true';
                set(likeBtn, on);
                set(dislikeBtn, false);
                announce(on ? 'Liked' : 'Like removed'); toast(on ? 'Marked as helpful' : 'Like removed');
            } else {
                const on = dislikeBtn.getAttribute('aria-pressed') !== 'true';
                set(dislikeBtn, on);
                set(likeBtn, false);
                announce(on ? 'Disliked' : 'Dislike removed'); toast(on ? 'Marked as not helpful' : 'Dislike removed');
            }
        }

        async function shareMessage(card) {
            try {
                const text = getCardText(card) || 'Shared from Salmar';
                if (navigator.share) { await navigator.share({ title: 'Salmar Message', text }); }
                else { await navigator.clipboard?.writeText(text); announce('Copied to clipboard'); toast('Copied to clipboard', 'success'); }
            } catch (e) { /* ignore */ }
        }

        function streamToCard(card, content) {
            return new Promise(async (resolve) => {
                const p = card.querySelector('.message-content') || (() => { const n = el('div', 'whitespace-pre-wrap leading-relaxed message-content'); card.appendChild(n); return n; })();
                p.textContent = '';
                const baseDelay = [80, 65, 45, 30, 18][state.genSpeed - 1] || 45;
                for (let i = 0; i <= content.length; i += Math.ceil(Math.random() * 12)) {
                    p.textContent = content.slice(0, i);
                    await new Promise(r => setTimeout(r, baseDelay + Math.random() * baseDelay * 0.6));
                }
                p.textContent = content;
                resolve();
            });
        }

        function regenerateAIInto(card, prompt) {
            setOrbState('processing');
            let content = generateContent(state.responseStyle, prompt);
            if (state.pii) content = content.replace(/\b(\d{3}[- ]?\d{2}[- ]?\d{4}|\d{16})\b/g, '[REDACTED]');
            if (state.humanize) content = humanizeText(content);
            streamToCard(card, content).then(() => {
                // save regenerated content into session by replacing last AI message text
                const s = getCurrentSession();
                if (s) {
                    for (let i = s.messages.length - 1; i >= 0; i--) { if (s.messages[i].role === 'salmar') { s.messages[i].text = content; break; } }
                }
                setOrbState('ready');
                setTimeout(() => setOrbState('idle'), 800);
                announce('Regenerated response'); toast('Regenerated response', 'success');
            });
        }

        function readAloudText(text) {
            const synth = window.speechSynthesis || null;
            if (!synth) { announce('Speech synthesis not supported'); toast('Speech not supported', 'warn'); return; }
            try {
                synth.cancel();
                const u = new SpeechSynthesisUtterance(text); u.rate = 1.05; u.pitch = 1;
                synth.speak(u);
                toast('Reading aloud…');
            } catch (e) { }
        }

        function branchFromCard(card) {
            const text = getCardText(card);
            if (!text) { announce('Nothing to branch'); toast('Nothing to branch', 'warn'); return; }
            newChat();
            const userCard = pushUserMessage(text);
            simulateAI(text);
            toast('Branched into a new chat', 'success');
        }

        /* Wire buttons in a card */
        function wireMessageActionButtons(card) {
            const row = card.parentElement;
            const isAI = row.classList.contains('message-salmar');
            if (isAI) {
                const copyBtn = card.querySelector('[data-action="copy"]');
                const likeBtn = card.querySelector('[data-action="like"]');
                const dislikeBtn = card.querySelector('[data-action="dislike"]');
                const shareBtn = card.querySelector('[data-action="share"]');
                const regenBtn = card.querySelector('[data-action="regenerate"]');
                const moreBtn = card.querySelector('[data-action="more"]');
                const moreMenu = card.querySelector('.ai-more-menu');
                copyBtn?.addEventListener('click', () => copyMessage(card));
                likeBtn?.addEventListener('click', () => applyReactionToggle(likeBtn, dislikeBtn, 'like'));
                dislikeBtn?.addEventListener('click', () => applyReactionToggle(likeBtn, dislikeBtn, 'dislike'));
                shareBtn?.addEventListener('click', () => shareMessage(card));
                regenBtn?.addEventListener('click', () => {
                    const prompt = getPreviousUserTextFromRow(row) || getCardText(card);
                    regenerateAIInto(card, prompt);
                });
                if (moreBtn && moreMenu) setupMenu(moreBtn, moreMenu);
                const readBtn = card.querySelector('[data-action="read"]');
                const branchBtn = card.querySelector('[data-action="branch"]');
                readBtn?.addEventListener('click', () => readAloudText(getCardText(card)));
                branchBtn?.addEventListener('click', () => branchFromCard(card));
            } else {
                const copyBtn = card.querySelector('[data-action="copy"]');
                const editBtn = card.querySelector('[data-action="edit"]');
                const delBtn = card.querySelector('[data-action="delete"]');
                copyBtn?.addEventListener('click', () => copyMessage(card));
                editBtn?.addEventListener('click', () => startEditUserMessage(card));
                delBtn?.addEventListener('click', () => deleteMessage(row));
            }
        }

        function getCurrentSession() { return state.sessions.find(x => x.id === state.currentSessionId) || null; }
        function saveMessage(role, text, attachments = [], encrypted = state.encrypted) {
            ensureSessionExists();
            const s = getCurrentSession();
            if (!s) return;
            s.messages.push({ role, text, attachments, encrypted });
            s.count = s.messages.length;
            s.time = formatNow();
            renderHistory();
        }

        /* Main message creator with density handling and AI header label */
        function createMessage({ role, text, attachments = [], encrypted = state.encrypted }) {
            const padX = state.ui.density === 'compact' ? 'px-3' : 'px-4';
            const padY = state.ui.density === 'compact' ? 'py-2' : 'py-3';
            const row = el('div', `flex ${role === 'user' ? 'message-user' : 'message-salmar'}`);
            const card = el('div', `group max-w-[90%] sm:max-w-[70%] ${padX} ${padY} rounded-2xl glass ${role === 'salmar' ? 'bg-[var(--card)]' : 'bg-[var(--glass-strong)]'} shadow-lavender relative border border-white/10`);
            const head = el('div', 'flex items-center gap-2 mb-2');
            if (role === 'salmar') {
                const orbDot = el('div', 'h-2.5 w-2.5 rounded-full', {});
                orbDot.style.background = state.mode === 'security' ? '#23d18b' : orbCoreAccentByMode();
                head.appendChild(orbDot);
                const name = el('div', 'text-sm opacity-90 font-medium', { text: 'Salmar' });
                head.appendChild(name);
                // personality label next to Salmar with color
                const hue = personalityHues[state.personality] ?? 275;
                const pill = el('span', 'ml-2 text-xs px-2 py-0.5 rounded-full', { text: personalities[state.personality] });
                pill.style.background = `hsla(${hue},100%,70%,0.15)`;
                pill.style.color = `hsla(${hue},100%,75%,0.95)`;
                pill.style.border = `1px solid hsla(${hue},100%,60%,0.3)`;
                head.appendChild(pill);
                if (encrypted) {
                    const lock = el('div', 'ml-auto text-xs opacity-80 flex items-center gap-1');
                    lock.innerHTML = `<i data-lucide="lock" class="w-3.5 h-3.5"></i> Encrypted`;
                    head.appendChild(lock);
                }
            } else {
                head.appendChild(el('div', 'text-sm opacity-80', { text: 'You' }));
            }
            card.appendChild(head);

            const p = el('div', 'whitespace-pre-wrap leading-relaxed message-content');
            p.textContent = text || '';
            card.appendChild(p);

            if (attachments.length) {
                const wrap = el('div', 'mt-3 grid grid-cols-1 sm:grid-cols-2 gap-2');
                attachments.forEach(att => {
                    const at = el('div', 'glass rounded-xl p-2 text-sm flex gap-2 items-start');
                    if (att.type === 'video' && att.url) {
                        at.innerHTML = `<i data-lucide="video" class="w-4 h-4 mt-1"></i>
      <div class="flex-1">
       <div class="font-medium truncate mb-1">${escapeHtml(att.name || 'video.webm')}</div>
       <video controls class="w-full rounded-lg" src="${att.url}"></video>
      </div>`;
                    } else if (att.type === 'audio' && att.url) {
                        at.innerHTML = `<i data-lucide="audio-lines" class="w-4 h-4 mt-1"></i>
      <div class="flex-1">
       <div class="font-medium truncate mb-1">${escapeHtml(att.name || 'audio.webm')}</div>
       <audio controls class="w-full" src="${att.url}"></audio>
      </div>`;
                    } else if (att.type === 'image' && att.url) {
                        at.innerHTML = `<i data-lucide="image" class="w-4 h-4 mt-1"></i>
       <div class="flex-1">
        <div class="font-medium truncate mb-1">${escapeHtml(att.name || 'image.png')}</div>
        <img alt="${escapeHtml(att.name || 'image')}" src="${att.url}" class="w-full rounded-lg object-contain max-h-48"/>
       </div>`;
                    } else {
                        at.innerHTML = `<i data-lucide="${att.icon || 'file'}" class="w-4 h-4"></i>
      <span class="truncate">${escapeHtml(att.name || 'file')}</span>`;
                    }
                    wrap.appendChild(at);
                });
                card.appendChild(wrap);
            }

            const bar = el('div', 'message-actions mt-3 pt-2 border-t border-white/10 flex items-center gap-1 flex-wrap opacity-0 group-hover:opacity-100 pointer-events-none group-hover:pointer-events-auto transition-opacity');
            if (role === 'user') {
                const bCopy = actionButton('copy', 'Copy', () => copyMessage(card), 'bg-white/5');
                const bEdit = actionButton('pencil', 'Edit', () => startEditUserMessage(card));
                const bDel = actionButton('trash-2', 'Remove', () => deleteMessage(row));
                bar.append(bCopy, bEdit, bDel);
            } else {
                const bCopy = actionButton('copy', 'Copy', () => copyMessage(card));
                const bLike = actionIcon('thumbs-up', 'Like', () => { }, false); bLike.dataset.action = 'like';
                const bDis = actionIcon('thumbs-down', 'Dislike', () => { }, false); bDis.dataset.action = 'dislike';
                bLike.addEventListener('click', () => applyReactionToggle(bLike, bDis, 'like'));
                bDis.addEventListener('click', () => applyReactionToggle(bLike, bDis, 'dislike'));
                const bShare = actionButton('share-2', 'Share', () => shareMessage(card));
                const bRegen = actionButton('refresh-ccw', 'Regenerate', () => {
                    const prompt = getPreviousUserTextFromRow(row) || getCardText(card);
                    regenerateAIInto(card, prompt);
                });
                const moreWrap = el('div', 'relative');
                const bMore = actionButton('more-horizontal', 'More', () => { }, '');
                bMore.dataset.action = 'more';
                bMore.setAttribute('aria-haspopup', 'true');
                bMore.setAttribute('aria-expanded', 'false');
                const moreMenu = el('div', 'menu ai-more-menu absolute right-0 mt-2 w-52 glass-strong rounded-xl p-1', { 'data-open': 'false', role: 'menu' });
                const itemRead = el('button', 'w-full text-left px-3 py-2 rounded-lg hover:bg-white/5 flex items-center gap-2', { role: 'menuitem' });
                itemRead.innerHTML = `<i data-lucide="volume-2" class="w-4 h-4"></i> Read aloud`;
                itemRead.dataset.action = 'read';
                const itemBranch = el('button', 'w-full text-left px-3 py-2 rounded-lg hover:bg-white/5 flex items-center gap-2', { role: 'menuitem' });
                itemBranch.innerHTML = `<i data-lucide="git-branch" class="w-4 h-4"></i> Branch in new chat`;
                itemBranch.dataset.action = 'branch';
                moreMenu.append(itemRead, itemBranch);
                moreWrap.append(bMore, moreMenu);
                bar.append(bCopy, bLike, bDis, bShare, bRegen, moreWrap);
            }
            card.appendChild(bar);
            row.appendChild(card);
            chatScroll.appendChild(row);
            lucide.createIcons();
            wireMessageActionButtons(card);
            scrollToBottom();
            return card;
        }

        function pushUserMessage(text, attachments = []) {
            const card = createMessage({ role: 'user', text, attachments });
            ensureSessionForUserText(text);
            saveMessage('user', text, attachments, false);
            return card;
        }
        function pushSalmarMessage(text) {
            ensureSessionExists();
            const card = createMessage({ role: 'salmar', text });
            saveMessage('salmar', text, [], state.encrypted);
            return card;
        }
        function pushSystemMessage(text) {
            const row = el('div', 'flex justify-center');
            const card = el('div', 'text-xs opacity-80 px-3 py-1 rounded-full glass');
            card.textContent = text; row.appendChild(card);
            chatScroll.appendChild(row);
            scrollToBottom();
            return card;
        }
        function scrollToBottom() { chatScroll.scrollTo({ top: chatScroll.scrollHeight, behavior: 'smooth' }); }

        /* Simple transformations (kept for future use) */
        function summarize(card) {
            const contentEl = card.querySelector('div.whitespace-pre-wrap');
            if (!contentEl) return;
            const text = contentEl.textContent.trim();
            const sentences = text.split(/(?<=[.!?])\s+/).filter(Boolean);
            const sum = sentences.slice(0, Math.max(1, Math.floor(sentences.length / 3))).join(' ');
            contentEl.textContent = sum + (sentences.length > 1 ? ' …' : '');
        }
        function expand(card) {
            const contentEl = card.querySelector('div.whitespace-pre-wrap');
            if (!contentEl) return;
            contentEl.textContent = contentEl.textContent + '\n\nFurther details: ' + generateContent('detailed', 'expansion');
        }
        function translate(card) {
            const contentEl = card.querySelector('div.whitespace-pre-wrap'); if (!contentEl) return;
            const t = contentEl.textContent;
            contentEl.textContent = `[Translated preview] ${t}`;
        }
        function rewrite(card) {
            const contentEl = card.querySelector('div.whitespace-pre-wrap'); if (!contentEl) return;
            const t = contentEl.textContent;
            contentEl.textContent = t.replace(/\b(can|will|should)\b/gi, (m) => ({ can: 'is able to', will: 'is going to', should: 'is recommended to' }[m.toLowerCase()] || m));
        }

        /* Escape helper */
        function escapeHtml(str) {
            return String(str).replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));
        }

        /* Input auto-resize */
        const chatInput = $('#chatInput');
        chatInput.addEventListener('input', () => {
            chatInput.style.height = 'auto';
            chatInput.style.height = Math.min(200, chatInput.scrollHeight) + 'px';
        });

        /* Send handler (avoids double response) */
        $('#chatForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = chatInput.value.trim();
            if (!text) return;
            chatInput.value = '';
            chatInput.style.height = 'auto';
            pushUserMessage(text);
            setOrbState('processing');
            await simulateAI(text);
            if (state.autorunWorkflow && state.workflow.length) {
                runWorkflowSequence();
            }
            setOrbState('ready');
            setTimeout(() => setOrbState('idle'), 1000);
        });

        /* Upload */
        $('#uploadBtn').addEventListener('click', () => $('#fileInput').click());
        $('#fileInput').addEventListener('change', (e) => {
            const files = Array.from(e.target.files || []);
            if (!files.length) return;
            const att = files.map(f => {
                const ext = (f.name.split('.').pop() || '').toLowerCase();
                const url = URL.createObjectURL(f);
                if (['png', 'jpg', 'jpeg', 'gif', 'webp'].includes(ext)) return { name: f.name, icon: 'image', type: 'image', url };
                if (['mp4', 'webm', 'mov'].includes(ext)) return { name: f.name, icon: 'video', type: 'video', url };
                if (['mp3', 'wav', 'ogg', 'm4a'].includes(ext)) return { name: f.name, icon: 'audio-lines', type: 'audio', url };
                return { name: f.name, icon: fileIconFor(f.name) };
            });
            pushUserMessage('Uploaded files.', att);
            e.target.value = '';
            toast('Files attached');
        });

        /* Advanced drawer (v2) */
        const drawerRoot = $('#advancedDrawer');
        const drawerPanel = $('#advancedDrawer .drawer-panel');
        const drawerScroll = $('#advancedDrawer .drawer-scroll');
        const openDrawer = () => {
            drawerRoot.style.pointerEvents = 'auto';
            drawerPanel.classList.add('open');
            drawerPanel.setAttribute('aria-hidden', 'false');
            document.body.classList.add('advanced-open');
            drawerScroll.scrollTo({ top: 0, behavior: 'instant' });
        };
        const closeDrawer = () => {
            drawerPanel.classList.remove('open');
            drawerPanel.setAttribute('aria-hidden', 'true');
            document.body.classList.remove('advanced-open');
            setTimeout(() => { drawerRoot.style.pointerEvents = 'none'; }, 300);
        };
        $('#advancedBtn').addEventListener('click', openDrawer);
        $('#drawerClose').addEventListener('click', closeDrawer);
        $('#jumpTop').addEventListener('click', () => drawerScroll.scrollTo({ top: 0, behavior: 'smooth' }));
        $('#jumpBottom').addEventListener('click', () => drawerScroll.scrollTo({ top: drawerScroll.scrollHeight, behavior: 'smooth' }));

        /* Drawer Search (filter highlight) */
        $('#advSearch').addEventListener('input', (e) => {
            const q = e.target.value.toLowerCase().trim();
            const cards = $$('.drawer-scroll .glass.rounded-2xl');
            cards.forEach(card => {
                const text = (card.textContent || '').toLowerCase();
                const hit = text.includes(q);
                card.style.outline = hit && q ? `2px solid ${getComputedStyle(document.documentElement).getPropertyValue('--glow')}` : '';
                card.style.opacity = q ? (hit ? '1' : '0.55') : '1';
            });
        });

        /* Drawer Export/Import Settings */
        $('#advExport').addEventListener('click', () => {
            const data = JSON.stringify({
                mode: state.mode,
                personality: state.personality,
                responseStyle: state.responseStyle, outputFormat: state.outputFormat,
                aiMode: state.aiMode,
                biometric: state.biometric, encrypted: state.encrypted,
                lockOutputs: state.lockOutputs,
                memoryLongTerm: state.memoryLongTerm,
                humanize: state.humanize,
                genSpeed: state.genSpeed,
                pii: state.pii,
                safety: state.safety,
                ctxWindow: state.ctxWindow,
                orb: state.orb,
                ui: state.ui
            }, null, 2);
            downloadFile('salmar-settings.json', 'application/json', data);
            toast('Settings exported', 'success');
        });
        $('#advImport').addEventListener('click', async () => {
            try {
                const json = prompt('Paste settings JSON:');
                if (!json) return;
                const cfg = JSON.parse(json);
                Object.assign(state, {
                    mode: cfg.mode ?? state.mode,
                    personality: cfg.personality ?? state.personality,
                    responseStyle: cfg.responseStyle ?? state.responseStyle,
                    outputFormat: cfg.outputFormat ?? state.outputFormat,
                    aiMode: cfg.aiMode ?? state.aiMode,
                    biometric: !!cfg.biometric, encrypted: !!cfg.encrypted, lockOutputs: !!cfg.lockOutputs,
                    memoryLongTerm: !!cfg.memoryLongTerm,
                    humanize: !!cfg.humanize,
                    genSpeed: +cfg.genSpeed || state.genSpeed,
                    pii: !!cfg.pii,
                    safety: +cfg.safety || state.safety,
                    ctxWindow: +cfg.ctxWindow || state.ctxWindow,
                    orb: cfg.orb || state.orb,
                    ui: Object.assign({}, state.ui, cfg.ui || {})
                });
                personalityInput.value = state.personality;
                personalityLabel.textContent = personalities[state.personality];
                setOrbPersonalityHue(state.personality);
                accentOrbCoreByMode();
                document.documentElement.style.setProperty('--font-scale', String(state.ui.fontScale || 1));
                document.body.classList.toggle('high-contrast', !!state.ui.highContrast);
                document.body.classList.toggle('reduce-motion', !!state.ui.reducedMotion);
                updateDensityButtons();
                updateTimeFmtButtons();
                announce('Settings imported'); toast('Settings imported', 'success');
            } catch (e) { announce('Invalid JSON'); toast('Invalid JSON', 'error'); }
        });

        /* Advanced controls interactions */
        function selectGroup(container) {
            $$('#' + container + ' .btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    $$('#' + container + ' .btn').forEach(b => b.classList.remove('ring-1', 'ring-neon-violet/50'));
                    btn.classList.add('ring-1', 'ring-neon-violet/50');
                    const val = btn.dataset.value;
                    if (container === 'responseStyle') state.responseStyle = val;
                    if (container === 'aiModes') state.aiMode = val;
                    if (container === 'orbIntensity') { state.orb.intensity = val; initOrbParticles(); }
                    announce(`${container} set to ${val}`); toast(`${container.replace(/-/g, ' ')} → ${val}`, 'success');
                });
            });
        }
        selectGroup('responseStyle');
        selectGroup('aiModes');
        selectGroup('orbIntensity');

        /* Output format radios */
        $$('#outputFormat input[type="radio"]').forEach(r => {
            r.addEventListener('change', () => { if (r.checked) { state.outputFormat = r.value; announce(`Output format set to ${r.value.toUpperCase()}`); toast(`Format: ${r.value.toUpperCase()}`, 'success'); } });
        });

        /* Security toggles */
        $('#biometricToggle').addEventListener('change', () => {
            state.biometric = $('#biometricToggle').checked;
            announce(`Biometric ${state.biometric ? 'enabled' : 'disabled'}`); toast(`Biometric ${state.biometric ? 'enabled' : 'disabled'}`);
        });
        $('#encryptedToggle').addEventListener('change', () => {
            state.encrypted = $('#encryptedToggle').checked;
            announce(`Encrypted responses ${state.encrypted ? 'on' : 'off'}`); toast(`Encryption ${state.encrypted ? 'on' : 'off'}`);
        });
        $('#lockToggle').addEventListener('change', () => {
            state.lockOutputs = $('#lockToggle').checked;
            $('#chatScroll').classList.toggle('no-copy', state.lockOutputs);
            announce(`Lock outputs ${state.lockOutputs ? 'enabled' : 'disabled'}`); toast(`Lock outputs ${state.lockOutputs ? 'enabled' : 'disabled'}`);
        });
        $('#piiToggle').addEventListener('change', () => { state.pii = $('#piiToggle').checked; announce(`PII redaction ${state.pii ? 'enabled' : 'disabled'}`); toast(`PII redaction ${state.pii ? 'enabled' : 'disabled'}`); });
        $('#safetyLevel').addEventListener('input', (e) => { state.safety = +e.target.value; announce(`Safety level ${state.safety}`); });

        $('#ctxWindow').addEventListener('input', (e) => { state.ctxWindow = +e.target.value; });

        /* Memory */
        $('#memoryToggle').addEventListener('change', () => {
            state.memoryLongTerm = $('#memoryToggle').checked;
            announce(`Memory set to ${state.memoryLongTerm ? 'Long-term' : 'Short-term'}`); toast(`Memory: ${state.memoryLongTerm ? 'Long-term' : 'Short-term'}`);
        });

        /* Style refinements */
        $('#humanizeToggle').addEventListener('change', () => {
            state.humanize = $('#humanizeToggle').checked;
            announce(`Humanize responses ${state.humanize ? 'enabled' : 'disabled'}`); toast(`Humanize ${state.humanize ? 'enabled' : 'disabled'}`);
        });
        $('#genSpeed').addEventListener('input', (e) => state.genSpeed = +e.target.value);

        /* Collaboration */
        const roles = ['Viewer', 'Editor', 'Owner'];
        let selectedCollab = -1;
        function renderCollabList() {
            const list = $('#collabList');
            list.innerHTML = '';
            state.collaborators.forEach((c, idx) => {
                const item = el('div', 'glass rounded-xl p-2 flex items-center justify-between gap-2', { role: 'listitem' });
                const left = el('div', 'flex items-center gap-3');
                const avatarSeed = (c.name || 'u').toLowerCase().replace(/\s+/g, '');
                left.innerHTML = `
     <img alt="${escapeHtml(c.name)}" src="https://picsum.photos/seed/${encodeURIComponent(avatarSeed)}/40" class="h-9 w-9 rounded-full ring-2 ring-white/20" />
     <div>
      <div class="font-medium">${escapeHtml(c.name)}</div>
      <div class="text-xs opacity-70 flex items-center gap-2">
       <span class="inline-flex h-2 w-2 rounded-full ${c.online ? 'bg-emerald-400' : 'bg-gray-400'}"></span>
       ${c.online ? 'Online' : 'Offline'}
      </div>
     </div>
   `;
                const right = el('div', 'flex items-center gap-2');
                const sel = el('select', 'glass px-2 py-1 rounded-lg text-sm');
                roles.forEach(r => {
                    const opt = el('option', '', { text: r }); if (r === c.role) opt.selected = true;
                    sel.appendChild(opt);
                });
                sel.addEventListener('change', () => { c.role = sel.value; announce(`${c.name} is now ${c.role}`); toast(`${c.name}: ${c.role}`, 'success'); });
                const pick = el('button', 'btn glass px-2 py-1 rounded-lg text-xs', { 'aria-label': 'Select collaborator' });
                pick.textContent = 'Select';
                pick.addEventListener('click', () => { selectedCollab = idx; announce(`${c.name} selected`); toast(`${c.name} selected`); });
                const remove = el('button', 'btn glass px-2 py-1 rounded-lg text-xs', { 'aria-label': 'Remove collaborator' });
                remove.innerHTML = `<i data-lucide="trash-2" class="w-4 h-4"></i>`;
                remove.addEventListener('click', () => {
                    state.collaborators.splice(idx, 1); renderCollabList();
                    announce('Collaborator removed'); toast('Collaborator removed', 'success');
                });
                right.append(sel, pick, remove); item.append(left, right);
                list.appendChild(item);
            }); lucide.createIcons();
        }
        $('#inviteBtn').addEventListener('click', () => {
            const name = $('#inviteInput').value.trim();
            const role = $('#inviteRole').value;
            if (!name) return;
            state.collaborators.push({ name, role, online: Math.random() > 0.3 });
            $('#inviteInput').value = '';
            renderCollabList();
            pushSystemMessage(`Invited ${name} as ${role}.`);
            toast(`Invited ${name} (${role})`, 'success');
        });
        $('#roleViewer').addEventListener('click', () => applyQuickRole('Viewer'));
        $('#roleEditor').addEventListener('click', () => applyQuickRole('Editor'));
        $('#roleOwner').addEventListener('click', () => applyQuickRole('Owner'));
        function applyQuickRole(role) {
            if (selectedCollab < 0 || !state.collaborators[selectedCollab]) {
                announce('Select a collaborator first'); toast('Select a collaborator first', 'warn'); return;
            }
            state.collaborators[selectedCollab].role = role; renderCollabList();
            announce(`Role set to ${role}`); toast(`Role set to ${role}`, 'success');
        }

        /* Orb glow behaviors */
        $('#gbRings').addEventListener('change', (e) => state.orb.behaviors.rings = e.target.checked);
        $('#gbParticles').addEventListener('change', (e) => state.orb.behaviors.particles = e.target.checked);
        $('#gbRadiant').addEventListener('change', (e) => state.orb.behaviors.radiant = e.target.checked);

        /* Sound feedback (soft hum) */
        let audioCtx = null, hum = null;
        $('#soundToggle').addEventListener('change', async () => {
            state.orb.sound = $('#soundToggle').checked;
            if (state.orb.sound) {
                try {
                    audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
                    if (audioCtx.state === 'suspended') await audioCtx.resume();
                    hum = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    hum.type = 'sine';
                    hum.frequency.setValueAtTime(110, audioCtx.currentTime);
                    gain.gain.setValueAtTime(0.0008, audioCtx.currentTime);
                    hum.connect(gain).connect(audioCtx.destination);
                    hum.start();
                    toast('Sound feedback on');
                } catch (e) { }
            } else {
                try { hum?.stop(); hum?.disconnect(); hum = null; toast('Sound feedback off'); } catch (e) { }
            }
        });

        /* Radial Orb */
        const radial = $('#radial'); const main = $('#radialMain');
        const items = $$('.radial-item', radial);
        let radialOpen = false;
        main.addEventListener('click', () => {
            radialOpen = !radialOpen;
            radial.classList.toggle('radial-open', radialOpen);
            positionRadialItems();
        });
        function positionRadialItems() {
            const radius = 100;
            const steps = items.length;
            items.forEach((btn, i) => {
                const angle = (Math.PI / (steps + 1)) * (i + 1); // semi-circle
                const x = Math.cos(angle) * radius;
                const y = Math.sin(angle) * radius;
                btn.style.transform = radialOpen ? `translate(${-x}px, ${-y}px)` : `translate(0,0)`;
            });
        }
        items.forEach(btn => {
            tip(btn, btn.dataset.action);
            btn.addEventListener('click', () => {
                switch (btn.dataset.action) {
                    case 'new': newChat(); toast('New chat created', 'success'); break;
                    case 'upload': $('#fileInput').click(); break;
                    case 'voice': openVoiceOverlay(); break;
                    case 'collab': openDrawer(); const cc = $('#sec-collab'); if (cc) { cc.scrollIntoView({ behavior: 'smooth', block: 'center' }); flashHighlight(cc); $('#inviteInput')?.focus(); } break;
                    case 'auto': openDrawer(); $('#sec-automations')?.scrollIntoView({ behavior: 'smooth', block: 'start' }); break;
                }
            });
        });
        function flashHighlight(node) { if (!node) return; node.classList.add('ring-2', 'ring-neon-violet/50'); setTimeout(() => node.classList.remove('ring-2', 'ring-neon-violet/50'), 1200); }

        /* Orb Canvas Animation (small orb) */
        const orbCanvas = $('#orbCanvas');
        const orbCtx = orbCanvas.getContext('2d');
        const center = { x: orbCanvas.width / 2, y: orbCanvas.height / 2 };
        const orbConfig = { particles: [], t: 0, coreAccent: '#a45cff', particleHueBase: 275 };
        function initOrbParticles() {
            orbConfig.particles = [];
            const count = state.orb.intensity === 'expressive' ? 220 : state.orb.intensity === 'minimal' ? 80 : 140;
            const baseHue = personalityHues[state.personality] ?? 275;
            orbConfig.particleHueBase = baseHue;
            for (let i = 0; i < count; i++) {
                orbConfig.particles.push({
                    angle: Math.random() * Math.PI * 2, radius: 20 + Math.random() * 70,
                    speed: (0.005 + Math.random() * 0.01) * (state.orb.intensity === 'expressive' ? 2 : state.orb.intensity === 'minimal' ? 0.6 : 1),
                    size: 1 + Math.random() * 2,
                    hue: baseHue + (Math.random() * 18 - 9)
                });
            }
        }
        initOrbParticles();
        function orbCoreAccentByMode() {
            return ({
                knowledge: '#2da3ff', creative: '#ff4edb', business: '#ffbd2e',
                security: '#23d18b', integrations: '#bba8ff'
            }[state.mode] || '#a45cff');
        }
        function accentOrbCoreByMode() { orbConfig.coreAccent = orbCoreAccentByMode(); }
        function setOrbPersonalityHue(idx) {
            const hue = personalityHues[idx] ?? 275;
            orbConfig.particleHueBase = hue;
            if (orbConfig.particles?.length) for (const p of orbConfig.particles) p.hue = hue + (Math.random() * 18 - 9);
        }
        function drawOrb() {
            const ctx = orbCtx; if (!ctx) return;
            ctx.clearRect(0, 0, orbCanvas.width, orbCanvas.height);
            // core
            const grad = ctx.createRadialGradient(center.x, center.y, 10, center.x, center.y, 60);
            grad.addColorStop(0, 'rgba(255,255,255,0.9)');
            grad.addColorStop(0.12, 'rgba(200,181,255,0.9)');
            grad.addColorStop(0.55, hexToRgba(orbConfig.coreAccent, 0.66));
            grad.addColorStop(1, 'rgba(10,6,28,0)');
            ctx.beginPath(); ctx.fillStyle = grad; ctx.arc(center.x, center.y, 48, 0, Math.PI * 2); ctx.fill();

            // pulse
            const t = performance.now() / 1000;
            let pulseScale = 0;
            if (state.orb.state === 'listening') pulseScale = 2 + Math.sin(t * 3) * 1.5;
            if (state.orb.state === 'speaking') pulseScale = 2 + Math.sin(t * 7) * 2.5;
            if (pulseScale > 0) {
                ctx.beginPath();
                ctx.strokeStyle = state.orb.state === 'listening' ? 'rgba(35,209,139,0.5)' : 'rgba(255,78,78,0.5)';
                ctx.lineWidth = 2;
                ctx.arc(center.x, center.y, 60 + pulseScale, 0, Math.PI * 2);
                ctx.stroke();
            }

            // particles
            if (state.orb.behaviors.particles && (state.orb.state === 'processing' || state.orb.intensity !== 'minimal')) {
                for (const p of orbConfig.particles) {
                    p.angle += p.speed;
                    const x = center.x + Math.cos(p.angle) * p.radius;
                    const y = center.y + Math.sin(p.angle) * p.radius;
                    ctx.beginPath();
                    ctx.fillStyle = `hsla(${p.hue},100%,70%,0.75)`;
                    ctx.arc(x, y, p.size, 0, Math.PI * 2);
                    ctx.fill();
                }
            }

            // rings
            ctx.save(); ctx.translate(center.x, center.y); ctx.rotate(t * 0.2);
            ctx.strokeStyle = 'rgba(164,92,255,0.25)'; ctx.lineWidth = 1;
            for (let r = 30; r <= 70; r += 10) { ctx.beginPath(); ctx.arc(0, 0, r, Math.PI * 0.1, Math.PI * 1.6); ctx.stroke(); }
            ctx.restore();

            requestAnimationFrame(drawOrb);
        }
        requestAnimationFrame(drawOrb);
        function hexToRgba(hex, a = 1) {
            if (!hex || typeof hex !== 'string') return `rgba(164,92,255,${a})`;
            const v = hex.replace('#', '');
            const bigint = parseInt(v, 16);
            const r = (bigint >> 16) & 255;
            const g = (bigint >> 8) & 255;
            const b = bigint & 255;
            return `rgba(${r},${g},${b},${a})`;
        }
        function setOrbState(s) {
            state.orb.state = s;
            const ringListening = $('#ringListening'); const ringReady = $('#ringReady'); const ringSpeaking = $('#ringSpeaking');
            ringListening.style.opacity = (s === 'listening' && state.orb.behaviors.rings) ? 1 : 0;
            ringSpeaking.style.opacity = (s === 'speaking' && state.orb.behaviors.rings) ? 1 : 0;
            ringReady.style.opacity = (s === 'ready' && state.orb.behaviors.radiant) ? 1 : 0;
        }

        /* AI simulate (stream) — content without brackets/prompt/answer */
        async function simulateAI(prompt) {
            const delay = (ms) => new Promise(res => setTimeout(res, ms));
            const style = state.responseStyle;
            let content = generateContent(style, prompt);
            if (state.pii) content = content.replace(/\b(\d{3}[- ]?\d{2}[- ]?\d{4}|\d{16})\b/g, '[REDACTED]');
            if (state.humanize) content = humanizeText(content);
            const baseDelay = [80, 65, 45, 30, 18][state.genSpeed - 1] || 45;
            const card = pushSalmarMessage('');
            const p = card.querySelector('div.whitespace-pre-wrap') || (() => { const n = el('div', 'whitespace-pre-wrap leading-relaxed message-content'); card.insertBefore(n, card.children[1]); return n; })();
            for (let i = 0; i <= content.length; i += Math.ceil(Math.random() * 12)) {
                p.textContent = content.slice(0, i);
                await delay(baseDelay + Math.random() * baseDelay * 0.6);
            }
            p.textContent = content;
            // Update saved AI message text
            const s = getCurrentSession();
            if (s) s.messages[s.messages.length - 1].text = content;
            return content;
        }

        function generateContent(style, prompt) {
            // Compose answer only (no brackets, no Prompt/Answer labels)
            const persona = personalities[state.personality];
            const modeFlavor = {
                knowledge: 'Clear references and factual precision.',
                creative: 'Imaginative, metaphor-rich, vibrant storytelling.',
                business: 'Outcome-oriented, risks and ROI highlighted.',
                security: 'Threat-aware, best practices and compliance-centric.',
                integrations: 'Ecosystem-aware, interoperable and modular.'
            }[state.mode];
            const sections = {
                concise: `• ${prompt}
• Key insight tailored to ${persona.toLowerCase()} (${state.aiMode}).`,
                detailed: `Background
- ${prompt}
Key considerations
- Audience needs
- Constraints
Actionable steps
- Step 1
- Step 2
- Step 3
Caveats & next steps
- Validate outcomes
- Iterate`,
                step: `1) Assess: Understand "${prompt}" context
2) Plan: Outline approach (${persona.toLowerCase()}, ${state.aiMode})
3) Execute: Apply best practices
4) Validate: Measure and refine`,
                creative: `Imagine "${prompt}" unfolding like a nebula—insight threads glow in violet and magenta, weaving a graceful path to your goal.`
            };
            let ans = sections[style] || sections.concise;
            ans += `\n${state.memoryLongTerm ? 'Note: Long-term memory hints applied.' : 'Note: Short-term context only.'}`;
            return ans.trim();
        }

        function humanizeText(txt) {
            const reps = [
                [/(\b)do not(\b)/gi, '$1don’t$2'], [/(\b)does not(\b)/gi, '$1doesn’t$2'],
                [/(\b)can not(\b)/gi, '$1cannot$2'], [/(\b)cannot(\b)/gi, '$1can’t$2'], [/(\b)will not(\b)/gi, '$1won’t$2'],
                [/(\b)I am(\b)/g, '$1I’m$2'], [/(\b)you are(\b)/gi, '$1you’re$2'],
                [/(\b)we are(\b)/gi, '$1we’re$2'], [/(\b)they are(\b)/gi, '$1they’re$2'], [/(\b)it is(\b)/gi, '$1it’s$2'],
                [/(\b)that is(\b)/gi, '$1that’s$2'], [/(\b)there is(\b)/gi, '$1there’s$2'], [/(\b)let us(\b)/gi, '$1let’s$2']
            ];
            for (const [r, v] of reps) txt = txt.replace(r, v);
            txt = txt.replace(/^\s*•/gm, '–');
            return txt.trim();
        }

        /* Keyboard shortcuts */
        document.addEventListener('keydown', (e) => {
            if (e.key === '/' && document.activeElement !== chatInput) { e.preventDefault(); chatInput.focus(); }
            if (e.key === 'Escape') { closeDrawer(); closeCmdPalette(); if (voiceOverlayActive) closeVoiceOverlay(); if (recModalOpen) closeRecorder(); closeHistoryModal(); closeFeedback(); closeSettings(); }
            if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'k') { e.preventDefault(); openCmdPalette(); }
        });

        /* Command palette */
        const cmdPalette = $('#cmdPalette');
        function openCmdPalette(seed) {
            cmdPalette.classList.remove('hidden');
            cmdPalette.classList.add('flex');
            $('#cmdInput').focus();
            if (seed) { $('#cmdInput').value = seed; renderCmdResults(seed); } else { renderCmdResults(''); }
        }
        function closeCmdPalette() { cmdPalette.classList.add('hidden'); cmdPalette.classList.remove('flex'); }
        $('#cmdClose').addEventListener('click', closeCmdPalette);
        cmdPalette.addEventListener('click', (e) => { if (e.target === cmdPalette) closeCmdPalette(); });
        const commands = [
            { name: 'New chat', action: newChat, icon: 'plus-circle' },
            { name: 'Upload file', action: () => $('#fileInput').click(), icon: 'folder-up' },
            { name: 'Voice command', action: openVoiceOverlay, icon: 'mic' },
            { name: 'Open automations', action: openDrawer, icon: 'workflow' },
            { name: 'Open settings', action: openSettings, icon: 'settings' },
            { name: 'Toggle theme', action: () => $('#themeToggle').click(), icon: 'sun-moon' },
            { name: 'Help', action: () => { try { window.open('helpcenter.html', '_blank', 'noopener'); } catch (e) { } }, icon: 'help-circle' },
        ];
        function renderCmdResults(q = '') {
            const list = $('#cmdResults'); list.innerHTML = '';
            const match = q.toLowerCase();
            commands.filter(c => c.name.toLowerCase().includes(match)).forEach(c => {
                const item = el('button', 'btn glass px-3 py-2 rounded-xl flex items-center gap-2 text-left');
                item.innerHTML = `<i data-lucide="${c.icon}" class="w-5 h-5"></i><span>${c.name}</span>`;
                item.addEventListener('click', () => { c.action(); closeCmdPalette(); });
                list.appendChild(item);
            });
            lucide.createIcons();
        }
        $('#cmdInput').addEventListener('input', (e) => renderCmdResults(e.target.value));

        /* Workflow builder */
        const defaultSteps = [
            { id: cryptoRandomId(), name: 'Research', type: 'research', params: { query: '' } },
            { id: cryptoRandomId(), name: 'Summarize', type: 'summarize', params: { style: 'bullets' } },
            { id: cryptoRandomId(), name: 'Export', type: 'export', params: { format: 'md' } },
            { id: cryptoRandomId(), name: 'Email', type: 'email', params: { to: 'team@example.com' } }
        ];
        const workflow = $('#workflow');
        function renderWorkflow(steps = state.workflow) {
            workflow.innerHTML = '';
            steps.forEach((step, idx) => {
                const stepEl = el('div', 'glass px-3 py-2 rounded-xl flex flex-col gap-2 min-w-[180px]', { draggable: 'true' });
                const head = el('div', 'flex items-center gap-2');
                head.innerHTML = `<i data-lucide="grip-vertical" class="w-4 h-4 cursor-move"></i><span class="font-medium">${escapeHtml(step.name)}</span>`;
                const tools = el('div', 'ml-auto flex items-center gap-1');
                const editBtn = el('button', 'btn glass h-8 w-8 rounded-lg flex items-center justify-center', { title: 'Edit' });
                editBtn.innerHTML = `<i data-lucide="pencil" class="w-4 h-4"></i>`;
                const delBtn = el('button', 'btn glass h-8 w-8 rounded-lg flex items-center justify-center', { title: 'Delete' });
                delBtn.innerHTML = `<i data-lucide="trash-2" class="w-4 h-4"></i>`;
                tools.append(editBtn, delBtn);
                head.appendChild(tools);
                stepEl.appendChild(head);
                const cfg = el('div', 'hidden mt-1 space-y-2 text-sm');
                cfg.innerHTML = stepConfigFields(step);
                stepEl.appendChild(cfg);
                stepEl.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', step.id); stepEl.classList.add('ring-2', 'ring-neon-violet/50');
                });
                stepEl.addEventListener('dragend', () => stepEl.classList.remove('ring-2', 'ring-neon-violet/50'));
                stepEl.addEventListener('dragover', (e) => e.preventDefault());
                stepEl.addEventListener('drop', (e) => { e.preventDefault(); const fromId = e.dataTransfer.getData('text/plain'); const fromIdx = state.workflow.findIndex(s => s.id === fromId); const toIdx = idx; moveStep(fromIdx, toIdx); });
                editBtn.addEventListener('click', () => { cfg.classList.toggle('hidden'); });
                delBtn.addEventListener('click', () => { state.workflow.splice(idx, 1); renderWorkflow(); });
                workflow.appendChild(stepEl);
                cfg.querySelectorAll('[data-key]').forEach(input => {
                    input.addEventListener('input', () => { const key = input.getAttribute('data-key'); step.params[key] = input.value; });
                });
            });
            lucide.createIcons();
        }
        function stepConfigFields(step) {
            if (step.type === 'research') { return `<label class="flex items-center gap-2">Query <input data-key="query" value="${escapeHtml(step.params.query || '')}" class="flex-1 glass px-2 py-1 rounded-lg"/></label>`; }
            if (step.type === 'summarize') {
                return `<label class="flex items-center gap-2">Style
    <select data-key="style" class="glass px-2 py-1 rounded-lg">
     <option ${step.params.style === 'bullets' ? 'selected' : ''}>bullets</option>
     <option ${step.params.style === 'concise' ? 'selected' : ''}>concise</option>
     <option ${step.params.style === 'detailed' ? 'selected' : ''}>detailed</option>
    </select>
   </label>`;
            }
            if (step.type === 'export') {
                return `<label class="flex items-center gap-2">Format
    <select data-key="format" class="glass px-2 py-1 rounded-lg">
     <option ${step.params.format === 'md' ? 'selected' : ''}>md</option>
     <option ${step.params.format === 'pdf' ? 'selected' : ''}>pdf</option>
     <option ${step.params.format === 'json' ? 'selected' : ''}>json</option>
    </select>
   </label>`;
            }
            if (step.type === 'email') {
                return `<label class="flex items-center gap-2">To <input data-key="to" value="${escapeHtml(step.params.to || '')}" class="flex-1 glass px-2 py-1 rounded-lg"/></label>`;
            }
            return `<div class="opacity-70">No extra settings.</div>`;
        }
        function moveStep(from, to) {
            if (from === to || from < 0 || to < 0) return;
            const steps = state.workflow;
            const [sp] = steps.splice(from, 1);
            steps.splice(to, 0, sp);
            renderWorkflow(steps);
        }
        function getSteps() { return state.workflow; }
        function setSteps(steps) { state.workflow = steps; }
        $('#addStep').addEventListener('click', () => {
            const choice = prompt('Add step type: research, summarize, export, email, or custom\n(you can also type a custom name)');
            if (!choice) return;
            const type = choice.toLowerCase().trim();
            let step;
            if (['research', 'summarize', 'export', 'email'].includes(type)) {
                step = { id: cryptoRandomId(), name: capitalize(type), type, params: {} };
                if (type === 'summarize') step.params = { style: 'bullets' };
                if (type === 'export') step.params = { format: 'md' };
                if (type === 'email') step.params = { to: 'team@example.com' };
                if (type === 'research') step.params = { query: '' };
            } else {
                step = { id: cryptoRandomId(), name: choice, type: 'custom', params: {} };
            }
            state.workflow.push(step);
            renderWorkflow();
        });
        $('#runWorkflow').addEventListener('click', runWorkflowSequence);
        $('#exportWorkflow').addEventListener('click', () => {
            const data = JSON.stringify(state.workflow, null, 2);
            downloadFile('workflow.json', 'application/json', data);
            toast('Workflow exported', 'success');
        });
        $('#importWorkflow').addEventListener('click', async () => {
            try {
                const json = prompt('Paste workflow JSON:');
                if (!json) return;
                const steps = JSON.parse(json);
                if (!Array.isArray(steps)) throw new Error('Invalid format');
                steps.forEach(s => { if (!s.id) s.id = cryptoRandomId(); });
                state.workflow = steps;
                renderWorkflow();
                announce('Workflow imported'); toast('Workflow imported', 'success');
            } catch (e) { announce('Invalid JSON'); toast('Invalid JSON', 'error'); }
        });
        $('#autorunWorkflow').addEventListener('change', (e) => { state.autorunWorkflow = e.target.checked; });

        async function runWorkflowSequence() {
            const steps = getSteps();
            if (!steps.length) return;
            $('#workflowProgress').classList.remove('hidden');
            const bar = $('#workflowBar');
            const status = $('#workflowStatus');
            pushSystemMessage('Running workflow: ' + steps.map(s => s.name).join(' → '));
            setOrbState('processing');
            for (let i = 0; i < steps.length; i++) {
                const s = steps[i];
                status.textContent = `Running: ${s.name}`;
                bar.style.width = `${Math.floor((i / steps.length) * 100)}%`;
                await new Promise(r => setTimeout(r, 350));
                let txt = generateContent('concise', s.name + ' • ' + JSON.stringify(s.params));
                if (state.humanize) txt = humanizeText(txt);
                pushSalmarMessage(`Step "${s.name}" completed.\n${txt}`);
            }
            bar.style.width = '100%';
            status.textContent = 'Completed';
            setTimeout(() => { $('#workflowProgress').classList.add('hidden'); bar.style.width = '0%'; }, 800);
            setOrbState('ready');
            setTimeout(() => setOrbState('idle'), 800);
            toast('Workflow completed', 'success');
        }

        /* Voice & Video Multi-Function Menu */
        const voiceBtn = $('#voiceBtn'); const voiceMenu = $('#voiceMenu');
        const voiceMenuCtl = setupMenu(voiceBtn, voiceMenu);
        $('#menuDictate').addEventListener('click', () => { voiceMenuCtl.close(); startBarDictation(); });
        $('#menuVoiceOrb').addEventListener('click', () => { voiceMenuCtl.close(); openVoiceOverlay(); });
        $('#menuRecordVideo').addEventListener('click', () => { voiceMenuCtl.close(); openRecorder({ mode: 'video' }); });
        $('#menuRecordAudio').addEventListener('click', () => { voiceMenuCtl.close(); openRecorder({ mode: 'audio' }); });
        tip(voiceBtn, 'Record video or audio • Dictate text • Open voice orb');

        /* Recorder: Video/Audio capture and attach */
        let recModalOpen = false;
        let recStream = null;
        let recRecorder = null;
        let recChunks = [];
        let recBlob = null;
        let recUrl = '';
        let recTimerInt = null;
        let recStartAt = 0;
        let meterAnalyzer = null;
        let meterData = null;
        let meterRAF = null;
        let recMode = 'video';
        const recModal = $('#recorderModal');
        const recPreview = $('#recPreview');
        const btnStart = $('#btnStart');
        const btnStop = $('#btnStop');
        const btnRetake = $('#btnRetake');
        const btnAttach = $('#btnAttach');
        const btnDownload = $('#btnDownload');
        const recStatus = $('#recStatus');
        const recTimer = $('#recTimer');
        const audioMeter = $('#audioMeter');
        const camSelect = $('#camSelect');
        const micSelect = $('#micSelect');
        const resSelect = $('#resSelect');
        const videoToggle = $('#videoToggle');
        const countToggle = $('#countdownToggle');
        function formatTime(ms) { const s = Math.floor(ms / 1000); const mm = String(Math.floor(s / 60)).padStart(2, '0'); const ss = String(s % 60).padStart(2, '0'); return `${mm}:${ss}`; }
        async function enumerateDevicesSafe() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const cams = devices.filter(d => d.kind === 'videoinput'); const mics = devices.filter(d => d.kind === 'audioinput');
                camSelect.innerHTML = ''; micSelect.innerHTML = '';
                mics.forEach((d, i) => micSelect.appendChild(el('option', '', { value: d.deviceId, text: d.label || `Microphone ${i + 1}` })));
                cams.forEach((d, i) => camSelect.appendChild(el('option', '', { value: d.deviceId, text: d.label || `Camera ${i + 1}` })));
                if (!cams.length) camSelect.appendChild(el('option', '', { value: '', text: 'No camera found' }));
                if (!mics.length) micSelect.appendChild(el('option', '', { value: '', text: 'No mic found' }));
            } catch (e) {
                camSelect.innerHTML = `<option value="">Default Camera</option>`; micSelect.innerHTML = `<option value="">Default Mic</option>`;
            }
        }
        async function buildConstraints() {
            const [w, h] = (resSelect.value || '1280x720').split('x').map(n => +n || 0);
            const video = (recMode === 'video' && videoToggle.checked) ? {
                width: { ideal: w }, height: { ideal: h },
                deviceId: camSelect.value ? { exact: camSelect.value } : undefined
            } : false;
            const audio = {
                echoCancellation: true, noiseSuppression: true, autoGainControl: true,
                deviceId: micSelect.value ? { exact: micSelect.value } : undefined
            };
            return { video, audio };
        }
        async function startPreview() {
            try {
                stopTracks();
                const cons = await buildConstraints();
                const stream = await navigator.mediaDevices.getUserMedia(cons);
                recStream = stream;
                recPreview.srcObject = stream;
                recPreview.muted = true;
                recPreview.play().catch(() => { });
                setupAudioMeter(stream);
                btnStart.disabled = !MediaRecorderSupport();
                recStatus.textContent = 'Preview ready';
            } catch (e) {
                recStatus.textContent = 'Permission denied or device unavailable';
                btnStart.disabled = true;
            }
        }
        function setupAudioMeter(stream) {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const src = ctx.createMediaStreamSource(stream);
                meterAnalyzer = ctx.createAnalyser();
                meterAnalyzer.fftSize = 2048;
                meterData = new Uint8Array(meterAnalyzer.frequencyBinCount);
                src.connect(meterAnalyzer);
                const draw = () => {
                    if (!meterAnalyzer) return;
                    meterAnalyzer.getByteTimeDomainData(meterData);
                    let sum = 0;
                    for (let i = 0; i < meterData.length; i++) { const v = (meterData[i] - 128) / 128; sum += v * v; }
                    const rms = Math.sqrt(sum / meterData.length);
                    const level = Math.min(1, rms * 4);
                    audioMeter.style.transform = `scaleX(${level.toFixed(3)})`;
                    meterRAF = requestAnimationFrame(draw);
                };
                cancelAnimationFrame(meterRAF); meterRAF = requestAnimationFrame(draw);
            } catch (e) { }
        }
        function teardownMeter() { cancelAnimationFrame(meterRAF); meterRAF = null; meterAnalyzer = null; meterData = null; audioMeter.style.transform = 'scaleX(0)'; }
        function MediaRecorderSupport() { return typeof MediaRecorder !== 'undefined'; }
        async function startRecording() {
            if (!recStream || !MediaRecorderSupport()) { announce('Recording not supported'); toast('Recording not supported', 'error'); return; }
            if (countToggle.checked) {
                recStatus.textContent = 'Starting in 3…'; await new Promise(r => setTimeout(r, 800));
                recStatus.textContent = 'Starting in 2…'; await new Promise(r => setTimeout(r, 800));
                recStatus.textContent = 'Starting in 1…'; await new Promise(r => setTimeout(r, 800));
            }
            recChunks = []; recBlob = null; recUrl = '';
            const mime = recMode === 'audio' ? 'audio/webm' : 'video/webm';
            try { recRecorder = new MediaRecorder(recStream, { mimeType: mime }); } catch (e) { recRecorder = new MediaRecorder(recStream); }
            recRecorder.ondataavailable = (e) => { if (e.data?.size) recChunks.push(e.data); };
            recRecorder.onstop = onRecordingStop;
            recRecorder.start(250);
            recStartAt = Date.now();
            recTimer.textContent = '00:00';
            recStatus.textContent = recMode === 'audio' ? 'Recording audio…' : 'Recording video…';
            btnStart.disabled = true; btnStop.disabled = false; btnRetake.disabled = true; btnAttach.disabled = true; btnDownload.disabled = true;
            const tick = () => {
                const elapsed = Date.now() - recStartAt;
                recTimer.textContent = formatTime(elapsed);
                if (elapsed >= 5 * 60 * 1000) { stopRecording(); return; }
                if (recRecorder && recRecorder.state === 'recording') requestAnimationFrame(tick);
            };
            requestAnimationFrame(tick);
        }
        function stopRecording() { try { recRecorder?.stop(); } catch (e) { } }
        function onRecordingStop() {
            try { recBlob = new Blob(recChunks, { type: recMode === 'audio' ? 'audio/webm' : 'video/webm' }); } catch (e) { recBlob = new Blob(recChunks); }
            if (recUrl) URL.revokeObjectURL(recUrl);
            recUrl = URL.createObjectURL(recBlob);
            if (recMode === 'audio') {
                recPreview.pause();
                recPreview.srcObject = null;
                recPreview.removeAttribute('srcObject');
                recPreview.src = '';
            }
            recStatus.textContent = 'Recording ready';
            btnStart.disabled = false; btnStop.disabled = true; btnRetake.disabled = false; btnAttach.disabled = false; btnDownload.disabled = false;
            toast('Recording ready', 'success');
        }
        function stopTracks() {
            try { recStream?.getTracks().forEach(t => t.stop()); } catch (e) { }
            recStream = null;
            recPreview.pause();
            try { recPreview.srcObject = null; } catch (e) { }
        }
        function clearRecording() {
            if (recUrl) { try { URL.revokeObjectURL(recUrl); } catch (e) { } recUrl = ''; }
            recBlob = null; recChunks = [];
            btnAttach.disabled = true; btnDownload.disabled = true; btnRetake.disabled = true;
            recStatus.textContent = 'Ready';
        }
        async function openRecorder({ mode = 'video' } = {}) {
            recMode = mode;
            recModal.classList.add('active');
            recModalOpen = true;
            document.body.style.overflow = 'hidden';
            btnStart.disabled = true; btnStop.disabled = true; btnRetake.disabled = true; btnAttach.disabled = true; btnDownload.disabled = true;
            $(`input[name="recMode"][value="${mode}"]`).checked = true;
            await enumerateDevicesSafe();
            await startPreview();
            if (recMode === 'audio') videoToggle.checked = false;
            lucide.createIcons();
        }
        function closeRecorder() {
            recModalOpen = false;
            recModal.classList.remove('active');
            document.body.style.overflow = '';
            stopTracks(); teardownMeter(); clearRecording();
        }
        $('#recClose').addEventListener('click', closeRecorder);
        recModal.addEventListener('click', (e) => { if (e.target === recModal) closeRecorder(); });
        ;[camSelect, micSelect, resSelect, videoToggle].forEach(elm => elm.addEventListener('change', () => startPreview()));
        $$('input[name="recMode"]').forEach(r => r.addEventListener('change', (e) => { recMode = e.target.value; startPreview(); }));
        btnStart.addEventListener('click', startRecording);
        btnStop.addEventListener('click', stopRecording);
        btnRetake.addEventListener('click', () => { clearRecording(); startPreview(); });
        btnAttach.addEventListener('click', () => {
            if (!recBlob) return;
            const name = recMode === 'audio' ? `audio-${Date.now()}.webm` : `video-${Date.now()}.webm`;
            const attachment = { name, icon: recMode === 'audio' ? 'audio-lines' : 'video', type: recMode, url: recUrl };
            pushUserMessage(recMode === 'audio' ? 'Sent an audio message.' : 'Sent a video message.', [attachment]);
            toast('Recording attached', 'success');
            closeRecorder();
        });
        btnDownload.addEventListener('click', () => {
            if (recBlob) downloadFile(recMode === 'audio' ? 'audio.webm' : 'video.webm', recBlob.type || 'application/octet-stream', recBlob);
        });

        /* Voice dictation (text only) */
        let recognition = null;
        let recognizing = false;
        let voiceBarAccumulated = '';
        function startBarDictation() {
            if (recognizing) { try { recognition.stop(); } catch (e) { } return; }
            try {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) { announce('Voice recognition not supported. Try the Voice Orb or Recorder.'); toast('Voice recognition not supported', 'warn'); return; }
                recognition = new SpeechRecognition();
                recognition.lang = 'en-US';
                recognition.interimResults = true;
                recognition.continuous = true;
                voiceBarAccumulated = '';
                recognition.onstart = () => { recognizing = true; voiceBtn.setAttribute('aria-pressed', 'true'); voiceBtn.classList.add('ring-2', 'ring-emerald-400'); setOrbState('listening'); announce('Voice listening'); toast('Dictation started'); };
                recognition.onresult = (event) => {
                    let interim = '';
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const tr = event.results[i][0].transcript;
                        if (event.results[i].isFinal) voiceBarAccumulated += (voiceBarAccumulated ? ' ' : '') + tr; else interim += tr;
                    }
                    chatInput.value = (voiceBarAccumulated + (interim ? ' ' + interim : '')).trim();
                    chatInput.style.height = 'auto'; chatInput.style.height = Math.min(200, chatInput.scrollHeight) + 'px';
                };
                recognition.onerror = () => { recognizing = false; voiceBtn.setAttribute('aria-pressed', 'false'); voiceBtn.classList.remove('ring-2', 'ring-emerald-400'); setOrbState('idle'); toast('Dictation error', 'error'); };
                recognition.onend = () => {
                    recognizing = false;
                    voiceBtn.setAttribute('aria-pressed', 'false');
                    voiceBtn.classList.remove('ring-2', 'ring-emerald-400');
                    setOrbState('idle');
                    if (voiceBarAccumulated.trim()) {
                        chatInput.value = voiceBarAccumulated.trim();
                        $('#chatForm').dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));
                    } else {
                        toast('Dictation ended');
                    }
                };
                recognition.start();
            } catch (e) { announce('Voice not available'); toast('Voice not available', 'warn'); }
        }

        /* -------- Voice Orb (core) -------- */
        let voiceOverlayActive = false;
        let voiceStream = null;
        let voiceAudioCtx = null;
        let voiceAnalyser = null;
        let voiceData = null;
        let voiceCanvas, voiceCtx, voiceCenter, voiceRadius;
        let voiceRec = null;
        let overlayTranscript = '';
        let speaking = false;
        let ttsUtterance = null;
        let synth = window.speechSynthesis || null;
        let visualizerAmp = 0;
        let voiceDecoParticles = [];
        function initVoiceDecoParticles() {
            const count = 120;
            voiceDecoParticles = Array.from({ length: count }, () => ({
                angle: Math.random() * Math.PI * 2,
                dist: (0.5 + Math.random() * 1.6) * voiceRadius,
                speed: 0.2 + Math.random() * 0.45,
                size: 1 + Math.random() * 2,
                hue: 240 + Math.random() * 120
            }));
        }
        function resizeVoiceCanvas() {
            const c = $('#voiceCanvas');
            c.width = Math.floor(window.innerWidth * (window.devicePixelRatio || 1));
            c.height = Math.floor(window.innerHeight * (window.devicePixelRatio || 1));
            voiceCenter = { x: c.width / 2, y: c.height / 2 - Math.min(c.height * 0.08, 80) };
            voiceRadius = Math.min(c.width, c.height) * 0.18;
            initVoiceDecoParticles();
        }
        let prevAmp = 0.02;
        function drawVoiceOrb() {
            if (!voiceCtx) return; const c = voiceCanvas;
            voiceCtx.clearRect(0, 0, c.width, c.height);
            const baseColor = speaking ? 'rgba(255,78,78,0.22)' : 'rgba(35,209,139,0.22)';
            const ringColor = speaking ? 'rgba(255,78,78,0.85)' : 'rgba(35,209,139,0.85)';
            const bgGrad = voiceCtx.createRadialGradient(voiceCenter.x, voiceCenter.y, voiceRadius * 0.5, voiceCenter.x, voiceCenter.y, voiceRadius * 2.4);
            bgGrad.addColorStop(0, 'rgba(255,255,255,0.08)'); bgGrad.addColorStop(0.4, baseColor); bgGrad.addColorStop(1, 'rgba(0,0,0,0)');
            voiceCtx.beginPath(); voiceCtx.fillStyle = bgGrad; voiceCtx.arc(voiceCenter.x, voiceCenter.y, voiceRadius * 1.9, 0, Math.PI * 2); voiceCtx.fill();

            const t = performance.now() / 1000;
            voiceCtx.save(); voiceCtx.translate(voiceCenter.x, voiceCenter.y); voiceCtx.rotate(t * 0.15);
            for (let i = 1; i <= 5; i++) {
                voiceCtx.beginPath(); voiceCtx.strokeStyle = `rgba(164,92,255,${0.08 * i})`; voiceCtx.lineWidth = 0.6; voiceCtx.arc(0, 0, voiceRadius * 0.55 + i * 9, Math.PI * 0.12 * i, Math.PI * (2 - 0.12 * i)); voiceCtx.stroke();
            }
            voiceCtx.restore();

            const coreGrad = voiceCtx.createRadialGradient(voiceCenter.x, voiceCenter.y, voiceRadius * 0.08, voiceCenter.x, voiceCenter.y, voiceRadius);
            coreGrad.addColorStop(0, 'rgba(255,255,255,0.9)');
            coreGrad.addColorStop(0.25, speaking ? 'rgba(255,140,140,0.95)' : 'rgba(180,255,220,0.95)');
            coreGrad.addColorStop(0.9, speaking ? 'rgba(255,78,78,0.45)' : 'rgba(35,209,139,0.45)');
            coreGrad.addColorStop(1, 'rgba(0,0,0,0)');
            voiceCtx.beginPath(); voiceCtx.fillStyle = coreGrad; voiceCtx.arc(voiceCenter.x, voiceCenter.y, voiceRadius, 0, Math.PI * 2); voiceCtx.fill();

            // glow ring
            let amp = 0.02;
            if (!speaking && voiceAnalyser && voiceData) {
                voiceAnalyser.getByteTimeDomainData(voiceData);
                let sumSq = 0;
                for (let i = 0; i < voiceData.length; i++) { const v = (voiceData[i] - 128) / 128; sumSq += v * v; }
                const rms = Math.sqrt(sumSq / voiceData.length);
                amp = Math.min(0.45, (rms * 3.0) + 0.02);
            } else {
                visualizerAmp = visualizerAmp * 0.85 + Math.abs(Math.sin(t * 6)) * 0.12 + 0.02; amp = Math.min(0.45, visualizerAmp);
            }
            amp = prevAmp * 0.7 + amp * 0.3; prevAmp = amp;
            const segments = 260; const baseR = voiceRadius * 1.2;
            voiceCtx.beginPath();
            for (let i = 0; i <= segments; i++) {
                const angle = (i / segments) * Math.PI * 2; let modulation = 1;
                if (!speaking && voiceData) {
                    const idx = Math.floor((i / segments) * voiceData.length) | 0;
                    modulation = 1 + ((voiceData[idx] - 128) / 128) * amp;
                } else {
                    modulation = 1 + Math.sin(angle * 6 + t * 4) * amp;
                }
                const r = baseR * modulation; const x = voiceCenter.x + Math.cos(angle) * r;
                const y = voiceCenter.y + Math.sin(angle) * r;
                if (i === 0) voiceCtx.moveTo(x, y); else voiceCtx.lineTo(x, y);
            }
            voiceCtx.closePath();
            voiceCtx.strokeStyle = ringColor; voiceCtx.lineWidth = Math.max(1, voiceRadius * 0.018); voiceCtx.shadowColor = ringColor; voiceCtx.shadowBlur = 24;
            voiceCtx.stroke(); voiceCtx.shadowBlur = 0;

            voiceCtx.save(); voiceCtx.globalCompositeOperation = 'lighter';
            for (const p of voiceDecoParticles) {
                p.angle += (p.speed * 0.005) * (1 + amp * 2);
                const x = voiceCenter.x + Math.cos(p.angle) * (p.dist + Math.sin(t * 1.5 + p.angle) * 6);
                const y = voiceCenter.y + Math.sin(p.angle) * (p.dist + Math.cos(t * 1.2 + p.angle) * 6);
                voiceCtx.beginPath(); voiceCtx.fillStyle = `hsla(${p.hue},100%,70%,${speaking ? 0.35 : 0.25})`; voiceCtx.arc(x, y, p.size, 0, Math.PI * 2); voiceCtx.fill();
                voiceCtx.beginPath(); voiceCtx.moveTo(x, y);
                const cx = voiceCenter.x + Math.cos(p.angle) * (voiceRadius * 0.6);
                const cy = voiceCenter.y + Math.sin(p.angle) * (voiceRadius * 0.6);
                voiceCtx.lineWidth = 0.4; voiceCtx.strokeStyle = `hsla(${p.hue},100%,70%,0.08)`; voiceCtx.lineTo(cx, cy); voiceCtx.stroke();
            }
            voiceCtx.restore();

            const pulse = (Math.sin(t * 2) + 1) / 2;
            voiceCtx.beginPath(); voiceCtx.arc(voiceCenter.x, voiceCenter.y, baseR + pulse * 10, 0, Math.PI * 2);
            voiceCtx.strokeStyle = speaking ? 'rgba(255,78,78,0.25)' : 'rgba(35,209,139,0.25)';
            voiceCtx.lineWidth = 1.2; voiceCtx.stroke();

            if (voiceOverlayActive) requestAnimationFrame(drawVoiceOrb);
        }

        async function startVoiceInput() {
            try {
                voiceAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
                if (voiceAudioCtx.state === 'suspended') await voiceAudioCtx.resume();
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true, noiseSuppression: true, autoGainControl: true
                    }
                });
                voiceStream = stream;
                const src = voiceAudioCtx.createMediaStreamSource(stream);
                voiceAnalyser = voiceAudioCtx.createAnalyser();
                voiceAnalyser.fftSize = 2048;
                voiceAnalyser.minDecibels = -100;
                voiceAnalyser.maxDecibels = -10;
                voiceData = new Uint8Array(voiceAnalyser.fftSize);
                src.connect(voiceAnalyser);
            } catch (e) { announce('Microphone access denied or unavailable'); toast('Mic access denied', 'error'); }
        }
        function stopVoiceInput() { try { voiceStream?.getTracks().forEach(t => t.stop()); } catch (e) { } voiceStream = null; try { voiceAudioCtx?.close(); } catch (e) { } voiceAudioCtx = null; voiceAnalyser = null; voiceData = null; }
        function startOverlayRecognition() {
            try {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) throw new Error('Speech recognition not supported');
                voiceRec = new SpeechRecognition(); voiceRec.lang = 'en-US';
                voiceRec.interimResults = true; voiceRec.continuous = true;
                overlayTranscript = '';
                setVoiceUIState('listening');
                voiceRec.onstart = () => { setVoiceUIState('listening'); setOrbState('listening'); };
                voiceRec.onresult = (event) => {
                    let interim = '';
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const tr = event.results[i][0].transcript;
                        if (event.results[i].isFinal) overlayTranscript += (overlayTranscript ? ' ' : '') + tr; else interim += tr;
                    }
                    $('#voiceTranscript').textContent = (overlayTranscript + (interim ? ' ' + interim : '')).trim();
                };
                voiceRec.onerror = () => { /* keep UI */ };
                voiceRec.onend = async () => {
                    if (overlayTranscript.trim().length) {
                        await handleOverlayQuery(overlayTranscript.trim());
                    }
                    if (voiceOverlayActive && !speaking) {
                        try { voiceRec.start(); } catch (e) { }
                    }
                };
                voiceRec.start();
            } catch (e) { announce('Voice recognition unavailable'); toast('Voice recognition unavailable', 'warn'); }
        }
        function stopOverlayRecognition() { try { voiceRec?.stop(); } catch (e) { } voiceRec = null; }
        async function handleOverlayQuery(text) {
            pushUserMessage(text);
            setVoiceUIState('processing');
            setOrbState('processing');
            const resp = await simulateAI(text);
            $('#voiceAIResponse').classList.remove('hidden');
            $('#voiceAIResponse').textContent = resp;
            await speakOverlay(resp);
        }
        function speakOverlay(text) {
            return new Promise((resolve) => {
                if (!synth) { resolve(); return; }
                try {
                    synth.cancel();
                    const u = new SpeechSynthesisUtterance(text);
                    u.rate = 1.05; u.pitch = 1;
                    u.onstart = () => { speaking = true; setVoiceUIState('speaking'); setOrbState('speaking'); };
                    u.onend = () => { speaking = false; setVoiceUIState('listening'); setOrbState('listening'); resolve(); };
                    u.onerror = () => { speaking = false; setVoiceUIState('listening'); setOrbState('listening'); resolve(); };
                    ttsUtterance = u; synth.speak(u);
                } catch (e) { resolve(); }
            });
        }
        function cancelTTS() { try { synth?.cancel(); } catch (e) { } ttsUtterance = null; speaking = false; }
        function setVoiceUIState(s) {
            const dot = $('#voiceDot'); const label = $('#voiceLabel');
            if (s === 'listening') { dot.style.background = 'var(--listen)'; label.textContent = 'Listening…'; }
            else if (s === 'speaking') { dot.style.background = 'var(--talk)'; label.textContent = 'Speaking…'; }
            else if (s === 'processing') { dot.style.background = 'var(--glow)'; label.textContent = 'Processing…'; }
        }
        async function openVoiceOverlay() {
            const overlay = $('#voiceOverlay');
            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';
            voiceOverlayActive = true;
            voiceCanvas = $('#voiceCanvas');
            voiceCtx = voiceCanvas.getContext('2d');
            resizeVoiceCanvas();
            window.addEventListener('resize', resizeVoiceCanvas);
            requestAnimationFrame(drawVoiceOrb);
            $('#voiceTranscript').textContent = '';
            $('#voiceAIResponse').textContent = '';
            $('#voiceAIResponse').classList.add('hidden');
            await startVoiceInput();
            startOverlayRecognition();
        }
        function closeVoiceOverlay() {
            voiceOverlayActive = false;
            document.body.style.overflow = '';
            $('#voiceOverlay').classList.remove('active');
            window.removeEventListener('resize', resizeVoiceCanvas);
            cancelTTS();
            stopOverlayRecognition();
            stopVoiceInput();
            setOrbState('idle');
        }
        $('#voiceBackBtn').addEventListener('click', closeVoiceOverlay);
        voiceMenu.addEventListener('keydown', (e) => { if (e.key === 'Escape') voiceMenu.dataset.open = 'false'; });

        /* Home link focus helper */
        $('#homeLink').addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); newChat(); } });

        /* Helpers */
        function capitalize(s) { return (s || '').charAt(0).toUpperCase() + (s || '').slice(1); }
        function cryptoRandomId() { try { return crypto.getRandomValues(new Uint32Array(1))[0].toString(16) + Date.now().toString(16); } catch (e) { return (Math.random() * 1e8 | 0).toString(16) + Date.now().toString(16); } }

        /* New chat: create a fresh session and switch to it */
        function newChat() {
            const id = createSession('New session');
            chatScroll.innerHTML = '';
            pushSystemMessage('New chat ready.');
            setOrbState('ready');
            setTimeout(() => setOrbState('idle'), 500);
            renderHistory();
        }

        /* Click logo to start fresh chat in current view but keep sessions intact */
        $('#homeLink').addEventListener('click', (e) => { e.preventDefault(); newChat(); scrollToBottom(); });

        /* Accessibility announce + visible toast */
        const live = el('div', 'sr-only', { role: 'status', 'aria-live': 'polite' });
        document.body.appendChild(live);
        function announce(msg) { live.textContent = ''; setTimeout(() => live.textContent = msg, 10); toast(msg); }

        /* Drawer quick nav active state */
        const quickLinks = $$('.quicknav a');
        const sectionIds = quickLinks.map(a => a.getAttribute('href'));
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const id = '#' + entry.target.id;
                    quickLinks.forEach(a => a.setAttribute('aria-current', a.getAttribute('href') === id ? 'true' : 'false'));
                }
            });
        }, { root: drawerScroll, threshold: 0.5 });
        sectionIds.forEach(selector => { const s = $(selector); if (s) observer.observe(s); });

        /* Initial content */
        (function bootstrap() {
            lucide.createIcons();
            // Apply UI settings to DOM
            document.documentElement.style.setProperty('--font-scale', String(state.ui.fontScale));
            document.body.classList.toggle('high-contrast', state.ui.highContrast);
            document.body.classList.toggle('reduce-motion', state.ui.reducedMotion);

            // Initialize orb core color and particles
            accentOrbCoreByMode();
            setOrbPersonalityHue(state.personality);

            // Seed a couple of sessions with messages to demonstrate "access history"
            const sid1 = addHistoryItem('Welcome tour', [
                { role: 'user', text: 'Show me what you can do.' },
                { role: 'salmar', text: 'I can help you research, plan, create, and automate—ask me anything!' }
            ]);
            const sid2 = addHistoryItem('Market analysis draft', [
                { role: 'user', text: 'Draft a market analysis for our new app.' },
                { role: 'salmar', text: 'Here is a concise market snapshot with competitors, trends, and risks.' }
            ]);

            // Load the most recent session
            loadSession(state.sessions[0]?.id || createSession('Untitled session'));
            pushSystemMessage('Tip: Use the History panel to switch sessions any time.');

            // Tooltips
            tip($('#advancedBtn'), 'Open advanced controls');
            tip($('#themeToggle'), 'Toggle light/dark');
            tip($('#uploadBtn'), 'Upload files');
            tip($('#radialMain'), 'Quick actions');

            // Prepare workflow state
            state.workflow = defaultSteps.map(s => ({ ...s }));
            renderWorkflow();

            // Render collaborators and history
            renderCollabList();
            renderHistory();
        })();

        /* Utility: file icon */
        function fileIconFor(name) {
            const ext = name.split('.').pop().toLowerCase();
            if (['png', 'jpg', 'jpeg', 'gif', 'webp'].includes(ext)) return 'image';
            if (['pdf'].includes(ext)) return 'file-text';
            if (['txt', 'md'].includes(ext)) return 'file-text';
            if (['json'].includes(ext)) return 'braces';
            if (['mp4', 'webm', 'mov'].includes(ext)) return 'video';
            if (['mp3', 'wav', 'ogg', 'm4a'].includes(ext)) return 'audio-lines';
            return 'file';
        }
    </script>
</body>

</html>