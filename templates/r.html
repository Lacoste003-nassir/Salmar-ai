<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Salmar — The AI That Does Everything</title>
  <meta name="color-scheme" content="dark light" />
  <meta name="theme-color" content="#1b1036" />
  <!-- Tailwind CSS (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Tailwind config
    tailwind.config = {
      darkMode: ['class', '[data-theme="dark"]'],
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'ui-sans-serif', 'system-ui', 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', 'Apple Color Emoji', 'Segoe UI Emoji'],
            display: ['Space Grotesk', 'Inter', 'system-ui']
          },
          colors: {
            nebula: {
              50: '#f5f0ff',
              100: '#ede4ff',
              200: '#dac9ff',
              300: '#bea0ff',
              400: '#a574ff',
              500: '#8c48ff',
              600: '#7a3cff',
              700: '#662cf2',
              800: '#4e22c1',
              900: '#3a1991',
              950: '#1b1036'
            },
            magenta: {
              500: '#ff3df2'
            },
            emerald: {
              500: '#10b981'
            }
          },
          boxShadow: {
            neu: '8px 8px 20px rgba(0,0,0,0.35), -8px -8px 24px rgba(255,255,255,0.06)',
            glass: '0 10px 30px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.08)'
          },
          backdropBlur: {
            xs: '2px'
          },
          keyframes: {
            'pulse-soft': { '0%,100%': { transform: 'scale(1)' }, '50%': { transform: 'scale(1.02)' } },
            'float': { '0%,100%': { transform: 'translateY(0px)' }, '50%': { transform: 'translateY(-6px)' } },
            'fade-up': { '0%': { opacity: 0, transform: 'translateY(10px)' }, '100%': { opacity: 1, transform: 'translateY(0)' } }
          },
          animation: {
            'pulse-soft': 'pulse-soft 3s ease-in-out infinite',
            'float': 'float 6s ease-in-out infinite',
            'fade-up': 'fade-up .5s ease-out both'
          }
        }
      },
      plugins: []
    };
  </script>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet" />

  <!-- Icons (Lucide) -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

  <!-- Prism.js for syntax highlighting -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-okaidia.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>

  <!-- tippy.js for tooltips -->
  <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/themes/material.css" />
  <script src="https://unpkg.com/@popperjs/core@2"></script>
  <script src="https://unpkg.com/tippy.js@6"></script>

  <!-- GSAP + ScrollTrigger -->
  <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/ScrollTrigger.min.js"></script>

  <!-- Three.js for 3D Orb -->
  <script src="https://unpkg.com/three@0.158.0/build/three.min.js"></script>

  <!-- tsParticles for constellation background -->
  <script src="https://cdn.jsdelivr.net/npm/tsparticles@3/tsparticles.bundle.min.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- dayjs -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>

  <!-- Export libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/8.2.1/docx.umd.min.js"></script>

  <!-- Simple utility styles and CSS variables -->
  <style>
    :root {
      --bg: #0f0b1e;
      --bg-2: #120e24;
      --card: rgba(255, 255, 255, 0.06);
      --card-strong: rgba(255, 255, 255, 0.1);
      --text: #eae6ff;
      --muted: #bfb6ff;
      --primary: #7a3cff;
      --accent: #ff3df2;
      --secure: #10b981;
      --warning: #f59e0b;
      --link: #a574ff;
      --ring: rgba(122, 60, 255, 0.6);
      --noise-opacity: .035;
    }
    [data-theme="light"] {
      --bg: #f7f7fb;
      --bg-2: #ffffff;
      --card: rgba(0, 0, 0, 0.06);
      --card-strong: rgba(0, 0, 0, 0.08);
      --text: #1a1033;
      --muted: #4b3f75;
      --primary: #6b2ef2;
      --accent: #d62ed1;
      --secure: #0ea371;
      --warning: #b7791f;
      --link: #6b2ef2;
      --ring: rgba(107, 46, 242, 0.35);
      --noise-opacity: .06;
    }
    /* High-contrast override */
    .high-contrast {
      --card: rgba(255,255,255,0.14);
      --card-strong: rgba(255,255,255,0.18);
      --muted: #ffffff;
      --ring: rgba(255,255,255,0.9);
    }

    html, body {
      height: 100%;
      background: radial-gradient(1200px 800px at 70% -20%, rgba(122,60,255,0.35), transparent 60%),
                  radial-gradient(1000px 700px at 0% 120%, rgba(255,61,242,0.25), transparent 60%),
                  linear-gradient(180deg, var(--bg), var(--bg-2));
      color: var(--text);
      font-synthesis-weight: none;
      text-rendering: optimizeLegibility;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      scroll-behavior: smooth;
    }

    /* Subtle noise overlay */
    .noise::before {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='128' height='128'><filter id='n'><feTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='2' stitchTiles='stitch'/></filter><rect width='100%25' height='100%25' filter='url(%23n)' opacity='0.75'/></svg>");
      opacity: var(--noise-opacity);
      mix-blend-mode: overlay;
      z-index: 0;
    }

    /* Glass & neumorphism helpers */
    .glass {
      background: var(--card);
      backdrop-filter: blur(10px) saturate(120%);
      -webkit-backdrop-filter: blur(10px) saturate(120%);
      border: 1px solid rgba(255,255,255,0.08);
      box-shadow: var(--shadow-glass, 0 10px 30px rgba(0,0,0,0.35)) inset 0 1px 0 rgba(255,255,255,0.08);
      border-radius: 14px;
    }
    .hover-glow:focus-visible, .hover-glow:hover {
      box-shadow: 0 0 0 3px var(--ring);
      outline: none;
    }
    .btn {
      position: relative;
      overflow: hidden;
    }
    .btn:after {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(120px 120px at var(--x,50%) var(--y,50%), rgba(255,255,255,0.15), transparent 40%);
      opacity: 0;
      transition: opacity .25s ease;
    }
    .btn:hover:after { opacity: 1; }

    /* Chat bubbles */
    .bubble {
      background: var(--card);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 16px;
      padding: .875rem 1rem;
    }
    .bubble.salmar {
      background: linear-gradient(180deg, rgba(122,60,255,0.12), rgba(255,61,242,0.10));
      border-color: rgba(122,60,255,0.35);
    }
    .bubble.user {
      background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.06));
      border-color: rgba(255,255,255,0.15);
    }

    /* Focus visibility */
    :focus-visible {
      outline: 3px solid var(--ring);
      border-radius: 8px;
      outline-offset: 2px;
    }

    /* Scrollbars */
    * {
      scrollbar-width: thin;
      scrollbar-color: rgba(122,60,255,.6) rgba(255,255,255,.06);
    }
    ::-webkit-scrollbar { height: 10px; width: 10px; }
    ::-webkit-scrollbar-track { background: rgba(255,255,255,.06); }
    ::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, rgba(122,60,255,.8), rgba(255,61,242,.8));
      border-radius: 10px;
    }

    /* Lightbox */
    .lightbox-backdrop { background: rgba(0,0,0,.75); }

    /* Command palette style */
    .cmd-active { box-shadow: 0 0 0 3px var(--ring); }

    /* Mode hue accents (updated by JS via data-mode attr on body) */
    [data-mode="smart"] { --primary: #7a3cff; --accent: #ff3df2; }
    [data-mode="deep"] { --primary: #3b82f6; --accent: #22d3ee; }
    [data-mode="creative"] { --primary: #e11d48; --accent: #fb7185; }
    [data-mode="action"] { --primary: #10b981; --accent: #84cc16; }

    /* Reduced motion */
    .reduced-motion * { animation: none !important; transition: none !important; }
  </style>
</head>

<body class="font-sans antialiased noise min-h-screen selection:bg-nebula-700/40 selection:text-white" data-mode="smart">
  <a href="#main" class="sr-only focus:not-sr-only focus:absolute focus:top-2 focus:left-2 focus:z-50 bg-black/70 text-white px-3 py-2 rounded">Skip to content</a>

  <!-- Background Particles -->
  <div id="bgParticles" aria-hidden="true" class="fixed inset-0 -z-10"></div>

  <!-- Neural gradient beams -->
  <div aria-hidden="true" class="pointer-events-none fixed inset-0 -z-10 opacity-70 mix-blend-screen">
    <svg class="w-full h-full" viewBox="0 0 1200 800" preserveAspectRatio="none">
      <defs>
        <linearGradient id="g1" x1="0" x2="1" y1="0" y2="1">
          <stop offset="0%" stop-color="#7a3cff" stop-opacity="0.25"/>
          <stop offset="100%" stop-color="#ff3df2" stop-opacity="0.15"/>
        </linearGradient>
      </defs>
      <path d="M-10,600 C200,650 300,500 550,540 C800,580 900,500 1210,620" stroke="url(#g1)" stroke-width="2" fill="none"/>
      <path d="M-10,200 C160,260 340,140 560,200 C780,260 960,140 1210,240" stroke="url(#g1)" stroke-width="1.5" fill="none" opacity="0.6"/>
      <path d="M-10,400 C160,420 340,360 560,420 C780,480 960,420 1210,450" stroke="url(#g1)" stroke-width="1.5" fill="none" opacity="0.4"/>
    </svg>
  </div>

  <!-- Header -->
  <header class="relative z-10">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 pt-6">
      <div class="glass flex items-center justify-between px-3 sm:px-5 py-3 sm:py-4 shadow-neu">
        <!-- Left: Logo + Wordmark -->
        <div class="flex items-center gap-3">
          <div class="relative w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-gradient-to-br from-[var(--primary)] to-[var(--accent)] shadow-neu animate-pulse-soft" aria-hidden="true">
            <canvas id="orbCanvas" class="absolute inset-0 rounded-full"></canvas>
          </div>
          <div class="leading-tight">
            <div class="font-display text-lg sm:text-2xl font-bold tracking-tight" aria-label="Salmar logo">Salmar</div>
            <div class="text-xs sm:text-sm text-[var(--muted)]">The AI that does everything</div>
          </div>
        </div>
        <!-- Center: Nav -->
        <nav class="hidden md:flex items-center gap-1 sm:gap-2 lg:gap-3" aria-label="Primary">
          <a href="#dashboard" class="px-3 py-2 rounded-md hover-glow focus:outline-none text-sm glass" role="link">Dashboard</a>
          <a href="#integrations" class="px-3 py-2 rounded-md hover-glow text-sm glass" role="link">Integrations</a>
          <a href="#history" class="px-3 py-2 rounded-md hover-glow text-sm glass" role="link">History</a>
          <button id="openSettingsBtn" class="px-3 py-2 rounded-md hover-glow text-sm glass" aria-haspopup="dialog" aria-controls="settingsModal">Settings</button>
        </nav>
        <!-- Right: Actions -->
        <div class="flex items-center gap-2 sm:gap-3">
          <!-- Mode Selector -->
          <div class="hidden sm:flex items-center gap-2" role="group" aria-label="AI Modes">
            <button class="px-2.5 py-1.5 text-xs rounded-md glass hover-glow btn" data-mode-btn="smart" aria-pressed="true">🧠 Smart</button>
            <button class="px-2.5 py-1.5 text-xs rounded-md glass hover-glow btn" data-mode-btn="deep">🔬 Deep Dive</button>
            <button class="px-2.5 py-1.5 text-xs rounded-md glass hover-glow btn" data-mode-btn="creative">🎨 Creative</button>
            <button class="px-2.5 py-1.5 text-xs rounded-md glass hover-glow btn" data-mode-btn="action">⚡ Action</button>
          </div>
          <!-- Theme toggle -->
          <button id="themeToggle" class="relative p-2 rounded-lg glass hover-glow" aria-label="Toggle dark mode">
            <i data-lucide="sun" class="w-5 h-5 hidden" aria-hidden="true"></i>
            <i data-lucide="moon" class="w-5 h-5" aria-hidden="true"></i>
          </button>
          <!-- Command palette -->
          <button id="cmdBtn" class="hidden sm:inline-flex items-center gap-2 px-3 py-2 rounded-lg glass hover-glow" aria-label="Command palette (Ctrl or ⌘ + K)">
            <i data-lucide="command" class="w-4 h-4"></i><span class="text-sm">Palette</span>
          </button>
          <!-- Profile -->
          <div class="relative">
            <button id="profileMenuBtn" class="flex items-center gap-2 px-2.5 py-1.5 rounded-lg glass hover-glow" aria-haspopup="menu" aria-expanded="false">
              <span class="inline-flex items-center justify-center w-7 h-7 rounded-full bg-[var(--card-strong)]">
                <i data-lucide="user" class="w-4 h-4"></i>
              </span>
              <span class="hidden sm:block text-sm">You</span>
              <span id="biometricDot" class="ml-1 w-2 h-2 rounded-full bg-emerald-500 shadow-[0_0_10px_2px_rgba(16,185,129,.6)]" aria-label="Biometric active"></span>
            </button>
            <div id="profileMenu" class="hidden absolute right-0 mt-2 w-56 glass p-2" role="menu" aria-label="Profile menu">
              <button class="w-full text-left px-3 py-2 rounded hover-glow btn flex items-center gap-2" id="triggerBiometric"><i data-lucide="fingerprint" class="w-4 h-4"></i><span>Re-authenticate</span></button>
              <button class="w-full text-left px-3 py-2 rounded hover-glow btn flex items-center gap-2" id="incognitoToggle"><i data-lucide="shield" class="w-4 h-4"></i><span>Incognito Session</span><span id="incognitoBadge" class="ml-auto text-xs px-2 py-0.5 rounded bg-black/30">OFF</span></button>
              <a href="#settings" class="px-3 py-2 rounded hover-glow btn flex items-center gap-2"><i data-lucide="settings" class="w-4 h-4"></i><span>Settings</span></a>
              <button class="w-full text-left px-3 py-2 rounded hover-glow btn flex items-center gap-2"><i data-lucide="log-out" class="w-4 h-4"></i><span>Sign out</span></button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Layout -->
  <main id="main" class="relative z-10 mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-6 md:py-8 grid grid-cols-1 lg:grid-cols-12 gap-4 md:gap-6">
    <!-- Sidebar Left: Tools & Modes -->
    <aside class="lg:col-span-3 space-y-4" aria-label="Tools and modes">
      <!-- Tools -->
      <section class="glass p-4 sm:p-5" id="toolsSection">
        <div class="flex items-center justify-between mb-3">
          <h2 class="font-display text-lg">Tools & Modes</h2>
          <button id="collapseTools" class="p-2 rounded hover-glow" aria-expanded="true"><i data-lucide="chevron-up" class="w-5 h-5"></i></button>
        </div>
        <div id="toolsList" class="grid grid-cols-1 gap-3">
          <!-- Tool Card -->
          <div class="glass p-3 rounded-lg hover-glow cursor-pointer has-tooltip" data-tippy-content="Research, Summarization, Q&A">
            <div class="flex items-center gap-3">
              <span class="inline-flex w-10 h-10 items-center justify-center rounded-lg bg-[var(--card-strong)]"><i data-lucide="book-open" class="w-5 h-5"></i></span>
              <div class="flex-1">
                <div class="font-medium">Knowledge</div>
                <div class="text-xs text-[var(--muted)]">Research • Summarization • Q&A</div>
              </div>
              <button class="px-2 py-1 text-xs rounded bg-[var(--primary)]/20 border border-[var(--primary)]/40">Open</button>
            </div>
          </div>
          <div class="glass p-3 rounded-lg hover-glow cursor-pointer has-tooltip" data-tippy-content="Image generation, storytelling, design">
            <div class="flex items-center gap-3">
              <span class="inline-flex w-10 h-10 items-center justify-center rounded-lg bg-[var(--card-strong)]"><i data-lucide="sparkles" class="w-5 h-5"></i></span>
              <div class="flex-1">
                <div class="font-medium">Creative</div>
                <div class="text-xs text-[var(--muted)]">Image • Story • Design</div>
              </div>
              <button class="px-2 py-1 text-xs rounded bg-[var(--primary)]/20 border border-[var(--primary)]/40">Open</button>
            </div>
          </div>
          <div class="glass p-3 rounded-lg hover-glow cursor-pointer has-tooltip" data-tippy-content="Productivity, workflows, automation">
            <div class="flex items-center gap-3">
              <span class="inline-flex w-10 h-10 items-center justify-center rounded-lg bg-[var(--card-strong)]"><i data-lucide="briefcase" class="w-5 h-5"></i></span>
              <div class="flex-1">
                <div class="font-medium">Business</div>
                <div class="text-xs text-[var(--muted)]">Productivity • Workflows • Automation</div>
              </div>
              <button class="px-2 py-1 text-xs rounded bg-[var(--primary)]/20 border border-[var(--primary)]/40">Open</button>
            </div>
          </div>
          <div class="glass p-3 rounded-lg hover-glow cursor-pointer has-tooltip" data-tippy-content="Biometrics, encryption status, safe mode">
            <div class="flex items-center gap-3">
              <span class="inline-flex w-10 h-10 items-center justify-center rounded-lg bg-[var(--card-strong)]"><i data-lucide="shield-check" class="w-5 h-5"></i></span>
              <div class="flex-1">
                <div class="font-medium">Security</div>
                <div class="text-xs text-[var(--muted)]">Biometric • Encryption • Safe Mode</div>
              </div>
              <button class="px-2 py-1 text-xs rounded bg-[var(--primary)]/20 border border-[var(--primary)]/40">Open</button>
            </div>
          </div>
          <div class="glass p-3 rounded-lg hover-glow cursor-pointer has-tooltip" data-tippy-content="Google Drive, Slack, Discord, APIs">
            <div class="flex items-center gap-3">
              <span class="inline-flex w-10 h-10 items-center justify-center rounded-lg bg-[var(--card-strong)]"><i data-lucide="link" class="w-5 h-5"></i></span>
              <div class="flex-1">
                <div class="font-medium">Integrations</div>
                <div class="text-xs text-[var(--muted)]">Drive • Slack • Discord • APIs</div>
              </div>
              <a href="#integrations" class="px-2 py-1 text-xs rounded bg-[var(--primary)]/20 border border-[var(--primary)]/40">Manage</a>
            </div>
          </div>
        </div>
      </section>

      <!-- Personality & Memory -->
      <section class="glass p-4 sm:p-5" aria-labelledby="persona">
        <h2 id="persona" class="font-display text-lg mb-4">Personality & Memory</h2>
        <div class="space-y-4">
          <div>
            <div class="flex items-center justify-between mb-2">
              <label for="personality" class="text-sm">AI Personality</label>
              <span id="personalityLabel" class="text-xs text-[var(--muted)]">Professional</span>
            </div>
            <input type="range" id="personality" min="0" max="3" value="0" class="w-full accent-[var(--primary)]" aria-valuemin="0" aria-valuemax="3" aria-valuenow="0" />
            <div class="flex justify-between text-[10px] mt-1 text-[var(--muted)]">
              <span>Professional</span><span>Friendly</span><span>Visionary</span><span>Technical</span>
            </div>
          </div>
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm">Long-term Memory</div>
              <div class="text-xs text-[var(--muted)]">Privacy-first. Toggle on/off.</div>
            </div>
            <button id="memoryToggle" class="px-3 py-1.5 rounded-lg glass hover-glow" role="switch" aria-checked="true">ON</button>
          </div>
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm">Safe Mode</div>
              <div class="text-xs text-[var(--muted)]">Redacts PII before exporting</div>
            </div>
            <button id="safeModeToggle" class="px-3 py-1.5 rounded-lg glass hover-glow" role="switch" aria-checked="true">ON</button>
          </div>
        </div>
      </section>

      <!-- Collaboration -->
      <section class="glass p-4 sm:p-5" aria-labelledby="collab">
        <div class="flex items-center justify-between mb-3">
          <h2 id="collab" class="font-display text-lg">Collaboration</h2>
          <button id="inviteBtn" class="px-2 py-1 rounded-md glass hover-glow btn"><i data-lucide="user-plus" class="w-4 h-4"></i></button>
        </div>
        <div class="flex -space-x-2">
          <img alt="Teammate avatar A" src="https://picsum.photos/seed/a/40" class="w-8 h-8 rounded-full border border-white/20" />
          <img alt="Teammate avatar B" src="https://picsum.photos/seed/b/40" class="w-8 h-8 rounded-full border border-white/20" />
          <img alt="Teammate avatar C" src="https://picsum.photos/seed/c/40" class="w-8 h-8 rounded-full border border-white/20" />
          <div class="w-8 h-8 rounded-full bg-[var(--primary)]/40 border border-white/20 flex items-center justify-center text-xs">+5</div>
        </div>
        <div class="text-xs text-[var(--muted)] mt-3">Invite teammates to co-create in real-time.</div>
      </section>
    </aside>

    <!-- Center: Interaction Core -->
    <section id="dashboard" class="lg:col-span-6 space-y-4">
      <!-- Salmar Orb Panel -->
      <div class="glass p-4 sm:p-5 relative overflow-hidden">
        <div class="flex items-center justify-between">
          <h2 class="font-display text-xl">Salmar Orb</h2>
          <div class="flex items-center gap-2">
            <span class="text-xs text-[var(--muted)] hidden sm:block">Mode:</span>
            <span id="modePill" class="text-xs px-2.5 py-1 rounded-full bg-[var(--primary)]/20 border border-[var(--primary)]/40">Smart</span>
          </div>
        </div>
        <div class="relative mt-4">
          <div class="relative w-full h-56 sm:h-72 rounded-xl overflow-hidden">
            <canvas id="orb3d" class="absolute inset-0 w-full h-full"></canvas>
            <div class="absolute inset-0 pointer-events-none">
              <div class="absolute inset-x-0 bottom-0 h-1/3 bg-gradient-to-t from-black/50 to-transparent"></div>
            </div>
          </div>
          <div class="mt-3 text-xs text-[var(--muted)]">The holographic AI avatar adapts to your tasks. Interact to see it react.</div>
        </div>
      </div>

      <!-- Chat / Output Area -->
      <div id="outputArea" class="glass p-4 sm:p-5 space-y-4 min-h-[300px]" aria-live="polite" aria-busy="false">
        <!-- Sample welcome message -->
        <article class="bubble salmar animate-fade-up">
          <header class="flex items-center gap-2 mb-1">
            <i data-lucide="sparkles" class="w-4 h-4 text-[var(--accent)]"></i>
            <h3 class="font-semibold">Welcome to Salmar</h3>
          </header>
          <p class="text-sm leading-relaxed">
            Ask me anything, or tell me what to do. Try: “Summarize this PDF”, “Generate a business plan”, or “Connect to my Slack”.
          </p>
        </article>
      </div>

      <!-- Composer -->
      <div class="glass p-3 sm:p-4" role="group" aria-label="Chat composer">
        <div class="flex flex-wrap items-center gap-2 mb-2">
          <button class="text-xs px-2 py-1 rounded-full glass hover-glow quick-chip" data-chip="Summarize this PDF">Summarize PDF</button>
          <button class="text-xs px-2 py-1 rounded-full glass hover-glow quick-chip" data-chip="Create a 1-page business plan for a SaaS in fintech">Business plan</button>
          <button class="text-xs px-2 py-1 rounded-full glass hover-glow quick-chip" data-chip="Connect my Slack and draft a weekly update">Connect Slack</button>
          <button class="text-xs px-2 py-1 rounded-full glass hover-glow quick-chip" data-chip="Design a landing page hero in a futuristic style">Design hero</button>
        </div>
        <div id="dropZone" class="flex items-center gap-2 bg-black/10 border border-white/10 rounded-lg px-2 py-2">
          <button id="attachBtn" class="p-2 rounded hover-glow" aria-label="Attach file"><i data-lucide="paperclip" class="w-5 h-5"></i></button>
          <input type="file" id="fileInput" class="sr-only" multiple />
          <input id="composer" type="text" class="flex-1 bg-transparent focus:outline-none placeholder:text-[var(--muted)] text-sm" placeholder="Ask me anything, or tell me what to do…" aria-label="Message input" />
          <button id="micBtn" class="p-2 rounded-lg glass hover-glow" aria-pressed="false" aria-label="Voice command">
            <i data-lucide="mic" class="w-5 h-5"></i>
          </button>
          <button id="sendBtn" class="btn px-3 py-2 rounded-lg bg-[var(--primary)] text-white hover:opacity-95 relative">
            <span class="relative z-10 flex items-center gap-2"><i data-lucide="send" class="w-4 h-4"></i> Send</span>
          </button>
        </div>
        <div class="mt-2 text-[11px] text-[var(--muted)]">Tip: Press Ctrl/⌘ + K for the command palette. Drag & drop files here.</div>
      </div>

      <!-- History Timeline -->
      <section id="history" class="glass p-4 sm:p-5">
        <div class="flex items-center justify-between mb-3">
          <h2 class="font-display text-lg">History Timeline</h2>
          <button id="clearHistoryBtn" class="px-2 py-1 rounded hover-glow text-xs">Clear</button>
        </div>
        <div id="timeline" class="relative overflow-x-auto whitespace-nowrap py-2">
          <div id="timelineTrack" class="flex gap-4 items-center min-w-full cursor-grab active:cursor-grabbing">
            <!-- Dynamic nodes -->
          </div>
        </div>
      </section>
    </section>

    <!-- Right Panel: Advanced & Exports -->
    <aside class="lg:col-span-3 space-y-4">
      <!-- Advanced Features -->
      <section class="glass p-4 sm:p-5">
        <h2 class="font-display text-lg mb-3">Advanced Features</h2>
        <div class="grid grid-cols-1 gap-3">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm">Action Mode</div>
              <div class="text-xs text-[var(--muted)]">Run tasks & integrations</div>
            </div>
            <button class="px-3 py-1.5 rounded-lg glass hover-glow" data-mode-btn="action">Enable</button>
          </div>
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm">Collaboration</div>
              <div class="text-xs text-[var(--muted)]">Invite teammates to session</div>
            </div>
            <button id="collabInviteBtn" class="px-3 py-1.5 rounded-lg glass hover-glow">Invite</button>
          </div>
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm">Memory</div>
              <div class="text-xs text-[var(--muted)]">Long-term memory on/off</div>
            </div>
            <button id="memoryToggle2" class="px-3 py-1.5 rounded-lg glass hover-glow">ON</button>
          </div>
        </div>
      </section>

      <!-- Exports -->
      <section class="glass p-4 sm:p-5" aria-labelledby="export">
        <h2 id="export" class="font-display text-lg mb-3">Export & Share</h2>
        <div class="grid grid-cols-2 gap-2">
          <button id="exportPDF" class="px-3 py-2 rounded-lg glass hover-glow btn flex items-center justify-center gap-2"><i data-lucide="file-text" class="w-4 h-4"></i>PDF</button>
          <button id="exportDOCX" class="px-3 py-2 rounded-lg glass hover-glow btn flex items-center justify-center gap-2"><i data-lucide="file" class="w-4 h-4"></i>DOCX</button>
          <button id="exportTXT" class="px-3 py-2 rounded-lg glass hover-glow btn flex items-center justify-center gap-2"><i data-lucide="file" class="w-4 h-4"></i>TXT</button>
          <button id="shareBtn" class="px-3 py-2 rounded-lg glass hover-glow btn flex items-center justify-center gap-2"><i data-lucide="share-2" class="w-4 h-4"></i>Share</button>
        </div>
        <div class="mt-3 text-xs text-[var(--muted)]">Safe Mode redacts PII when enabled.</div>
      </section>

      <!-- Integrations -->
      <section id="integrations" class="glass p-4 sm:p-5">
        <div class="flex items-center justify-between mb-3">
          <h2 class="font-display text-lg">Integrations</h2>
          <button id="openWorkflow" class="px-2 py-1 text-xs rounded-md glass hover-glow">Workflow Builder</button>
        </div>
        <div class="space-y-3">
          <div class="glass p-3 rounded hover-glow">
            <div class="flex items-center gap-3">
              <i data-lucide="slack" class="w-5 h-5"></i>
              <div class="flex-1">
                <div class="text-sm">Slack</div>
                <div class="text-xs text-[var(--muted)]">Post to channels</div>
              </div>
              <button class="px-2 py-1 rounded text-xs glass hover-glow connect-btn" data-integration="Slack">Connect</button>
            </div>
          </div>
          <div class="glass p-3 rounded hover-glow">
            <div class="flex items-center gap-3">
              <i data-lucide="folder" class="w-5 h-5"></i>
              <div class="flex-1">
                <div class="text-sm">Google Drive</div>
                <div class="text-xs text-[var(--muted)]">Import/Export files</div>
              </div>
              <button class="px-2 py-1 rounded text-xs glass hover-glow connect-btn" data-integration="Google Drive">Connect</button>
            </div>
          </div>
          <div class="glass p-3 rounded hover-glow">
            <div class="flex items-center gap-3">
              <i data-lucide="message-circle" class="w-5 h-5"></i>
              <div class="flex-1">
                <div class="text-sm">Discord</div>
                <div class="text-xs text-[var(--muted)]">Bot commands</div>
              </div>
              <button class="px-2 py-1 rounded text-xs glass hover-glow connect-btn" data-integration="Discord">Connect</button>
            </div>
          </div>
          <div class="glass p-3 rounded hover-glow">
            <div class="flex items-center gap-3">
              <i data-lucide="notebook-pen" class="w-5 h-5"></i>
              <div class="flex-1">
                <div class="text-sm">Notion</div>
                <div class="text-xs text-[var(--muted)]">Publish docs</div>
              </div>
              <button class="px-2 py-1 rounded text-xs glass hover-glow connect-btn" data-integration="Notion">Connect</button>
            </div>
          </div>
          <div class="glass p-3 rounded hover-glow">
            <div class="flex items-center gap-3">
              <i data-lucide="github" class="w-5 h-5"></i>
              <div class="flex-1">
                <div class="text-sm">GitHub</div>
                <div class="text-xs text-[var(--muted)]">Create issues/PRs</div>
              </div>
              <button class="px-2 py-1 rounded text-xs glass hover-glow connect-btn" data-integration="GitHub">Connect</button>
            </div>
          </div>
        </div>
      </section>
    </aside>
  </main>

  <!-- Footer -->
  <footer class="relative z-10">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-8">
      <div class="glass p-4 sm:p-5 flex flex-col sm:flex-row items-center justify-between gap-3">
        <div class="flex items-center gap-2 text-sm">
          <a href="#" class="hover:underline">Help Center</a>
          <span class="opacity-40">•</span>
          <a href="#" class="hover:underline">Report an Issue</a>
          <span class="opacity-40">•</span>
          <a href="#" class="hover:underline">Security Status</a>
        </div>
        <p class="text-xs text-[var(--muted)]">The Future is Purple. The Future is Salmar.</p>
      </div>
    </div>
  </footer>

  <!-- Settings Modal -->
  <div id="settingsModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
    <div class="absolute inset-0 bg-black/70"></div>
    <div class="relative w-full max-w-4xl glass p-0 overflow-hidden">
      <div class="flex items-center justify-between px-5 py-4 border-b border-white/10">
        <h2 id="settingsTitle" class="font-display text-xl">Settings</h2>
        <button id="closeSettingsBtn" class="p-2 rounded hover-glow"><i data-lucide="x" class="w-5 h-5"></i></button>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-4">
        <aside class="md:border-r border-white/10">
          <nav class="flex md:flex-col overflow-auto p-2 gap-1" aria-label="Settings sections">
            <button class="px-3 py-2 rounded glass hover-glow text-left settings-tab" data-tab="general">General</button>
            <button class="px-3 py-2 rounded glass hover-glow text-left settings-tab" data-tab="appearance">Appearance</button>
            <button class="px-3 py-2 rounded glass hover-glow text-left settings-tab" data-tab="voice">Voice & Accessibility</button>
            <button class="px-3 py-2 rounded glass hover-glow text-left settings-tab" data-tab="security">Security & Privacy</button>
            <button class="px-3 py-2 rounded glass hover-glow text-left settings-tab" data-tab="integrations">Integrations</button>
            <button class="px-3 py-2 rounded glass hover-glow text-left settings-tab" data-tab="shortcuts">Shortcuts</button>
            <button class="px-3 py-2 rounded glass hover-glow text-left settings-tab" data-tab="about">About</button>
          </nav>
        </aside>
        <section id="settingsContent" class="md:col-span-3 p-4 sm:p-6 space-y-6">
          <!-- Dynamic content -->
        </section>
      </div>
      <div class="px-5 py-4 border-t border-white/10 flex items-center justify-end gap-2">
        <button id="saveSettingsBtn" class="px-3 py-2 rounded-lg bg-[var(--primary)] text-white btn">Save</button>
      </div>
    </div>
  </div>

  <!-- Lightbox Modal -->
  <div id="lightbox" class="hidden fixed inset-0 z-50 items-center justify-center">
    <div class="absolute inset-0 lightbox-backdrop"></div>
    <div class="relative max-w-5xl w-full p-4">
      <div class="glass p-2">
        <img id="lightboxImg" alt="Expanded preview" src="" class="w-full h-auto rounded" />
      </div>
      <button id="lightboxClose" class="absolute top-3 right-3 p-2 rounded bg-black/60 hover:bg-black/80">
        <i data-lucide="x" class="w-5 h-5"></i>
      </button>
    </div>
  </div>

  <!-- Command Palette -->
  <div id="cmdPalette" class="hidden fixed inset-0 z-50 items-start justify-center p-4 pt-[10vh]">
    <div class="absolute inset-0 bg-black/60"></div>
    <div class="relative w-full max-w-2xl glass p-0 overflow-hidden">
      <div class="border-b border-white/10 p-3">
        <input id="cmdInput" placeholder="Type a command: switch mode, open settings, export, invite, connect…" class="w-full bg-transparent outline-none text-sm" />
      </div>
      <ul id="cmdResults" class="max-h-80 overflow-auto divide-y divide-white/5">
        <!-- Populated dynamically -->
      </ul>
    </div>
  </div>

  <!-- Invite Modal -->
  <div id="inviteModal" class="hidden fixed inset-0 z-50 items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/60"></div>
    <div class="relative w-full max-w-md glass p-5">
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-display text-lg">Invite Teammates</h3>
        <button id="inviteClose" class="p-2 rounded hover-glow"><i data-lucide="x" class="w-5 h-5"></i></button>
      </div>
      <div class="space-y-3">
        <div class="text-sm">Enter emails (comma separated):</div>
        <textarea id="inviteEmails" class="w-full h-24 bg-black/10 border border-white/10 rounded p-2 text-sm" placeholder="alex@company.com, taylor@company.com"></textarea>
        <div class="flex items-center justify-between">
          <div class="text-xs text-[var(--muted)]">Guests can view and comment.</div>
          <button id="inviteSend" class="px-3 py-2 rounded bg-[var(--primary)] text-white btn">Send Invites</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Workflow Builder -->
  <div id="workflowModal" class="hidden fixed inset-0 z-50 items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/70"></div>
    <div class="relative w-full max-w-3xl glass p-0 overflow-hidden">
      <div class="flex items-center justify-between px-5 py-4 border-b border-white/10">
        <h2 class="font-display text-xl">Workflow Builder</h2>
        <button id="workflowClose" class="p-2 rounded hover-glow"><i data-lucide="x" class="w-5 h-5"></i></button>
      </div>
      <div class="p-4 sm:p-6 space-y-4">
        <div id="workflowSteps" class="space-y-3">
          <!-- Steps -->
        </div>
        <div class="flex items-center justify-between">
          <button id="addStep" class="px-3 py-2 rounded glass hover-glow btn"><i data-lucide="plus" class="w-4 h-4"></i> Add Step</button>
          <button id="runWorkflow" class="px-3 py-2 rounded bg-[var(--primary)] text-white btn">Run Workflow</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Hidden template for step -->
  <template id="workflowStepTpl">
    <div class="glass p-3 rounded flex flex-col gap-2">
      <div class="flex items-center gap-2">
        <span class="w-6 h-6 rounded bg-[var(--primary)]/30 border border-[var(--primary)]/40 flex items-center justify-center text-xs step-index">1</span>
        <select class="bg-black/10 border border-white/10 rounded p-2 text-sm flex-1">
          <option>Parse PDF</option>
          <option>Summarize</option>
          <option>Translate</option>
          <option>Generate Chart</option>
          <option>Push to Slack</option>
          <option>Export to Drive</option>
        </select>
        <button class="remove-step p-2 rounded hover-glow" aria-label="Remove step"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
      </div>
      <input placeholder="Parameters (optional)" class="bg-black/10 border border-white/10 rounded p-2 text-sm" />
    </div>
  </template>

  <!-- ARIA Live for announcements -->
  <div class="sr-only" aria-live="assertive" id="ariaAnnounce"></div>

  <script>
    // State
    const state = {
      theme: document.documentElement.getAttribute('data-theme') || 'dark',
      highContrast: false,
      reducedMotion: window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches,
      mode: 'smart',
      memory: true,
      safeMode: true,
      voiceEnabled: true,
      incognito: false,
      biometricActive: true,
      personalityIndex: 0, // 0..3
      messages: [],
      integrations: {},
      lastExportHTML: ''
    };

    // Helpers
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const announce = msg => { const a = $('#ariaAnnounce'); a.textContent = msg; };

    // Initialize icons
    document.addEventListener('DOMContentLoaded', () => {
      try { lucide.createIcons(); } catch (e) {}
    });

    // Tooltips
    function initTooltips() {
      try {
        tippy('.has-tooltip', { theme: 'material', delay: [200, 50], arrow: true, placement: 'bottom' });
      } catch(e) {}
    }
    initTooltips();

    // Theme toggle
    const themeToggle = $('#themeToggle');
    function updateThemeIcon() {
      const sun = themeToggle.querySelector('[data-lucide="sun"]');
      const moon = themeToggle.querySelector('[data-lucide="moon"]');
      if (state.theme === 'dark') { sun.classList.remove('hidden'); moon.classList.add('hidden'); }
      else { sun.classList.add('hidden'); moon.classList.remove('hidden'); }
    }
    themeToggle?.addEventListener('pointermove', e => {
      const r = e.currentTarget.getBoundingClientRect();
      e.currentTarget.style.setProperty('--x', `${e.clientX - r.left}px`);
      e.currentTarget.style.setProperty('--y', `${e.clientY - r.top}px`);
    });
    themeToggle?.addEventListener('click', () => {
      state.theme = state.theme === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', state.theme);
      updateThemeIcon();
      announce(`Theme set to ${state.theme}`);
    });
    updateThemeIcon();

    // High-contrast / Reduced motion classes managed in settings rendering

    // Mode switching
    function setMode(mode) {
      state.mode = mode;
      document.body.setAttribute('data-mode', mode);
      const pill = $('#modePill');
      pill.textContent = mode === 'smart' ? 'Smart' : mode === 'deep' ? 'Deep Dive' : mode === 'creative' ? 'Creative' : 'Action';
      // Orb reaction
      pulseOrb();
    }
    $$( '[data-mode-btn]' ).forEach(btn => {
      btn.addEventListener('click', () => {
        const mode = btn.getAttribute('data-mode-btn');
        setMode(mode);
        $$( '[data-mode-btn]' ).forEach(b => b.setAttribute('aria-pressed', String(b === btn)));
      });
    });

    // Profile menu
    const profileBtn = $('#profileMenuBtn');
    const profileMenu = $('#profileMenu');
    profileBtn?.addEventListener('click', () => {
      const open = profileMenu.classList.contains('hidden');
      profileMenu.classList.toggle('hidden', !open);
      profileBtn.setAttribute('aria-expanded', String(open));
    });
    document.addEventListener('click', (e) => {
      if (!profileMenu.contains(e.target) && !profileBtn.contains(e.target)) {
        profileMenu.classList.add('hidden');
        profileBtn.setAttribute('aria-expanded', 'false');
      }
    });

    // Incognito toggle
    $('#incognitoToggle')?.addEventListener('click', () => {
      state.incognito = !state.incognito;
      $('#incognitoBadge').textContent = state.incognito ? 'ON' : 'OFF';
      announce(`Incognito ${state.incognito ? 'enabled' : 'disabled'}`);
    });

    // Biometric re-auth (feature detect WebAuthn)
    function isWebAuthnAvailable() {
      return typeof window.PublicKeyCredential !== 'undefined';
    }
    $('#triggerBiometric')?.addEventListener('click', async () => {
      if (!isWebAuthnAvailable()) {
        alert('WebAuthn not available in this environment. Simulating biometric success.');
        return;
      }
      try {
        // Demo: a simple create() aborts in sandbox; we show a mock success UI instead.
        alert('Biometric re-auth requested. For demo, assuming success.');
      } catch (e) {
        console.warn('Biometric demo error:', e);
      }
    });

    // tSParticles Background
    async function initParticles() {
      try {
        await tsParticles.load('bgParticles', {
          fpsLimit: 60,
          background: { color: { value: 'transparent' } },
          particles: {
            number: { value: 70, density: { enable: true, area: 1000 } },
            color: { value: ['#7a3cff', '#ff3df2', '#22d3ee', '#10b981'] },
            links: { enable: true, color: '#7a3cff', distance: 120, opacity: 0.25 },
            move: { enable: true, speed: 0.6, outModes: { default: 'bounce' }, parallax: { enable: true, force: 30 } },
            opacity: { value: { min: 0.2, max: 0.6 } },
            size: { value: { min: 1, max: 3 } },
          },
          detectRetina: true
        });
      } catch (e) { console.warn('Particles init failed', e); }
    }
    initParticles();

    // 3D Orb (center stage)
    let orbScene, orbCamera, orbRenderer, orbMesh, orbClock;
    function initOrb() {
      const canvas = document.getElementById('orb3d');
      const w = canvas.clientWidth, h = canvas.clientHeight;
      orbScene = new THREE.Scene();
      orbCamera = new THREE.PerspectiveCamera(45, w/h, 0.1, 100);
      orbCamera.position.z = 3.2;
      orbRenderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
      orbRenderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
      orbRenderer.setSize(w, h);

      // Lights
      const ambient = new THREE.AmbientLight(0xffffff, 0.4);
      orbScene.add(ambient);
      const point = new THREE.PointLight(0xffffff, 1.2);
      point.position.set(2, 2, 3);
      orbScene.add(point);

      // Geometry & Material
      const geo = new THREE.SphereGeometry(1, 64, 64);
      const mat = new THREE.MeshPhysicalMaterial({
        color: new THREE.Color(0x7a3cff),
        metalness: 0.15,
        roughness: 0.25,
        transmission: 0.6,
        thickness: 0.8,
        clearcoat: 1,
        clearcoatRoughness: 0.15,
        emissive: new THREE.Color(0x7a3cff),
        emissiveIntensity: 0.25
      });
      orbMesh = new THREE.Mesh(geo, mat);
      orbScene.add(orbMesh);

      // Floating particles around orb
      const pGeo = new THREE.BufferGeometry();
      const pCount = 400;
      const positions = new Float32Array(pCount * 3);
      for (let i=0;i<pCount;i++) {
        const r = 1.6 + Math.random() * 0.8;
        const theta = Math.random() * Math.PI * 2;
        const phi = Math.acos(2 * Math.random() - 1);
        positions[i*3] = r * Math.sin(phi) * Math.cos(theta);
        positions[i*3+1] = r * Math.sin(phi) * Math.sin(theta);
        positions[i*3+2] = r * Math.cos(phi);
      }
      pGeo.setAttribute('position', new THREE.BufferAttribute(positions, 3));
      const pMat = new THREE.PointsMaterial({ color: 0xffffff, size: 0.01, transparent: true, opacity: 0.5 });
      const points = new THREE.Points(pGeo, pMat);
      orbScene.add(points);

      orbClock = new THREE.Clock();

      function onResize() {
        const w = canvas.clientWidth, h = canvas.clientHeight;
        orbCamera.aspect = w/h;
        orbCamera.updateProjectionMatrix();
        orbRenderer.setSize(w, h);
      }
      window.addEventListener('resize', onResize);

      function animate() {
        const t = orbClock.getElapsedTime();
        orbMesh.rotation.y += 0.003;
        orbMesh.rotation.x = Math.sin(t/3) * 0.15;
        const hue = (t * 6) % 360;
        const col = new THREE.Color(`hsl(${hue}, 80%, 60%)`);
        // Blend hue with current mode primary to feel adaptive
        orbMesh.material.emissive.lerp(col, 0.04);
        orbMesh.material.color.lerp(col, 0.02);
        points.rotation.y -= 0.0015;
        orbRenderer.render(orbScene, orbCamera);
        requestAnimationFrame(animate);
      }
      animate();
    }
    initOrb();

    // Orb pulse when processing
    function pulseOrb() {
      if (!orbMesh) return;
      const base = orbMesh.scale.clone();
      gsap.fromTo(orbMesh.scale, { x: base.x, y: base.y, z: base.z }, { x: base.x*1.05, y: base.y*1.05, z: base.z*1.05, duration: .35, yoyo: true, repeat: 1, ease: 'power2.out' });
    }

    // Composer
    const composer = $('#composer');
    const sendBtn = $('#sendBtn');
    const micBtn = $('#micBtn');
    const output = $('#outputArea');

    // Quick chips
    $$('.quick-chip').forEach(chip => chip.addEventListener('click', () => composer.value = chip.dataset.chip || ''));

    // Drag & Drop
    const dropZone = $('#dropZone');
    dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('cmd-active'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('cmd-active'));
    dropZone.addEventListener('drop', e => {
      e.preventDefault();
      dropZone.classList.remove('cmd-active');
      const files = Array.from(e.dataTransfer.files || []);
      if (!files.length) return;
      files.slice(0,3).forEach(f => pushSystemCard(`📎 Received file: ${f.name} (${Math.round(f.size/1024)} KB). I'll process it shortly.`));
      pushSalmarMessage("I can parse these files, summarize content, and prepare outputs. Say 'run workflow' to chain actions.");
    });

    $('#attachBtn')?.addEventListener('click', () => $('#fileInput').click());
    $('#fileInput')?.addEventListener('change', (e) => {
      const files = Array.from(e.target.files || []);
      if (!files.length) return;
      files.slice(0,3).forEach(f => pushSystemCard(`📎 Attached file: ${f.name} (${Math.round(f.size/1024)} KB).`));
    });

    // Voice (Web Speech API)
    let recognition, recognizing = false;
    function initVoice() {
      try {
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SR) { micBtn?.setAttribute('disabled', 'true'); return; }
        recognition = new SR();
        recognition.lang = 'en-US';
        recognition.interimResults = true;
        recognition.continuous = false;
        recognition.onresult = (event) => {
          let interim = '';
          for (let i=event.resultIndex; i<event.results.length; i++) {
            const tr = event.results[i][0].transcript;
            if (event.results[i].isFinal) composer.value += ' ' + tr;
            else interim += tr;
          }
          micBtn.setAttribute('aria-label', 'Voice listening… ' + interim);
        };
        recognition.onend = () => {
          recognizing = false;
          micBtn.setAttribute('aria-pressed', 'false');
          micBtn.classList.remove('cmd-active');
          micBtn.setAttribute('aria-label', 'Voice command');
        };
      } catch (e) { console.warn('Voice init failed', e); }
    }
    initVoice();

    micBtn?.addEventListener('click', () => {
      if (!recognition) return alert('Voice recognition unavailable here.');
      if (recognizing) { recognition.stop(); return; }
      try {
        recognition.start();
        recognizing = true;
        micBtn.setAttribute('aria-pressed', 'true');
        micBtn.classList.add('cmd-active');
      } catch (e) {
        recognizing = false;
      }
    });

    // Send message
    sendBtn?.addEventListener('pointermove', e => {
      const r = e.currentTarget.getBoundingClientRect();
      e.currentTarget.style.setProperty('--x', `${e.clientX - r.left}px`);
      e.currentTarget.style.setProperty('--y', `${e.clientY - r.top}px`);
    });
    sendBtn?.addEventListener('click', async () => {
      const text = composer.value.trim();
      if (!text) return;
      pushUserMessage(text);
      composer.value = '';
      // Simulate sensitive task detection
      if (/(pay|payment|confidential|secret|vault)/i.test(text)) {
        await biometricPrompt();
      }
      await simulateResponse(text);
    });

    // Output helpers
    function createCard(contentEl, who='salmar') {
      const article = document.createElement('article');
      article.className = `bubble ${who} animate-fade-up`;
      const header = document.createElement('header');
      header.className = 'flex items-center gap-2 mb-1';
      const icon = document.createElement('i');
      icon.setAttribute('data-lucide', who === 'user' ? 'user' : 'sparkles');
      icon.className = 'w-4 h-4 text-[var(--accent)]';
      header.appendChild(icon);
      const h3 = document.createElement('h3');
      h3.className = 'font-semibold';
      h3.textContent = who === 'user' ? 'You' : 'Salmar';
      header.appendChild(h3);
      const body = document.createElement('div');
      body.appendChild(contentEl);
      article.appendChild(header);
      article.appendChild(body);
      output.appendChild(article);
      try { lucide.createIcons({ icons: { sparkles: lucide.icons['sparkles'], user: lucide.icons['user'] } }); } catch(e){}
      output.setAttribute('aria-busy', 'false');
      output.scrollTop = output.scrollHeight;
      state.lastExportHTML = output.innerHTML;
      addHistoryNode();
      return article;
    }
    function pushUserMessage(text) {
      const p = document.createElement('p');
      p.className = 'text-sm leading-relaxed';
      p.textContent = text;
      createCard(p, 'user');
      state.messages.push({ who: 'user', text, ts: Date.now() });
    }
    function pushSalmarMessage(text) {
      const p = document.createElement('p');
      p.className = 'text-sm leading-relaxed';
      p.textContent = text;
      createCard(p, 'salmar');
      state.messages.push({ who: 'salmar', text, ts: Date.now() });
    }
    function pushSystemCard(text) {
      const p = document.createElement('p');
      p.className = 'text-sm leading-relaxed';
      p.textContent = text;
      const article = createCard(p, 'salmar');
      article.style.borderColor = 'rgba(255,255,255,0.25)';
      return article;
    }

    // Simulated AI responses based on keywords
    async function simulateResponse(prompt) {
      output.setAttribute('aria-busy', 'true');
      pulseOrb();
      await new Promise(r => setTimeout(r, 450));
      const lower = prompt.toLowerCase();

      if (lower.includes('code') || lower.includes('function')) {
        const pre = document.createElement('pre');
        pre.className = 'language-js text-xs sm:text-sm';
        const code = document.createElement('code');
        code.textContent = `// Example function generated by Salmar
function greet(name) {
  return \`Hello, \${name}! The future is Salmar.\`;
}
console.log(greet('World'));`;
        pre.appendChild(code);

        // Copy button
        const wrap = document.createElement('div');
        wrap.className = 'relative';
        const copyBtn = document.createElement('button');
        copyBtn.className = 'absolute top-2 right-2 text-xs px-2 py-1 rounded glass hover-glow';
        copyBtn.textContent = 'Copy';
        copyBtn.addEventListener('click', async () => {
          try {
            await navigator.clipboard.writeText(code.textContent);
            copyBtn.textContent = 'Copied!';
            setTimeout(() => copyBtn.textContent = 'Copy', 1200);
          } catch(e) {}
        });
        wrap.appendChild(copyBtn);
        wrap.appendChild(pre);
        createCard(wrap, 'salmar');
        try { Prism.highlightElement(code); } catch(e) {}
        state.messages.push({ who:'salmar', text: '[code]', ts: Date.now() });
      } else if (lower.includes('chart') || lower.includes('stats') || lower.includes('table')) {
        const container = document.createElement('div');
        container.innerHTML = `
          <div class="text-sm mb-2 font-semibold">Here is a quick chart based on your query:</div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div class="glass p-2 rounded">
              <canvas class="w-full h-40" aria-label="Chart visualization"></canvas>
            </div>
            <div class="glass p-2 rounded overflow-auto">
              <table class="w-full text-xs">
                <thead><tr><th class="text-left p-1">Metric</th><th class="text-left p-1">Value</th></tr></thead>
                <tbody>
                  <tr><td class="p-1">Alpha</td><td class="p-1">42</td></tr>
                  <tr><td class="p-1">Beta</td><td class="p-1">37</td></tr>
                  <tr><td class="p-1">Gamma</td><td class="p-1">29</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        `;
        const article = createCard(container, 'salmar');
        const ctx = article.querySelector('canvas').getContext('2d');
        try {
          new Chart(ctx, {
            type: 'line',
            data: {
              labels: ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'],
              datasets: [{
                label: 'Performance',
                data: [12,19,9,17,22,18,25],
                borderColor: getComputedStyle(document.documentElement).getPropertyValue('--primary').trim(),
                backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() + '33',
                tension: 0.35
              }]
            },
            options: { plugins: { legend: { labels: { color: getComputedStyle(document.documentElement).getPropertyValue('--text').trim() } } },
                       scales: { x: { ticks:{ color: 'rgba(255,255,255,.6)' }, grid:{ color:'rgba(255,255,255,.08)'} },
                                 y: { ticks:{ color: 'rgba(255,255,255,.6)' }, grid:{ color:'rgba(255,255,255,.08)'} } } }
          });
        } catch(e) {}
        state.messages.push({ who:'salmar', text: '[chart]', ts: Date.now() });
      } else if (lower.includes('image') || lower.includes('design')) {
        const wrap = document.createElement('div');
        wrap.innerHTML = `
          <div class="text-sm mb-2 font-semibold">Concept preview:</div>
          <div class="grid grid-cols-2 gap-3">
            <img src="https://picsum.photos/seed/salmar1/400/280" alt="Generated concept image 1" class="rounded hover-glow cursor-zoom-in preview-img" />
            <img src="https://picsum.photos/seed/salmar2/400/280" alt="Generated concept image 2" class="rounded hover-glow cursor-zoom-in preview-img" />
          </div>
        `;
        const article = createCard(wrap, 'salmar');
        article.querySelectorAll('.preview-img').forEach(img => img.addEventListener('click', () => openLightbox(img.src)));
        state.messages.push({ who:'salmar', text: '[images]', ts: Date.now() });
      } else if (lower.includes('connect slack') || lower.includes('slack')) {
        pushSalmarMessage('Please click Connect on Slack under Integrations to authorize. I will post your updates once connected.');
      } else if (lower.includes('run workflow')) {
        pushSalmarMessage('Opening Workflow Builder. Add steps, then hit Run to execute.');
        openWorkflow();
      } else {
        // General text response with mode-based tone
        const personality = ['Professional', 'Friendly', 'Visionary', 'Technical'][state.personalityIndex || 0];
        const p = document.createElement('p');
        p.className = 'text-sm leading-relaxed';
        p.innerHTML = `<span class="text-[var(--muted)] text-xs">${personality} • ${state.mode.toUpperCase()}</span><br/>` +
                      `Here’s a structured plan for “${escapeHTML(prompt)}”:<br/>
                      1) Understand the goal • 2) Outline tasks • 3) Execute • 4) Validate • 5) Iterate.`;
        createCard(p, 'salmar');
        state.messages.push({ who:'salmar', text: '[text]', ts: Date.now() });
      }
    }

    function escapeHTML(s) { return s.replace(/[&<>'"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;',"'":'&#39;','"':'&quot;'}[c])); }

    // Lightbox
    function openLightbox(src) {
      const lb = $('#lightbox');
      $('#lightboxImg').src = src;
      lb.classList.remove('hidden');
      lb.classList.add('flex');
    }
    $('#lightboxClose')?.addEventListener('click', () => {
      const lb = $('#lightbox');
      lb.classList.add('hidden');
      lb.classList.remove('flex');
    });

    // History timeline
    function addHistoryNode() {
      if (state.incognito) return;
      const track = $('#timelineTrack');
      const node = document.createElement('button');
      node.className = 'relative flex-none w-2 h-2 rounded-full';
      node.style.background = 'linear-gradient(180deg, var(--primary), var(--accent))';
      node.title = dayjs().format('HH:mm:ss');
      node.addEventListener('click', () => {
        output.scrollIntoView({ behavior: 'smooth', block: 'end' });
      });
      // Decorated node with glow
      const wrap = document.createElement('div');
      wrap.className = 'flex flex-col items-center gap-2';
      const time = document.createElement('div');
      time.className = 'text-[10px] text-[var(--muted)]';
      time.textContent = dayjs().format('HH:mm');
      wrap.appendChild(node);
      wrap.appendChild(time);
      track.appendChild(wrap);
    }
    (function initTimelineDrag(){
      const track = $('#timeline');
      let isDown = false, startX, scrollLeft;
      track.addEventListener('mousedown', e => { isDown = true; track.classList.add('cmd-active'); startX = e.pageX - track.offsetLeft; scrollLeft = track.scrollLeft; });
      track.addEventListener('mouseleave', ()=>{ isDown = false; track.classList.remove('cmd-active'); });
      track.addEventListener('mouseup', ()=>{ isDown = false; track.classList.remove('cmd-active'); });
      track.addEventListener('mousemove', (e)=>{ if(!isDown) return; e.preventDefault(); const x = e.pageX - track.offsetLeft; const walk = (x - startX) * 1.5; track.scrollLeft = scrollLeft - walk; });
    })();
    $('#clearHistoryBtn')?.addEventListener('click', () => {
      $('#timelineTrack').innerHTML = '';
      announce('History cleared.');
    });

    // Settings modal rendering
    const settingsModal = $('#settingsModal');
    $('#openSettingsBtn')?.addEventListener('click', openSettings);
    function openSettings() {
      renderSettingsTab('general');
      settingsModal.classList.remove('hidden');
      settingsModal.classList.add('flex');
    }
    $('#closeSettingsBtn')?.addEventListener('click', closeSettings);
    function closeSettings() {
      settingsModal.classList.add('hidden');
      settingsModal.classList.remove('flex');
    }
    $$('.settings-tab').forEach(btn => btn.addEventListener('click', () => renderSettingsTab(btn.dataset.tab)));
    $('#saveSettingsBtn')?.addEventListener('click', () => {
      closeSettings(); announce('Settings saved.');
    });

    function renderSettingsTab(tab) {
      const c = $('#settingsContent'); c.innerHTML = '';
      $$('.settings-tab').forEach(b => b.classList.toggle('cmd-active', b.dataset.tab === tab));
      if (tab === 'general') {
        c.innerHTML = `
          <div>
            <h3 class="font-semibold mb-2">General</h3>
            <div class="grid sm:grid-cols-2 gap-3">
              <label class="flex items-center justify-between glass p-3 rounded">
                <span class="text-sm">Default Mode</span>
                <select id="setting-default-mode" class="bg-black/10 border border-white/10 rounded p-1.5 text-sm">
                  <option value="smart" selected>Smart</option>
                  <option value="deep">Deep Dive</option>
                  <option value="creative">Creative</option>
                  <option value="action">Action</option>
                </select>
              </label>
              <label class="flex items-center justify-between glass p-3 rounded">
                <span class="text-sm">Memory Default</span>
                <select id="setting-memory" class="bg-black/10 border border-white/10 rounded p-1.5 text-sm">
                  <option value="on" selected>On</option><option value="off">Off</option>
                </select>
              </label>
            </div>
          </div>
        `;
      } else if (tab === 'appearance') {
        c.innerHTML = `
          <div class="space-y-3">
            <h3 class="font-semibold">Appearance</h3>
            <div class="grid sm:grid-cols-3 gap-3">
              <button class="p-3 rounded glass hover-glow theme-choice" data-theme="dark">
                <div class="w-full h-20 rounded bg-gradient-to-br from-[#1b1036] to-[#3a1991] mb-2"></div>
                <div class="text-xs">Dark (Nebula)</div>
              </button>
              <button class="p-3 rounded glass hover-glow theme-choice" data-theme="light">
                <div class="w-full h-20 rounded bg-gradient-to-br from-[#fafaff] to-[#efeaff] mb-2"></div>
                <div class="text-xs">Light (Iris)</div>
              </button>
              <button class="p-3 rounded glass hover-glow" id="toggleHighContrast">
                <div class="w-full h-20 rounded bg-gradient-to-br from-white/30 to-white/10 mb-2 border border-white/20"></div>
                <div class="text-xs">High Contrast</div>
              </button>
            </div>
          </div>
        `;
        c.querySelectorAll('.theme-choice').forEach(b => b.addEventListener('click', () => {
          state.theme = b.dataset.theme; document.documentElement.setAttribute('data-theme', state.theme); updateThemeIcon();
        }));
        c.querySelector('#toggleHighContrast').addEventListener('click', () => {
          state.highContrast = !state.highContrast;
          document.documentElement.classList.toggle('high-contrast', state.highContrast);
        });
      } else if (tab === 'voice') {
        c.innerHTML = `
          <div class="space-y-3">
            <h3 class="font-semibold">Voice & Accessibility</h3>
            <div class="grid sm:grid-cols-2 gap-3">
              <label class="flex items-center justify-between glass p-3 rounded">
                <span class="text-sm">Voice Input Default</span>
                <button id="setting-voice" class="px-3 py-1.5 rounded glass">${state.voiceEnabled ? 'ON' : 'OFF'}</button>
              </label>
              <label class="flex items-center justify-between glass p-3 rounded">
                <span class="text-sm">Reduced Motion</span>
                <button id="setting-motion" class="px-3 py-1.5 rounded glass">${state.reducedMotion ? 'ON' : 'OFF'}</button>
              </label>
            </div>
            <div class="text-xs text-[var(--muted)]">Keyboard: Tab/Shift+Tab to navigate, Enter/Space to activate. Command Palette: Ctrl/⌘ + K.</div>
          </div>
        `;
        c.querySelector('#setting-voice').addEventListener('click', (e) => {
          state.voiceEnabled = !state.voiceEnabled; e.currentTarget.textContent = state.voiceEnabled ? 'ON' : 'OFF';
        });
        c.querySelector('#setting-motion').addEventListener('click', (e) => {
          state.reducedMotion = !state.reducedMotion; e.currentTarget.textContent = state.reducedMotion ? 'ON' : 'OFF';
          document.documentElement.classList.toggle('reduced-motion', state.reducedMotion);
        });
      } else if (tab === 'security') {
        c.innerHTML = `
          <div class="space-y-3">
            <h3 class="font-semibold">Security & Privacy</h3>
            <div class="grid gap-3">
              <label class="flex items-center justify-between glass p-3 rounded">
                <span class="text-sm">Biometric Enforcement</span>
                <button id="setting-bio" class="px-3 py-1.5 rounded glass">${state.biometricActive ? 'ON' : 'OFF'}</button>
              </label>
              <label class="flex items-center justify-between glass p-3 rounded">
                <span class="text-sm">Safe Mode (PII Redaction)</span>
                <button id="setting-safe" class="px-3 py-1.5 rounded glass">${state.safeMode ? 'ON' : 'OFF'}</button>
              </label>
              <label class="flex items-center justify-between glass p-3 rounded">
                <span class="text-sm">Incognito (No history)</span>
                <button id="setting-incog" class="px-3 py-1.5 rounded glass">${state.incognito ? 'ON' : 'OFF'}</button>
              </label>
            </div>
            <div class="text-xs text-[var(--muted)]">WebAuthn available: ${isWebAuthnAvailable() ? 'Yes' : 'No'} (simulated here).</div>
          </div>
        `;
        c.querySelector('#setting-bio').addEventListener('click', (e) => { state.biometricActive = !state.biometricActive; e.currentTarget.textContent = state.biometricActive ? 'ON' : 'OFF'; document.getElementById('biometricDot').classList.toggle('bg-emerald-500', state.biometricActive); document.getElementById('biometricDot').classList.toggle('bg-gray-400', !state.biometricActive); });
        c.querySelector('#setting-safe').addEventListener('click', (e) => { state.safeMode = !state.safeMode; e.currentTarget.textContent = state.safeMode ? 'ON' : 'OFF'; });
        c.querySelector('#setting-incog').addEventListener('click', (e) => { state.incognito = !state.incognito; e.currentTarget.textContent = state.incognito ? 'ON' : 'OFF'; document.getElementById('incognitoBadge').textContent = state.incognito ? 'ON' : 'OFF'; });
      } else if (tab === 'integrations') {
        c.innerHTML = `
          <div class="space-y-3">
            <h3 class="font-semibold">Integrations</h3>
            <div class="grid sm:grid-cols-2 gap-3">
              ${['Slack','Google Drive','Discord','Notion','GitHub','Custom API'].map(name => `
                <div class="glass p-3 rounded space-y-2">
                  <div class="flex items-center justify-between"><div>${name}</div><button class="px-2 py-1 text-xs rounded connect-btn" data-integration="${name}">${state.integrations[name] ? 'Connected' : 'Connect'}</button></div>
                  <input placeholder="API Token" class="bg-black/10 border border-white/10 rounded p-2 text-xs w-full" />
                </div>
              `).join('')}
            </div>
          </div>
        `;
        c.querySelectorAll('.connect-btn').forEach(btn => btn.addEventListener('click', () => { const k = btn.dataset.integration; state.integrations[k] = !state.integrations[k]; btn.textContent = state.integrations[k] ? 'Connected' : 'Connect'; }));
      } else if (tab === 'shortcuts') {
        c.innerHTML = `
          <div class="space-y-3">
            <h3 class="font-semibold">Shortcuts</h3>
            <ul class="text-sm space-y-1">
              <li><kbd>Ctrl/⌘</kbd> + <kbd>K</kbd> — Command palette</li>
              <li><kbd>Enter</kbd> — Send message</li>
              <li><kbd>/</kbd> — Focus composer</li>
              <li><kbd>Esc</kbd> — Close modals</li>
            </ul>
          </div>
        `;
      } else if (tab === 'about') {
        c.innerHTML = `
          <div class="space-y-2">
            <h3 class="font-semibold">About Salmar</h3>
            <p class="text-sm text-[var(--muted)]">Salmar blends cutting-edge interaction, adaptive aesthetics, privacy-first controls, and seamless integrations to help you do everything.</p>
            <p class="text-xs text-[var(--muted)]">Version: 1.0 • Build: Demo</p>
          </div>
        `;
      }
    }

    // Personality
    const personality = $('#personality');
    const personalityLabel = $('#personalityLabel');
    const personalityNames = ['Professional','Friendly','Visionary','Technical'];
    personality?.addEventListener('input', e => {
      state.personalityIndex = parseInt(e.target.value, 10);
      personalityLabel.textContent = personalityNames[state.personalityIndex];
    });

    // Memory & Safe Mode toggles
    const memoryToggle = $('#memoryToggle');
    const memoryToggle2 = $('#memoryToggle2');
    function syncMemoryButtons() {
      memoryToggle.textContent = state.memory ? 'ON' : 'OFF';
      memoryToggle.setAttribute('aria-checked', String(state.memory));
      memoryToggle2.textContent = state.memory ? 'ON' : 'OFF';
    }
    memoryToggle?.addEventListener('click', () => { state.memory = !state.memory; syncMemoryButtons(); });
    memoryToggle2?.addEventListener('click', () => { state.memory = !state.memory; syncMemoryButtons(); });
    syncMemoryButtons();
    $('#safeModeToggle')?.addEventListener('click', e => { state.safeMode = !state.safeMode; e.currentTarget.textContent = state.safeMode ? 'ON' : 'OFF'; });

    // Biometrics prompt on sensitive actions
    async function biometricPrompt() {
      if (!state.biometricActive) return true;
      if (!isWebAuthnAvailable()) {
        pushSystemCard('Biometric prompt simulated (WebAuthn unavailable). Proceeding with caution.');
        return true;
      }
      pushSystemCard('Biometric re-auth required for this sensitive action. Please confirm via your device.');
      // Simulate wait
      await new Promise(r => setTimeout(r, 800));
      pushSystemCard('Biometric verified. Continuing securely.');
      return true;
    }

    // Export functions
    function getExportText() {
      const texts = state.messages.filter(m => !m.hidden).map(m => {
        const who = m.who === 'user' ? 'You' : 'Salmar';
        const time = dayjs(m.ts).format('YYYY-MM-DD HH:mm');
        const line = typeof m.text === 'string' ? m.text : '';
        return `[${time}] ${who}: ${line}`;
      }).join('\n');
      return state.safeMode ? redactPII(texts) : texts;
    }
    function redactPII(text) {
      return text.replace(/[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}/g, '[redacted-email]')
                 .replace(/\b\d{3}[-.\s]?\d{2}[-.\s]?\d{4}\b/g, '[redacted-ssn]')
                 .replace(/\b(?:\d[ -]*?){13,16}\b/g, '[redacted-card]');
    }
    $('#exportPDF')?.addEventListener('click', () => {
      const opt = {
        margin: 10,
        filename: `salmar_${Date.now()}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 1.4, backgroundColor: null },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
      };
      const clone = output.cloneNode(true);
      if (state.safeMode) clone.textContent = redactPII(clone.textContent || '');
      html2pdf().from(clone).set(opt).save();
    });
    $('#exportDOCX')?.addEventListener('click', async () => {
      try {
        const { Document, Packer, Paragraph } = window.docx;
        const doc = new Document({ sections: [{ children: getExportText().split('\n').map(line => new Paragraph(line)) }] });
        const blob = await Packer.toBlob(doc);
        saveAs(blob, `salmar_${Date.now()}.docx`);
      } catch (e) { alert('DOCX export failed.'); }
    });
    $('#exportTXT')?.addEventListener('click', () => {
      const blob = new Blob([getExportText()], { type: 'text/plain;charset=utf-8' });
      saveAs(blob, `salmar_${Date.now()}.txt`);
    });
    $('#shareBtn')?.addEventListener('click', async () => {
      const text = getExportText().slice(0, 2000);
      try {
        if (navigator.share) {
          await navigator.share({ title: 'Salmar Output', text });
        } else {
          await navigator.clipboard.writeText(text);
          alert('Copied to clipboard.');
        }
      } catch (e) {}
    });

    // Command Palette
    const cmd = $('#cmdPalette');
    const cmdInput = $('#cmdInput');
    const cmdResults = $('#cmdResults');
    const cmdBtn = $('#cmdBtn');
    const commands = [
      { id: 'open-settings', label: 'Open Settings', action: openSettings },
      { id: 'toggle-theme', label: 'Toggle Theme', action: ()=>themeToggle.click() },
      { id: 'new-chat', label: 'New Chat', action: ()=>{ output.innerHTML=''; state.messages=[]; pushSalmarMessage('New session started.'); } },
      { id: 'switch-smart', label: 'Switch Mode: Smart', action: ()=>setMode('smart') },
      { id: 'switch-deep', label: 'Switch Mode: Deep Dive', action: ()=>setMode('deep') },
      { id: 'switch-creative', label: 'Switch Mode: Creative', action: ()=>setMode('creative') },
      { id: 'switch-action', label: 'Switch Mode: Action', action: ()=>setMode('action') },
      { id: 'invite', label: 'Invite Teammates', action: ()=>openInvite() },
      { id: 'workflow', label: 'Open Workflow Builder', action: ()=>openWorkflow() },
      { id: 'export-pdf', label: 'Export as PDF', action: ()=>$('#exportPDF').click() },
      { id: 'focus-composer', label: 'Focus Composer', action: ()=>composer.focus() },
      { id: 'connect-slack', label: 'Connect: Slack', action: ()=>alert('Open Integrations > Slack to connect (demo).') }
    ];
    function openCmd() {
      cmd.classList.remove('hidden'); cmd.classList.add('flex'); cmdInput.value = ''; renderCmdResults('');
      cmdInput.focus();
    }
    function closeCmd() { cmd.classList.add('hidden'); cmd.classList.remove('flex'); }
    function renderCmdResults(q) {
      cmdResults.innerHTML = '';
      commands.filter(c => c.label.toLowerCase().includes(q.toLowerCase())).slice(0,10).forEach(c => {
        const li = document.createElement('li');
        li.className = 'p-3 hover:bg-white/5 cursor-pointer';
        li.textContent = c.label;
        li.addEventListener('click', () => { c.action(); closeCmd(); });
        cmdResults.appendChild(li);
      });
    }
    cmdBtn?.addEventListener('click', openCmd);
    cmdInput?.addEventListener('input', e => renderCmdResults(e.target.value));
    document.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'k') { e.preventDefault(); openCmd(); }
      if (e.key === 'Escape') {
        if (!settingsModal.classList.contains('hidden')) closeSettings();
        if (!cmd.classList.contains('hidden')) closeCmd();
        const lb = $('#lightbox'); if (!lb.classList.contains('hidden')) $('#lightboxClose').click();
        const im = $('#inviteModal'); if (!im.classList.contains('hidden')) $('#inviteClose').click();
        const wf = $('#workflowModal'); if (!wf.classList.contains('hidden')) $('#workflowClose').click();
      }
      if (e.key === '/' && document.activeElement !== composer) { e.preventDefault(); composer.focus(); }
      if (e.key === 'Enter' && document.activeElement === composer) { e.preventDefault(); sendBtn.click(); }
    });

    // Invite
    const inviteModal = $('#inviteModal');
    function openInvite(){ inviteModal.classList.remove('hidden'); inviteModal.classList.add('flex'); }
    $('#inviteBtn')?.addEventListener('click', openInvite);
    $('#collabInviteBtn')?.addEventListener('click', openInvite);
    $('#inviteClose')?.addEventListener('click', ()=>{ inviteModal.classList.add('hidden'); inviteModal.classList.remove('flex'); });
    $('#inviteSend')?.addEventListener('click', ()=>{ alert('Invites sent (demo).'); inviteModal.classList.add('hidden'); inviteModal.classList.remove('flex'); });

    // Integrations connect buttons (inline)
    $$('.connect-btn').forEach(btn => btn.addEventListener('click', () => {
      const name = btn.dataset.integration;
      state.integrations[name] = !state.integrations[name];
      btn.textContent = state.integrations[name] ? 'Connected' : 'Connect';
      pushSystemCard(`${state.integrations[name] ? '✅ Connected to' : 'Disconnected from'} ${name}.`);
    }));

    // Workflow Builder
    const wfModal = $('#workflowModal');
    function openWorkflow(){ wfModal.classList.remove('hidden'); wfModal.classList.add('flex'); }
    $('#openWorkflow')?.addEventListener('click', openWorkflow);
    $('#workflowClose')?.addEventListener('click', ()=>{ wfModal.classList.add('hidden'); wfModal.classList.remove('flex'); });
    $('#addStep')?.addEventListener('click', addWorkflowStep);
    function addWorkflowStep() {
      const tpl = document.getElementById('workflowStepTpl');
      const node = tpl.content.firstElementChild.cloneNode(true);
      node.querySelector('.remove-step').addEventListener('click', () => { node.remove(); updateStepIndices(); });
      $('#workflowSteps').appendChild(node);
      updateStepIndices();
    }
    function updateStepIndices() {
      $$('#workflowSteps .step-index').forEach((el, i) => el.textContent = i+1);
    }
    $('#runWorkflow')?.addEventListener('click', () => {
      pushSystemCard('Running workflow…');
      setTimeout(()=>pushSalmarMessage('Workflow completed successfully. Outputs ready to export or share.'), 900);
      wfModal.classList.add('hidden'); wfModal.classList.remove('flex');
    });
    // Seed with two steps
    addWorkflowStep(); addWorkflowStep();

    // Collapsible tools
    $('#collapseTools')?.addEventListener('click', () => {
      const list = $('#toolsList'); const isOpen = !list.classList.contains('hidden');
      list.classList.toggle('hidden', isOpen);
      $('#collapseTools i').setAttribute('data-lucide', isOpen ? 'chevron-down' : 'chevron-up');
      try { lucide.createIcons(); } catch(e){}
    });

    // Buttons ripple hover coords
    document.body.addEventListener('pointermove', (e) => {
      if (!e.target.classList?.contains('btn')) return;
      const r = e.target.getBoundingClientRect();
      e.target.style.setProperty('--x', `${e.clientX - r.left}px`);
      e.target.style.setProperty('--y', `${e.clientY - r.top}px`);
    });

    // Initial announcements
    setMode('smart');
    pushSystemCard('All systems nominal. Nebula theme active. Voice, command palette, exports, and integrations are ready.');

  </script>
</body>
</html>